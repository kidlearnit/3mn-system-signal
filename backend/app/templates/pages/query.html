{% extends "layouts/base.html" %}

{% block content %}
<div class="max-w mx-auto p-2">
  <h4 class="text-2xl font-bold mb-6 flex items-center gap-2">
    üìä Stock Query
  </h4>

  <!-- Search form with JavaScript -->
  <div class="flex items-center gap-2 mb-4">
    <input type="text" id="symbolInput" placeholder="Enter stock symbol..." value="{{ symbol|e if symbol else '' }}"
      pattern="[A-Za-z]{1,10}" maxlength="10"
      class="border rounded-md px-2 py-1.5 w-48 text-sm focus:ring focus:ring-blue-300" />
    <button id="searchBtn" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition">
      üîç Search
    </button>
  </div>

  <div class="flex justify-between gap-1 mb-4">
    <!-- Alphabet filter -->
    <div class="flex flex-wrap gap-1 mb-1">
      {% for c in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
      <a href="{{ url_for('dashboard.query_page', prefix=c) }}"
        class="px-2 py-1 border rounded-md text-xs hover:bg-gray-100 {{ 'bg-blue-600 text-white' if prefix == c else '' }}">
        {{ c }}
      </a>
      {% endfor %}
    </div>
    <!-- Pagination (top) -->
    <div class="flex justify-center items-center gap-1 mb-1 text-sm">
      {% if page > 1 %}
      <a href="{{ url_for('dashboard.query_page', symbol=symbol, prefix=prefix, page=page-1) }}"
        class="px-2 py-1 border rounded-md hover:bg-gray-100">‚¨Ö</a>
      {% endif %}
      {% for p in range(1, total_pages+1) %}
      {% if p == page %}
      <span class="px-2 py-1 rounded-md bg-blue-600 text-white">{{ p }}</span>
      {% elif p <= 3 or p> total_pages-2 or (p >= page-1 and p <= page+1) %} <a
          href="{{ url_for('dashboard.query_page', symbol=symbol, prefix=prefix, page=p) }}"
          class="px-2 py-1 border rounded-md hover:bg-gray-100">{{ p }}</a>
          {% elif p == 4 and page > 5 %}
          <span class="px-2">...</span>
          {% elif p == total_pages-3 and page < total_pages-4 %} <span class="px-2">...</span>
            {% endif %}
            {% endfor %}
            {% if page < total_pages %} <a
              href="{{ url_for('dashboard.query_page', symbol=symbol, prefix=prefix, page=page+1) }}"
              class="px-2 py-1 border rounded-md hover:bg-gray-100">‚û°</a>
              {% endif %}
    </div>
  </div>

  <!-- Loading indicator -->
  <div id="loading" class="hidden text-center py-4">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
    <p class="text-gray-600 mt-2">Loading data...</p>
  </div>

  <!-- Results container -->
  <div id="resultsContainer">
    {% if rows %}
    <div class="bg-white shadow rounded-lg p-4">
      <div class="flex justify-between items-center mb-3">
        <div class="text-gray-700 text-sm">
          Results for {% if symbol %}
          <span class="font-semibold">{{ symbol }}</span>
          {% elif prefix %} prefix <span class="font-semibold">{{ prefix }}</span>
          {% endif %}
        </div>
      </div>

      <!-- Table -->
      <div class="overflow-y-auto h-[calc(100vh-200px)] border rounded-md">
        <table class="w-full border-collapse text-sm">
          <thead class="bg-gray-100 sticky top-0 z-10">
            <tr class="text-left">
              <th class="px-3 py-2 border">Symbol</th>
              <th class="px-3 py-2 border">Timestamp</th>
              <th class="px-3 py-2 border">Open</th>
              <th class="px-3 py-2 border">Close</th>
              <th class="px-3 py-2 border">Volume</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            {% set open_price = r[2] %}
            {% set close_price = r[3] %}
            {% set change = close_price - open_price %}
            <tr class="{{ 'bg-green-50' if change > 0 else 'bg-red-50' if change < 0 else '' }}">
              <td class="px-3 py-2 border font-medium">{{ r[0] }}</td>
              <td class="px-3 py-2 border">{{ r[1] }}</td>
              <td class="px-3 py-2 border text-right">
                {{ "%.2f"|format(open_price) }}
              </td>
              <td
                class="px-3 py-2 border text-right {{ 'text-green-600' if change > 0 else 'text-red-600' if change < 0 else '' }}">
                {{ "%.2f"|format(close_price) }}
              </td>
              <td class="px-3 py-2 border text-right">
                {{ "{:,}".format(r[4]) }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <!-- Pagination (bottom) -->
      <div class="flex justify-center items-center gap-1 mt-3 text-sm">
        {% if page > 1 %}
        <a href="{{ url_for('dashboard.query_page', symbol=symbol, prefix=prefix, page=page-1) }}"
          class="px-2 py-1 border rounded-md hover:bg-gray-100">‚¨Ö</a>
        {% endif %}
        {% for p in range(1, total_pages+1) %}
        {% if p == page %}
        <span class="px-2 py-1 rounded-md bg-blue-600 text-white">{{ p }}</span>
        {% elif p <= 3 or p> total_pages-2 or (p >= page-1 and p <= page+1) %} <a
            href="{{ url_for('dashboard.query_page', symbol=symbol, prefix=prefix, page=p) }}"
            class="px-2 py-1 border rounded-md hover:bg-gray-100">{{ p }}</a>
            {% elif p == 4 and page > 5 %}
            <span class="px-2">...</span>
            {% elif p == total_pages-3 and page < total_pages-4 %} <span class="px-2">...</span>
              {% endif %}
              {% endfor %}
              {% if page < total_pages %} <a
                href="{{ url_for('dashboard.query_page', symbol=symbol, prefix=prefix, page=page+1) }}"
                class="px-2 py-1 border rounded-md hover:bg-gray-100">‚û°</a>
                {% endif %}
      </div>
    </div>
    {% elif error %}
    <div class="bg-red-100 text-red-700 px-4 py-3 rounded-lg border border-red-300">
      {{ error }}
    </div>
    {% else %}
    <div class="text-center text-gray-500 bg-white shadow rounded-lg p-6 border">
      üö´ No results found {% if symbol %} for <b>{{ symbol|e }}</b>{% endif %}
      {% if prefix %} starting with <b>{{ prefix|e }}</b>{% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- JavaScript for AJAX query -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const symbolInput = document.getElementById('symbolInput');
    const searchBtn = document.getElementById('searchBtn');
    const loading = document.getElementById('loading');
    const resultsContainer = document.getElementById('resultsContainer');

    // Enter key to search
    symbolInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        searchBtn.click();
      }
    });

    // Search button click
    searchBtn.addEventListener('click', function () {
      const symbol = symbolInput.value.trim().toUpperCase();

      if (!symbol) {
        alert('Please enter a stock symbol');
        return;
      }

      // Validate symbol format
      if (!/^[A-Z]{1,10}$/.test(symbol)) {
        alert('Please enter a valid stock symbol (1-10 letters)');
        return;
      }

      fetchStockData(symbol);
    });

    function fetchStockData(symbol) {
      // Show loading
      loading.classList.remove('hidden');
      resultsContainer.classList.add('hidden');

      // Make AJAX request to API endpoint
      fetch(`/api/query?symbol=${encodeURIComponent(symbol)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          displayResults(data, symbol);
        })
        .catch(error => {
          showError('Error fetching data: ' + error.message);
        })
        .finally(() => {
          loading.classList.add('hidden');
          resultsContainer.classList.remove('hidden');
        });
    }

    function displayResults(data, symbol) {
      if (data.error) {
        showError(data.error);
        return;
      }

      if (!data.rows || data.rows.length === 0) {
        resultsContainer.innerHTML = `
        <div class="text-center text-gray-500 bg-white shadow rounded-lg p-6 border">
          üö´ No results found for <b>${symbol}</b>
        </div>
      `;
        return;
      }

      // Build table HTML
      let tableHtml = `
      <div class="bg-white shadow rounded-lg p-4">
        <div class="flex justify-between items-center mb-3">
          <div class="text-gray-700 text-sm">
            Results for <span class="font-semibold">${symbol}</span>
          </div>
          <div class="text-xs text-gray-500">
            ${data.rows.length} records found
          </div>
        </div>

        <div class="overflow-y-auto h-[calc(100vh-200px)] border rounded-md">
          <table class="w-full border-collapse text-sm">
            <thead class="bg-gray-100 sticky top-0 z-10">
              <tr class="text-left">
                <th class="px-3 py-2 border">Symbol</th>
                <th class="px-3 py-2 border">Timestamp</th>
                <th class="px-3 py-2 border">Open</th>
                <th class="px-3 py-2 border">Close</th>
                <th class="px-3 py-2 border">Volume</th>
              </tr>
            </thead>
            <tbody>
    `;

      data.rows.forEach(row => {
        const change = row.close - row.open;
        const rowClass = change > 0 ? 'bg-green-50' : change < 0 ? 'bg-red-50' : '';
        const textClass = change > 0 ? 'text-green-600' : change < 0 ? 'text-red-600' : '';

        tableHtml += `
        <tr class="${rowClass}">
          <td class="px-3 py-2 border font-medium">${row.symbol}</td>
          <td class="px-3 py-2 border">${new Date(row.timestamp).toLocaleString()}</td>
          <td class="px-3 py-2 border text-right">${row.open.toFixed(2)}</td>
          <td class="px-3 py-2 border text-right ${textClass}">${row.close.toFixed(2)}</td>
          <td class="px-3 py-2 border text-right">${row.volume.toLocaleString()}</td>
        </tr>
      `;
      });

      tableHtml += `
            </tbody>
          </table>
        </div>
      </div>
    `;

      resultsContainer.innerHTML = tableHtml;
    }

    function showError(message) {
      resultsContainer.innerHTML = `
      <div class="bg-red-100 text-red-700 px-4 py-3 rounded-lg border border-red-300">
        ${message}
      </div>
    `;
    }

    // Add keyboard shortcut
    document.addEventListener('keydown', function (e) {
      // Ctrl/Cmd + K to focus search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        symbolInput.focus();
      }
    });
  });
</script>

<style>
  .hidden {
    display: none;
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }

    to {
      transform: rotate(360deg);
    }
  }

  #resultsContainer {
    transition: opacity 0.3s ease;
  }
</style>
{% endblock %}