{% extends "layouts/base.html" %}

{% block title %}Advanced Workflow Builder - Trading Signals{% endblock %}

{% block page_title %}Advanced Workflow Builder{% endblock %}

{% block extra_head %}
<style>
    .workflow-canvas {
        background-image:
            radial-gradient(circle, #e5e7eb 1px, transparent 1px);
        background-size: 20px 20px;
        min-height: calc(100vh - 200px);
        height: calc(100vh - 200px);
        position: relative;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        background-color: #fafafa;
    }

    .node {
        position: absolute;
        min-width: 220px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        cursor: move;
        user-select: none;
        z-index: 10;
        transition: all 0.2s ease;
    }

    .node:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .node.selected {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2), 0 6px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .node-header {
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
        font-weight: 600;
        font-size: 14px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 10px 10px 0 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .node-body {
        padding: 16px;
        background: white;
    }

    .node-status {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }

    .connection-point {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid #3b82f6;
        background: white;
        position: absolute;
        cursor: pointer;
        z-index: 20;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .connection-point:hover {
        transform: scale(1.2);
        border-color: #10b981;
        background: #f0fdf4;
    }

    .connection-point.input {
        left: -8px;
        top: 50%;
        transform: translateY(-50%);
    }

    .connection-point.output {
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
    }

    .connection-point.input:hover {
        transform: translateY(-50%) scale(1.2);
    }

    .connection-point.output:hover {
        transform: translateY(-50%) scale(1.2);
    }

    .node-type-symbol {
        border-left: 4px solid #10b981;
    }

    .node-type-strategy {
        border-left: 4px solid #3b82f6;
    }

    .node-type-aggregation {
        border-left: 4px solid #8b5cf6;
    }

    .node-type-output {
        border-left: 4px solid #ef4444;
    }

    /* compact-palette removed */

    /* palette-header removed */

    /* palette-search removed */

    /* palette-search input removed */

    /* palette-resize-handle removed */

    /* palette-grid removed */

    /* palette-item removed */

    /* palette-item hover removed */

    .palette-item:last-child {
        border-bottom: none;
    }

    /* Inspector panel */
    #inspectorPanel {
        position: fixed;
        right: calc(20px + var(--palette-width, 200px) + 12px);
        bottom: 20px;
        width: 280px;
        max-height: 60vh;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        z-index: 9997;
        display: none;
        overflow: hidden;
    }

    #inspectorPanel.active {
        display: block;
    }

    #inspectorPanel .hdr {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
        font-weight: 600;
        font-size: 13px;
    }

    #inspectorPanel .body {
        padding: 12px;
        overflow: auto;
        max-height: calc(60vh - 44px);
        font-size: 12px;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal {
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        max-width: 500px;
        width: 90%;
        transform: scale(0.9);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }

    .modal-overlay.active .modal {
        transform: scale(1);
    }

    .modal-header {
        padding: 20px 24px 16px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .modal-close:hover {
        background: #f3f4f6;
        color: #374151;
    }

    .modal-body {
        padding: 24px;
        overflow: auto;
    }

    .modal-footer {
        padding: 16px 24px 20px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        position: sticky;
        bottom: 0;
        background: white;
    }

    /* Workflow List Styles */
    .workflow-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .workflow-item {
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
    }

    .workflow-item:hover {
        border-color: #3b82f6;
        background: #f8fafc;
        transform: translateY(-1px);
    }

    .workflow-item.selected {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    /* Actions dropdown */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-menu {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 6px;
        min-width: 220px;
        max-height: 60vh;
        overflow: auto;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        display: none;
    }

    .dropdown-menu.active {
        display: block;
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        font-size: 12px;
        cursor: pointer;
    }

    .dropdown-item:hover {
        background: #f3f4f6;
    }

    /* Hide global menus when viewing Workflow Builder */
    body[data-hide-menu="1"] header,
    body[data-hide-menu="1"] nav,
    body[data-hide-menu="1"] .sidebar,
    body[data-hide-menu="1"] .app-sidebar,
    body[data-hide-menu="1"] .top-nav,
    body[data-hide-menu="1"] .main-menu {
        display: none !important;
    }

    body[data-hide-menu="1"] .content,
    body[data-hide-menu="1"] main,
    body[data-hide-menu="1"] #app {
        margin: 0 !important;
        padding: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
    }

    .workflow-name {
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
    }

    .workflow-description {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 8px;
    }

    .workflow-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: #9ca3af;
    }

    .workflow-stats {
        display: flex;
        gap: 12px;
    }

    .workflow-stat {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* Notification System */
    .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .notification {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 16px 20px;
        min-width: 300px;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 12px;
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s ease;
    }

    .notification.show {
        transform: translateX(0);
        opacity: 1;
    }

    .notification.success {
        border-left: 4px solid #10b981;
    }

    .notification.error {
        border-left: 4px solid #ef4444;
    }

    .notification.warning {
        border-left: 4px solid #f59e0b;
    }

    .notification.info {
        border-left: 4px solid #3b82f6;
    }

    .notification-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
    }

    .notification.success .notification-icon {
        background: #10b981;
    }

    .notification.error .notification-icon {
        background: #ef4444;
    }

    .notification.warning .notification-icon {
        background: #f59e0b;
    }

    .notification.info .notification-icon {
        background: #3b82f6;
    }

    .notification-content {
        flex: 1;
    }

    .notification-title {
        font-weight: 600;
        color: #111827;
        margin-bottom: 2px;
    }

    .notification-message {
        color: #6b7280;
        font-size: 14px;
    }

    .notification-close {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .notification-close:hover {
        background: #f3f4f6;
        color: #374151;
    }

    /* Toggle Menu */
    .menu-toggle {
        position: fixed;
        left: 20px;
        top: 20px;
        z-index: 1001;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
    }

    .menu-toggle:hover {
        background: #f3f4f6;
        border-color: #3b82f6;
    }

    .compact-palette.hidden {
        transform: translateY(-50%) translateX(100%);
    }

    .palette-item .node-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 4px;
    }

    .property-panel {
        position: fixed;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        width: 320px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-height: 80vh;
        overflow-y: auto;
    }

    .property-panel.hidden {
        display: none;
    }

    .property-header {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
        border-radius: 8px 8px 0 0;
    }

    .property-content {
        padding: 16px;
    }

    .status-bar {
        background: #f8fafc;
        border-top: 1px solid #e5e7eb;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        border-radius: 8px;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
    }

    .connection-line {
        position: absolute;
        pointer-events: none;
        z-index: 5;
    }

    .dragging {
        opacity: 0.5;
    }

    /* Zoom and Pan Controls */
    .canvas-controls {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 100;
    }

    .control-button {
        width: 40px;
        height: 40px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
    }

    .control-button:hover {
        background: #f3f4f6;
        border-color: #3b82f6;
        transform: translateY(-1px);
    }

    /* Canvas zoom states */
    .workflow-canvas.zoomed {
        cursor: grab;
    }

    .workflow-canvas.zoomed:active {
        cursor: grabbing;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex justify-between items-center mb-4">
    <div>
        <h1 class="text-xl font-bold text-gray-900"><span id="pageTitle">Advanced Workflow Builder</span></h1>
        <p class="text-sm text-gray-600">Professional drag & drop workflow designer for trading strategies</p>
    </div>
    <div class="flex gap-2">
        <!-- Actions dropdown with Nodes list -->
        <!-- Create New Workflow -->
        <button onclick="createNewWorkflow()"
            class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
            <i class="fas fa-plus mr-1"></i>New
        </button>

        <div class="dropdown">
            <button class="px-3 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 text-sm" id="actionsBtn">
                <i class="fas fa-bolt mr-1"></i>Actions
            </button>
            <div class="dropdown-menu" id="actionsMenu">
                <div class="px-3 py-2 text-xs text-gray-500">Add Node</div>
                <div id="actionsNodes"></div>
                <div class="border-t my-1"></div>
                <div class="dropdown-item" onclick="validateWorkflow()"><i
                        class="fas fa-check-circle text-yellow-600"></i>Validate</div>
                <div class="dropdown-item" onclick="runWorkflow()"><i class="fas fa-play text-green-600"></i>Run</div>
                <div class="dropdown-item" onclick="openApplyWorkerModal()"><i
                        class="fas fa-user-cog text-blue-600"></i>Apply to Worker</div>
                <div class="dropdown-item" onclick="clearWorkflow()"><i class="fas fa-trash text-red-600"></i>Clear
                </div>
            </div>
        </div>
        <!-- File Operations -->
        <button onclick="openSaveModal()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
            <i class="fas fa-save mr-1"></i>Save
        </button>
        <button onclick="openLoadModal()"
            class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
            <i class="fas fa-folder-open mr-1"></i>Load
        </button>

        <!-- Edit Operations -->
        <button onclick="undo()" class="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm"
            title="Undo">
            <i class="fas fa-undo mr-1"></i>Undo
        </button>
        <button onclick="redo()" class="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm"
            title="Redo">
            <i class="fas fa-redo mr-1"></i>Redo
        </button>

        <!-- Copy/Paste -->
        <button onclick="copySelected()"
            class="px-3 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-sm" title="Copy">
            <i class="fas fa-copy mr-1"></i>Copy
        </button>
        <button onclick="paste()" class="px-3 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-sm"
            title="Paste">
            <i class="fas fa-paste mr-1"></i>Paste
        </button>

        <!-- Validation & Execution -->
        <button onclick="validateWorkflow()"
            class="px-3 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-sm" title="Validate">
            <i class="fas fa-check-circle mr-1"></i>Validate
        </button>
        <button onclick="runWorkflow()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
            <i class="fas fa-play mr-1"></i>Run
        </button>

        <!-- Clear -->
        <button onclick="clearWorkflow()" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
            <i class="fas fa-trash mr-1"></i>Clear
        </button>
    </div>
</div>

<!-- Menu Toggle -->
<div class="menu-toggle" onclick="toggleMenu()">
    <i class="fas fa-bars text-gray-600"></i>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="notification-container">
    <!-- Notifications will be added here dynamically -->
</div>


<!-- Main Workflow Area -->
<div class="relative">
    <!-- Canvas -->
    <div id="workflowCanvas" class="workflow-canvas">
        <!-- Nodes will be added here dynamically -->
    </div>

    <!-- Canvas Controls - Outside canvas, fixed position, not affected by zoom -->
    <div class="canvas-controls"
        style="position: fixed; top: 50%; right: 20px; transform: translateY(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 8px;">
        <button class="control-button" onclick="zoomIn()" title="Zoom In">
            <i class="fas fa-plus text-gray-600"></i>
        </button>
        <button class="control-button" onclick="zoomOut()" title="Zoom Out">
            <i class="fas fa-minus text-gray-600"></i>
        </button>
        <button class="control-button" onclick="resetZoom()" title="Reset Zoom">
            <i class="fas fa-expand-arrows-alt text-gray-600"></i>
        </button>
        <button class="control-button" onclick="togglePan()" title="Pan Mode">
            <i class="fas fa-hand-paper text-gray-600"></i>
        </button>
    </div>

    <!-- Compact Node Palette removed as per request; use Actions dropdown instead -->

    <!-- Inspector Panel -->
    <div id="inspectorPanel" aria-live="polite">
        <div class="hdr">
            <span id="inspectorTitle">Inspector</span>
            <button onclick="document.getElementById('inspectorPanel').classList.remove('active')" title="Close"
                class="text-gray-500 hover:text-gray-700">×</button>
        </div>
        <div class="body" id="inspectorBody"></div>
    </div>
</div>

<!-- Workflow Status -->
<div class="status-bar">
    <div>
        <h4 class="font-medium text-gray-900">Workflow Status</h4>
        <p class="text-sm text-gray-600">Nodes: <span id="nodeCount">0</span> | Connections: <span
                id="connectionCount">0</span></p>
        <p class="text-xs text-gray-500 mt-1">Current: <span id="currentWorkflowName">—</span></p>
    </div>
    <div class="flex items-center gap-4">
        <div id="workflowStatus" class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span class="text-sm text-gray-600" id="statusText">Ready</span>
        </div>
        <button id="applyWorkerBtn" onclick="openApplyWorkerModal()"
            class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">
            <i class="fas fa-user-cog mr-1"></i>Apply to Worker
        </button>
        <button id="stopRunBtn" onclick="stopWorkflowRun()"
            class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
            <i class="fas fa-stop mr-1"></i>Stop
        </button>
        <button id="restartRunBtn" onclick="restartWorkflowRun()"
            class="px-3 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm">
            <i class="fas fa-redo mr-1"></i>Restart
        </button>
        <button id="historyBtn" onclick="openRunHistoryModal()"
            class="px-3 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 text-sm">
            <i class="fas fa-history mr-1"></i>History
        </button>
    </div>
</div>

<script>
    class SimpleWorkflowBuilder {
        constructor() {
            this.canvas = document.getElementById('workflowCanvas');
            this.nodes = new Map();
            this.connections = [];
            this.selectedNode = null;
            this.nodeCounter = 0;
            this.isDragging = false;
            this.dragOffset = { x: 0, y: 0 };
            this.isConnecting = false;
            this.connectionStart = null;
            this.currentWorkflowId = null; // Track current workflow ID
            this.gridSize = 10; // snap-to-grid px
            this.dragSmoothing = 0.15; // 0..1 for eased dragging
            this._dragTargetPosition = null;
            this.nodeProperties = new Map(); // Store node properties
            this.statusPollInterval = null;
            this.statusPollMs = 5000; // poll every 5s
            this.currentRunStatus = 'idle';
            this.currentRunId = null; // Active run/job id if provided by backend
            this.justStartedRun = false; // Flag to track if user just started a run

            // Zoom and pan properties
            this.zoomLevel = 1;
            this.panX = 0;
            this.panY = 0;
            this.isPanning = false;
            this.panStart = { x: 0, y: 0 };

            // Advanced features
            this.history = [];
            this.historyIndex = -1;
            this.clipboard = null;
            this.maxHistorySize = 50;

            this.init();
        }

        init() {
            console.log('Initializing SimpleWorkflowBuilder...');
            this.setupEventListeners();
            this.setupDragAndDrop();
            this.setupPaletteResizeAndSearch();
            this.updateStatus();
            this.updateControlButtonsState();
            this.updateSaveUIState();
            console.log('SimpleWorkflowBuilder initialized successfully');
        }

        setupEventListeners() {
            // Canvas click to deselect
            this.canvas.addEventListener('click', (e) => {
                if (e.target === this.canvas) {
                    this.deselectAll();
                }
            });

            // Pan mode support
            this.canvas.addEventListener('mousedown', (e) => {
                if (this.isPanning && e.target === this.canvas) {
                    this.startPan(e);
                }
            });

            // Wheel zoom like n8n - much slower and smoother
            this.canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.98 : 1.02;
                this.zoomLevel = Math.min(Math.max(this.zoomLevel * delta, 0.1), 5);
                this.applyTransform();
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 'z':
                            e.preventDefault();
                            if (e.shiftKey) {
                                this.redo();
                            } else {
                                this.undo();
                            }
                            break;
                        case 'y':
                            e.preventDefault();
                            this.redo();
                            break;
                        case 'c':
                            e.preventDefault();
                            this.copySelected();
                            break;
                        case 'v':
                            e.preventDefault();
                            this.paste();
                            break;
                        case 's':
                            e.preventDefault();
                            this.openSaveModal();
                            break;
                    }
                } else if (e.key === 'Delete' && this.selectedNode) {
                    this.deleteNode(this.selectedNode);
                }
            });
        }

        setupDragAndDrop() {
            console.log('Setting up drag and drop...');

            // Palette items
            document.querySelectorAll('.palette-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    console.log('Drag start:', item.dataset.nodeType);
                    e.dataTransfer.setData('text/plain', item.dataset.nodeType);
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', (e) => {
                    item.classList.remove('dragging');
                });
            });

            // Canvas drop
            this.canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            this.canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const nodeType = e.dataTransfer.getData('text/plain');
                const rect = this.canvas.getBoundingClientRect();
                const rawX = e.clientX - rect.left;
                const rawY = e.clientY - rect.top;
                const x = Math.round(rawX / this.gridSize) * this.gridSize;
                const y = Math.round(rawY / this.gridSize) * this.gridSize;
                console.log('Drop event:', nodeType, x, y);
                this.createNode(nodeType, x, y);
            });
        }

        createNode(type, x, y) {
            this.saveToHistory();
            const nodeId = `node_${++this.nodeCounter}`;
            const node = {
                id: nodeId,
                type: type,
                x: x,
                y: y,
                properties: this.getDefaultProperties(type)
            };

            this.nodes.set(nodeId, node);
            this.renderNode(node);
            this.applyTransform(); // Apply current zoom/pan to new node
            this.updateStatus();
            console.log('Node created:', nodeId);
            return node;
        }

        getTimeframeIcon(tf) {
            const icons = {
                '1m': '🕐', '2m': '🕑', '5m': '🕒', '15m': '🕓',
                '30m': '🕔', '1h': '🕕', '4h': '🕖'
            };
            return icons[tf] || '⏰';
        }

        getTimeframeWeight(tf) {
            const weights = {
                '1m': 2, '2m': 3, '5m': 4, '15m': 5,
                '30m': 6, '1h': 7, '4h': 8
            };
            return weights[tf] || 1;
        }

        getTimeframeCategory(tf) {
            const categories = {
                '4h': 'Long', '1h': 'Long',
                '30m': 'Mid', '15m': 'Mid',
                '5m': 'ShLead',
                '2m': 'Short', '1m': 'Short'
            };
            return categories[tf] || '';
        }

        getZoneThresholdsRows() {
            const zones = [
                { name: 'FMACD IgR Zone', type: 'fmacd', zone: 'IgR', color: 'text-green-600' },
                { name: 'SMACD IgR Zone', type: 'smacd', zone: 'IgR', color: 'text-green-600' },
                { name: 'FMACD Greed Zone', type: 'fmacd', zone: 'Greed', color: 'text-green-600' },
                { name: 'SMACD Greed Zone', type: 'smacd', zone: 'Greed', color: 'text-green-600' },
                { name: 'FMACD Bull Zone', type: 'fmacd', zone: 'Bull', color: 'text-green-600' },
                { name: 'SMACD Bull Zone', type: 'smacd', zone: 'Bull', color: 'text-green-600' },
                { name: 'FMACD Pos Zone', type: 'fmacd', zone: 'Pos', color: 'text-green-600' },
                { name: 'SMACD Pos Zone', type: 'smacd', zone: 'Pos', color: 'text-green-600' },
                { name: 'FMACD Neutral', type: 'fmacd', zone: 'Neutral', color: 'text-gray-600' },
                { name: 'SMACD Neutral', type: 'smacd', zone: 'Neutral', color: 'text-gray-600' },
                { name: 'FMACD Neg Zone', type: 'fmacd', zone: 'Neg', color: 'text-red-600' },
                { name: 'SMACD Neg Zone', type: 'smacd', zone: 'Neg', color: 'text-red-600' },
                { name: 'FMACD Bear Zone', type: 'fmacd', zone: 'Bear', color: 'text-red-600' },
                { name: 'SMACD Bear Zone', type: 'smacd', zone: 'Bear', color: 'text-red-600' },
                { name: 'FMACD Fear Zone', type: 'fmacd', zone: 'Fear', color: 'text-red-600' },
                { name: 'SMACD Fear Zone', type: 'smacd', zone: 'Fear', color: 'text-red-600' },
                { name: 'FMACD Panic Zone', type: 'fmacd', zone: 'Panic', color: 'text-red-600' },
                { name: 'SMACD Panic Zone', type: 'smacd', zone: 'Panic', color: 'text-red-600' }
            ];

            return zones.map(zone => `
                <tr class="border-t">
                    <td class="px-3 py-2 font-medium ${zone.color}">${zone.name}</td>
                    ${['4h', '1h', '30m', '15m', '5m', '2m', '1m'].map(tf => `
                        <td class="px-2 py-1 text-center">
                            <input type="text" class="w-20 px-1 py-1 text-center border rounded zone-threshold" 
                                   data-tf="${tf}" data-type="${zone.type}" data-zone="${zone.zone}" 
                                   value="${this.getDefaultZoneThreshold(tf, zone.type, zone.zone)}" 
                                   onchange="workflowBuilder.autoSaveTimeframe('${tf}')">
                        </td>
                    `).join('')}
                </tr>
            `).join('');
        }

        getBarsMomentumsRows() {
            const momentums = [
                { name: 'BARS Hurricane', type: 'bars', momentum: 'Hurricane', color: 'text-red-700' },
                { name: 'BARS Storm', type: 'bars', momentum: 'Storm', color: 'text-red-600' },
                { name: 'BARS StrongWind', type: 'bars', momentum: 'StrongWind', color: 'text-orange-600' },
                { name: 'BARS Windy', type: 'bars', momentum: 'Windy', color: 'text-yellow-600' },
                { name: 'BARS Neutral', type: 'bars', momentum: 'Neutral', color: 'text-gray-600' }
            ];

            return momentums.map(momentum => `
                <tr class="border-t bg-yellow-50">
                    <td class="px-3 py-2 font-medium ${momentum.color}">${momentum.name}</td>
                    ${['4h', '1h', '30m', '15m', '5m', '2m', '1m'].map(tf => `
                        <td class="px-2 py-1 text-center">
                            <input type="text" class="w-20 px-1 py-1 text-center border rounded bars-momentum" 
                                   data-tf="${tf}" data-type="${momentum.type}" data-momentum="${momentum.momentum}" 
                                   value="${this.getDefaultBarsMomentum(tf, momentum.momentum)}" 
                                   onchange="workflowBuilder.autoSaveTimeframe('${tf}')">
                        </td>
                    `).join('')}
                </tr>
            `).join('');
        }

        getDefaultZoneThreshold(tf, type, zone) {
            const thresholds = {
                '4h': { fmacd: { IgR: '>3.5', Greed: '>3.0', Bull: '>2.5', Pos: '>2.0', Neutral: '<>1.6', Neg: '<-1.3', Bear: '<-2.0', Fear: '<-2.5', Panic: '<-3.0' }, smacd: { IgR: '>2.5', Greed: '>2.2', Bull: '>1.8', Pos: '>1.5', Neutral: '<>1.3', Neg: '<-1.0', Bear: '<-1.5', Fear: '<-1.8', Panic: '<-2.2' } },
                '1h': { fmacd: { IgR: '>3.0', Greed: '>2.5', Bull: '>2.0', Pos: '>1.6', Neutral: '<>1.3', Neg: '<-1.0', Bear: '<-1.6', Fear: '<-2.0', Panic: '<-2.5' }, smacd: { IgR: '>2.2', Greed: '>1.8', Bull: '>1.5', Pos: '>1.3', Neutral: '<>1.0', Neg: '<-0.8', Bear: '<-1.3', Fear: '<-1.5', Panic: '<-1.8' } },
                '30m': { fmacd: { IgR: '>2.5', Greed: '>2.0', Bull: '>1.6', Pos: '>1.3', Neutral: '<>1.0', Neg: '<-0.8', Bear: '<-1.3', Fear: '<-1.6', Panic: '<-2.0' }, smacd: { IgR: '>1.8', Greed: '>1.5', Bull: '>1.3', Pos: '>1.0', Neutral: '<>0.8', Neg: '<-0.6', Bear: '<-1.0', Fear: '<-1.3', Panic: '<-1.5' } },
                '15m': { fmacd: { IgR: '>2.0', Greed: '>1.6', Bull: '>1.3', Pos: '>1.0', Neutral: '<>0.8', Neg: '<-0.6', Bear: '<-1.0', Fear: '<-1.3', Panic: '<-1.6' }, smacd: { IgR: '>1.5', Greed: '>1.2', Bull: '>1.0', Pos: '>0.8', Neutral: '<>0.6', Neg: '<-0.5', Bear: '<-0.8', Fear: '<-1.0', Panic: '<-1.2' } },
                '5m': { fmacd: { IgR: '>1.5', Greed: '>1.2', Bull: '>1.0', Pos: '>0.8', Neutral: '<>0.6', Neg: '<-0.5', Bear: '<-0.8', Fear: '<-1.0', Panic: '<-1.2' }, smacd: { IgR: '>1.1', Greed: '>0.9', Bull: '>0.8', Pos: '>0.6', Neutral: '<>0.5', Neg: '<-0.4', Bear: '<-0.6', Fear: '<-0.8', Panic: '<-0.9' } },
                '2m': { fmacd: { IgR: '>1.2', Greed: '>1.0', Bull: '>0.8', Pos: '>0.6', Neutral: '<>0.5', Neg: '<-0.4', Bear: '<-0.6', Fear: '<-0.8', Panic: '<-1.0' }, smacd: { IgR: '>0.8', Greed: '>0.7', Bull: '>0.6', Pos: '>0.5', Neutral: '<>0.4', Neg: '<-0.3', Bear: '<-0.5', Fear: '<-0.6', Panic: '<-0.7' } },
                '1m': { fmacd: { IgR: '>1.0', Greed: '>0.8', Bull: '>0.6', Pos: '>0.5', Neutral: '<>0.4', Neg: '<-0.3', Bear: '<-0.5', Fear: '<-0.6', Panic: '<-0.8' }, smacd: { IgR: '>0.7', Greed: '>0.6', Bull: '>0.5', Pos: '>0.4', Neutral: '<>0.3', Neg: '<-0.22', Bear: '<-0.4', Fear: '<-0.5', Panic: '<-0.6' } }
            };
            return thresholds[tf]?.[type]?.[zone] || '>0.5';
        }

        getDefaultBarsMomentum(tf, momentum) {
            const momentums = {
                '4h': { Hurricane: '>3.0', Storm: '>2.5', StrongWind: '>2.0', Windy: '>1.5', Neutral: '>1.0' },
                '1h': { Hurricane: '>2.5', Storm: '>2.0', StrongWind: '>1.8', Windy: '>1.3', Neutral: '>0.8' },
                '30m': { Hurricane: '>2.2', Storm: '>1.8', StrongWind: '>1.5', Windy: '>1.0', Neutral: '>0.6' },
                '15m': { Hurricane: '>1.8', Storm: '>1.4', StrongWind: '>1.2', Windy: '>0.8', Neutral: '>0.5' },
                '5m': { Hurricane: '>1.3', Storm: '>1.0', StrongWind: '>0.9', Windy: '>0.6', Neutral: '>0.4' },
                '2m': { Hurricane: '>1.1', Storm: '>0.8', StrongWind: '>0.7', Windy: '>0.5', Neutral: '>0.3' },
                '1m': { Hurricane: '>1.0', Storm: '>0.7', StrongWind: '>0.6', Windy: '>0.4', Neutral: '>0.2' }
            };
            return momentums[tf]?.[momentum] || '>0.5';
        }

        getZoneThresholdsPreview(tf) {
            // Different zone thresholds for different timeframes
            const zoneThresholds = {
                '1m': {
                    IgR: { FMACD: '≥1.0', SMACD: '≥0.7', BARS: '≥1.0' },
                    Greed: { FMACD: '≥0.8', SMACD: '≥0.6', BARS: '≥0.7' },
                    Bull: { FMACD: '≥0.6', SMACD: '≥0.5', BARS: '≥0.6' }
                },
                '2m': {
                    IgR: { FMACD: '≥1.2', SMACD: '≥0.8', BARS: '≥1.1' },
                    Greed: { FMACD: '≥1.0', SMACD: '≥0.7', BARS: '≥0.8' },
                    Bull: { FMACD: '≥0.8', SMACD: '≥0.6', BARS: '≥0.7' }
                },
                '5m': {
                    IgR: { FMACD: '≥1.5', SMACD: '≥1.1', BARS: '≥1.3' },
                    Greed: { FMACD: '≥1.2', SMACD: '≥0.9', BARS: '≥1.0' },
                    Bull: { FMACD: '≥1.0', SMACD: '≥0.8', BARS: '≥0.9' }
                },
                '15m': {
                    IgR: { FMACD: '≥2.0', SMACD: '≥1.5', BARS: '≥1.8' },
                    Greed: { FMACD: '≥1.6', SMACD: '≥1.2', BARS: '≥1.4' },
                    Bull: { FMACD: '≥1.3', SMACD: '≥1.0', BARS: '≥1.2' }
                },
                '30m': {
                    IgR: { FMACD: '≥2.5', SMACD: '≥1.8', BARS: '≥2.2' },
                    Greed: { FMACD: '≥2.0', SMACD: '≥1.5', BARS: '≥1.8' },
                    Bull: { FMACD: '≥1.6', SMACD: '≥1.3', BARS: '≥1.5' }
                },
                '1h': {
                    IgR: { FMACD: '≥3.0', SMACD: '≥2.2', BARS: '≥2.5' },
                    Greed: { FMACD: '≥2.5', SMACD: '≥1.8', BARS: '≥2.0' },
                    Bull: { FMACD: '≥2.0', SMACD: '≥1.5', BARS: '≥1.8' }
                },
                '4h': {
                    IgR: { FMACD: '≥3.5', SMACD: '≥2.5', BARS: '≥3.0' },
                    Greed: { FMACD: '≥3.0', SMACD: '≥2.2', BARS: '≥2.5' },
                    Bull: { FMACD: '≥2.5', SMACD: '≥1.8', BARS: '≥2.2' }
                }
            };

            const thresholds = zoneThresholds[tf] || zoneThresholds['1m'];

            return `
                <div class="text-center">
                    <div class="font-medium text-green-600">IgR</div>
                    <div class="text-gray-500">FMACD: ${thresholds.IgR.FMACD}</div>
                    <div class="text-gray-500">SMACD: ${thresholds.IgR.SMACD}</div>
                </div>
                <div class="text-center">
                    <div class="font-medium text-green-600">Greed</div>
                    <div class="text-gray-500">FMACD: ${thresholds.Greed.FMACD}</div>
                    <div class="text-gray-500">SMACD: ${thresholds.Greed.SMACD}</div>
                </div>
                <div class="text-center">
                    <div class="font-medium text-green-600">Bull</div>
                    <div class="text-gray-500">FMACD: ${thresholds.Bull.FMACD}</div>
                    <div class="text-gray-500">SMACD: ${thresholds.Bull.SMACD}</div>
                </div>
            `;
        }

        getMockZoneThresholdsForTimeframe(tf) {
            // Mock data structure that matches the API response format
            const mockData = {
                '1m': {
                    timeframes: [
                        {
                            tf: '1m',
                            params: {
                                zone_thresholds: {
                                    FMACD: ['>=1.0', '>=0.8', '>=0.6', '>=0.5', '>=0.4', '>=0.3', '>=0.22', '>=0.15', '>=0.1'],
                                    SMACD: ['>=0.7', '>=0.6', '>=0.5', '>=0.4', '>=0.3', '>=0.22', '>=0.15', '>=0.1', '>=0.07'],
                                    BARS: ['>=1.0', '>=0.7', '>=0.6', '>=0.5', '>=0.4']
                                }
                            }
                        }
                    ]
                },
                '2m': {
                    timeframes: [
                        {
                            tf: '2m',
                            params: {
                                zone_thresholds: {
                                    FMACD: ['>=1.2', '>=1.0', '>=0.8', '>=0.6', '>=0.5', '>=0.4', '>=0.3', '>=0.22', '>=0.15'],
                                    SMACD: ['>=0.8', '>=0.7', '>=0.6', '>=0.5', '>=0.4', '>=0.3', '>=0.22', '>=0.15', '>=0.1'],
                                    BARS: ['>=1.1', '>=0.8', '>=0.7', '>=0.6', '>=0.5']
                                }
                            }
                        }
                    ]
                },
                '5m': {
                    timeframes: [
                        {
                            tf: '5m',
                            params: {
                                zone_thresholds: {
                                    FMACD: ['>=1.5', '>=1.2', '>=1.0', '>=0.8', '>=0.6', '>=0.5', '>=0.35', '>=0.25', '>=0.18'],
                                    SMACD: ['>=1.1', '>=0.9', '>=0.8', '>=0.6', '>=0.5', '>=0.35', '>=0.25', '>=0.18', '>=0.12'],
                                    BARS: ['>=1.3', '>=1.0', '>=0.9', '>=0.8', '>=0.6']
                                }
                            }
                        }
                    ]
                },
                '15m': {
                    timeframes: [
                        {
                            tf: '15m',
                            params: {
                                zone_thresholds: {
                                    FMACD: ['>=2.0', '>=1.6', '>=1.3', '>=1.0', '>=0.8', '>=0.6', '>=0.5', '>=0.35', '>=0.25'],
                                    SMACD: ['>=1.5', '>=1.2', '>=1.0', '>=0.8', '>=0.6', '>=0.5', '>=0.35', '>=0.25', '>=0.18'],
                                    BARS: ['>=1.8', '>=1.4', '>=1.2', '>=1.0', '>=0.8']
                                }
                            }
                        }
                    ]
                },
                '30m': {
                    timeframes: [
                        {
                            tf: '30m',
                            params: {
                                zone_thresholds: {
                                    FMACD: ['>=2.5', '>=2.0', '>=1.6', '>=1.3', '>=1.0', '>=0.8', '>=0.6', '>=0.5', '>=0.35'],
                                    SMACD: ['>=1.8', '>=1.5', '>=1.3', '>=1.0', '>=0.8', '>=0.6', '>=0.5', '>=0.35', '>=0.25'],
                                    BARS: ['>=2.2', '>=1.8', '>=1.5', '>=1.3', '>=1.0']
                                }
                            }
                        }
                    ]
                },
                '1h': {
                    timeframes: [
                        {
                            tf: '1h',
                            params: {
                                zone_thresholds: {
                                    FMACD: ['>=3.0', '>=2.5', '>=2.0', '>=1.6', '>=1.3', '>=1.0', '>=0.8', '>=0.6', '>=0.5'],
                                    SMACD: ['>=2.2', '>=1.8', '>=1.5', '>=1.3', '>=1.0', '>=0.8', '>=0.6', '>=0.5', '>=0.35'],
                                    BARS: ['>=2.5', '>=2.0', '>=1.8', '>=1.5', '>=1.3']
                                }
                            }
                        }
                    ]
                },
                '4h': {
                    timeframes: [
                        {
                            tf: '4h',
                            params: {
                                zone_thresholds: {
                                    FMACD: ['>=3.5', '>=3.0', '>=2.5', '>=2.0', '>=1.6', '>=1.3', '>=1.0', '>=0.8', '>=0.6'],
                                    SMACD: ['>=2.5', '>=2.2', '>=1.8', '>=1.5', '>=1.3', '>=1.0', '>=0.8', '>=0.6', '>=0.5'],
                                    BARS: ['>=3.0', '>=2.5', '>=2.2', '>=1.8', '>=1.5']
                                }
                            }
                        }
                    ]
                }
            };

            return mockData[tf] || mockData['1m'];
        }

        getDefaultProperties(type) {
            const defaults = {
                // Input Nodes
                symbol: {
                    ticker: 'VN30',
                    exchange: 'HOSE',
                    timeframes: ['1m', '2m', '5m', '15m', '30m', '1h', '4h'],
                    market: 'VN'
                },
                'data-source': {
                    source: 'yfinance',
                    api_key: '',
                    rate_limit: 100,
                    timeout: 30
                },

                // VN Strategy Nodes - 7 Timeframes System (Production Ready)
                'vn-macd-7tf': {
                    // 7 Timeframes với weights từ hệ thống hiện tại
                    timeframes: ['1m', '2m', '5m', '15m', '30m', '1h', '4h'],
                    timeframeWeights: {
                        '1m': 2,    // Khung nhỏ - tìm điểm vào lệnh
                        '2m': 3,    // Khung nhỏ - tìm điểm vào lệnh
                        '5m': 4,    // Khung nhỏ - tìm điểm vào lệnh
                        '15m': 5,   // Khung trung bình - xác nhận xu hướng
                        '30m': 6,   // Khung trung bình - xác nhận xu hướng
                        '1h': 7,    // Khung lớn - xác định xu hướng chính
                        '4h': 8     // Khung lớn - xác định xu hướng chính
                    },
                    // MACD Parameters từ hệ thống hiện tại
                    fastPeriod: 12,
                    slowPeriod: 26,
                    signalPeriod: 9,
                    useZones: true,
                    marketTemplate: 'VN',
                    minConfidence: 0.6,
                    // Consensus Requirements từ hệ thống hiện tại
                    minTrendConsensus: 2,  // Ít nhất 2 khung lớn (1h, 4h)
                    minEntryConsensus: 2,  // Ít nhất 2 khung nhỏ (1m, 2m, 5m)
                    // Strategy Type
                    strategyType: 'VN_MACD_7TF',
                    isProductionReady: true
                },
                'vn-sma-7tf': {
                    // 7 Timeframes với weights từ hệ thống hiện tại
                    timeframes: ['1m', '2m', '5m', '15m', '30m', '1h', '4h'],
                    timeframeWeights: {
                        '1m': 2,    // Khung nhỏ - tìm điểm vào lệnh
                        '2m': 3,    // Khung nhỏ - tìm điểm vào lệnh
                        '5m': 4,    // Khung nhỏ - tìm điểm vào lệnh
                        '15m': 5,   // Khung trung bình - xác nhận xu hướng
                        '30m': 6,   // Khung trung bình - xác nhận xu hướng
                        '1h': 7,    // Khung lớn - xác định xu hướng chính
                        '4h': 8     // Khung lớn - xác định xu hướng chính
                    },
                    // SMA Parameters từ hệ thống hiện tại
                    periods: [18, 36, 48, 144],
                    tripleConfirmation: true,
                    minConfirmation: 3,
                    minConfidence: 0.5,
                    // Consensus Requirements từ hệ thống hiện tại
                    minTrendConsensus: 2,  // Ít nhất 2 khung lớn
                    minEntryConsensus: 2,  // Ít nhất 2 khung nhỏ
                    // Strategy Type
                    strategyType: 'VN_SMA_7TF',
                    isProductionReady: true
                },

                // Strategy Nodes - 7 Timeframes System
                macd: {
                    // 7 Timeframes với weights
                    timeframes: ['1m', '2m', '5m', '15m', '30m', '1h', '4h'],
                    timeframeWeights: {
                        '1m': 2,    // Khung nhỏ - tìm điểm vào lệnh
                        '2m': 3,    // Khung nhỏ - tìm điểm vào lệnh
                        '5m': 4,    // Khung nhỏ - tìm điểm vào lệnh
                        '15m': 5,   // Khung trung bình - xác nhận xu hướng
                        '30m': 6,   // Khung trung bình - xác nhận xu hướng
                        '1h': 7,    // Khung lớn - xác định xu hướng chính
                        '4h': 8     // Khung lớn - xác định xu hướng chính
                    },
                    // MACD Parameters
                    fastPeriod: 12,
                    slowPeriod: 26,
                    signalPeriod: 9,
                    useZones: true,
                    marketTemplate: 'VN',
                    minConfidence: 0.6,
                    // Consensus Requirements
                    minTrendConsensus: 2,  // Ít nhất 2 khung lớn (1h, 4h)
                    minEntryConsensus: 2   // Ít nhất 2 khung nhỏ (1m, 2m, 5m)
                },
                sma: {
                    // 7 Timeframes với weights
                    timeframes: ['1m', '2m', '5m', '15m', '30m', '1h', '4h'],
                    timeframeWeights: {
                        '1m': 2,    // Khung nhỏ - tìm điểm vào lệnh
                        '2m': 3,    // Khung nhỏ - tìm điểm vào lệnh
                        '5m': 4,    // Khung nhỏ - tìm điểm vào lệnh
                        '15m': 5,   // Khung trung bình - xác nhận xu hướng
                        '30m': 6,   // Khung trung bình - xác nhận xu hướng
                        '1h': 7,    // Khung lớn - xác định xu hướng chính
                        '4h': 8     // Khung lớn - xác định xu hướng chính
                    },
                    // SMA Parameters
                    periods: [18, 36, 48, 144],
                    tripleConfirmation: true,
                    minConfirmation: 3,
                    minConfidence: 0.5,
                    // Consensus Requirements
                    minTrendConsensus: 2,  // Ít nhất 2 khung lớn
                    minEntryConsensus: 2   // Ít nhất 2 khung nhỏ
                },
                rsi: {
                    period: 14,
                    timeframes: ['1m', '2m', '5m', '15m', '30m', '1h', '4h'],
                    overbought: 70,
                    oversold: 30,
                    minConfidence: 0.6
                },
                bollinger: {
                    period: 20,
                    stdDev: 2,
                    timeframes: ['1m', '2m', '5m', '15m', '30m', '1h', '4h'],
                    minConfidence: 0.5
                },
                'multi-indicator': {
                    // Symbol configuration
                    symbolThresholds: [],
                    // MACD Multi-TF configuration
                    macdMulti: {
                        fastPeriod: 7,
                        slowPeriod: 113,
                        signalPeriod: 144,
                        timeframes: ['1m', '2m', '5m', '15m', '30m', '1h']
                    },
                    // SMA configuration
                    sma: {
                        timeframes: ['1m', '2m', '5m', '15m', '30m', '1h', '4h'],
                        periods: [5, 10, 20, 50, 100, 200, 144]
                    },
                    // RSI configuration
                    rsi: {
                        period: 14,
                        timeframes: ['5m', '15m', '30m', '1h', '4h'],
                        overbought: 70,
                        oversold: 30
                    },
                    // Bollinger Bands configuration
                    bollinger: {
                        period: 20,
                        stdDev: 2,
                        timeframes: ['15m', '30m', '1h', '4h']
                    },
                    // Aggregation configuration
                    aggregation: {
                        method: 'weighted_average',
                        minStrategies: 3,
                        consensusThreshold: 0.7,
                        confidenceThreshold: 0.6,
                        customWeights: {
                            'macd_multi': 0.3,
                            'sma': 0.25,
                            'rsi': 0.2,
                            'bollinger': 0.25
                        }
                    }
                },
                'flexible-multi-indicator': {
                    // Flexible configuration
                    symbols: [],
                    symbolConfigs: {},
                    availableIndicators: {
                        'macd_multi': {
                            name: 'MACD Multi-TF',
                            icon: 'fas fa-chart-line',
                            weight: 0.3,
                            defaultConfig: {
                                fastPeriod: 7,
                                slowPeriod: 113,
                                signalPeriod: 144,
                                timeframes: ['1m', '2m', '5m', '15m', '30m', '1h']
                            }
                        },
                        'sma': {
                            name: 'SMA',
                            icon: 'fas fa-chart-area',
                            weight: 0.25,
                            defaultConfig: {
                                timeframes: ['1m', '2m', '5m', '15m', '30m', '1h', '4h'],
                                periods: [5, 10, 20, 50, 100, 200, 144]
                            }
                        },
                        'rsi': {
                            name: 'RSI',
                            icon: 'fas fa-chart-bar',
                            weight: 0.2,
                            defaultConfig: {
                                period: 14,
                                timeframes: ['5m', '15m', '30m', '1h', '4h'],
                                overbought: 70,
                                oversold: 30
                            }
                        },
                        'bollinger': {
                            name: 'Bollinger Bands',
                            icon: 'fas fa-chart-pie',
                            weight: 0.25,
                            defaultConfig: {
                                period: 20,
                                stdDev: 2,
                                timeframes: ['15m', '30m', '1h', '4h']
                            }
                        }
                    },
                    // Aggregation configuration
                    aggregation: {
                        method: 'weighted_average',
                        minIndicators: 3,
                        consensusThreshold: 0.7,
                        confidenceThreshold: 0.6
                    }
                },

                // Logic Nodes
                condition: {
                    operator: 'greater_than',
                    value: 0,
                    field: 'signal',
                    logic: 'AND'
                },
                aggregation: {
                    method: 'weighted_average',
                    minStrategies: 2,
                    consensusThreshold: 0.7,
                    confidenceThreshold: 0.6,
                    // 7 Timeframe Aggregation
                    useTimeframeWeights: true,
                    timeframeWeights: {
                        '1m': 2, '2m': 3, '5m': 4, '15m': 5, '30m': 6, '1h': 7, '4h': 8
                    }
                },
                filter: {
                    minConfidence: 0.7,
                    maxSignals: 10,
                    timeWindow: '1h',
                    criteria: 'confidence'
                },

                // Output Nodes
                output: {
                    channels: ['database', 'telegram'],
                    format: 'json',
                    autoStart: true
                },
                alert: {
                    channels: ['telegram', 'email'],
                    priority: 'medium',
                    template: 'default',
                    frequency: 'immediate'
                }
            };
            return defaults[type] || {};
        }

        renderNode(node) {
            const nodeElement = document.createElement('div');
            nodeElement.className = `node node-type-${node.type}`;
            nodeElement.id = `node-${node.id}`;
            nodeElement.style.left = `${node.x}px`;
            nodeElement.style.top = `${node.y}px`;
            nodeElement.dataset.nodeId = node.id;

            const nodeInfo = this.getNodeInfo(node.type);

            nodeElement.innerHTML = `
            <div class="node-header">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="${nodeInfo.icon} mr-2"></i>
                        ${nodeInfo.name}
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="workflowBuilder.openNodeConfiguration('${node.id}')" class="p-1 text-blue-500 hover:bg-blue-50 rounded" title="Configure">
                            <i class="fas fa-cog text-xs"></i>
                        </button>
                        <button onclick="workflowBuilder.deleteNode('${node.id}')" class="p-1 text-red-500 hover:bg-red-50 rounded" title="Delete">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="node-body">
                <div class="text-xs text-gray-600 mb-2">${nodeInfo.description}</div>
                <div class="node-status">${this.getNodeStatus(node)}</div>
            </div>
            <div class="connection-point input" data-node-id="${node.id}" data-type="input"></div>
            <div class="connection-point output" data-node-id="${node.id}" data-type="output"></div>
        `;

            // Add event listeners
            nodeElement.addEventListener('click', (e) => {
                e.stopPropagation();
                this.selectNode(node.id);
            });

            // Double click to open configuration modal
            nodeElement.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                this.openNodeConfiguration(node.id);
            });

            nodeElement.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('connection-point')) {
                    this.startConnection(e);
                    return;
                }
                this.startDrag(nodeElement, e);
            });

            this.canvas.appendChild(nodeElement);
        }

        getNodeInfo(type) {
            const info = {
                // Input Nodes
                symbol: { name: 'Symbol', icon: 'fas fa-coins', description: 'Chọn mã cổ phiếu' },
                'data-source': { name: 'Data Source', icon: 'fas fa-database', description: 'Nguồn dữ liệu' },

                // VN Strategy Nodes - 7 Timeframes
                'vn-macd-7tf': { name: 'VN MACD 7TF', icon: 'fas fa-chart-line', description: 'VN MACD 7 Timeframes Strategy' },
                'vn-sma-7tf': { name: 'VN SMA 7TF', icon: 'fas fa-chart-area', description: 'VN SMA 7 Timeframes Strategy' },

                // Strategy Nodes
                macd: { name: 'MACD', icon: 'fas fa-chart-line', description: 'MACD Strategy' },
                'macd-multi': { name: 'MACD Multi-TF', icon: 'fas fa-chart-line', description: 'MACD Multi-Timeframe Analysis' },
                sma: { name: 'SMA', icon: 'fas fa-chart-area', description: 'Moving Average Strategy' },
                rsi: { name: 'RSI', icon: 'fas fa-chart-bar', description: 'RSI Strategy' },
                bollinger: { name: 'Bollinger Bands', icon: 'fas fa-chart-pie', description: 'Bollinger Bands Strategy' },
                'multi-indicator': { name: 'Multi-Indicator', icon: 'fas fa-layer-group', description: 'Multi-Indicator Analysis (MACD+SMA+RSI+BB)' },
                'flexible-multi-indicator': { name: 'Flexible Multi-Indicator', icon: 'fas fa-cogs', description: 'Flexible Multi-Indicator System (Dynamic Configuration)' },

                // Logic Nodes
                condition: { name: 'Condition', icon: 'fas fa-question-circle', description: 'Điều kiện logic' },
                aggregation: { name: 'Aggregation', icon: 'fas fa-puzzle-piece', description: 'Tổng hợp tín hiệu' },
                filter: { name: 'Filter', icon: 'fas fa-filter', description: 'Lọc tín hiệu' },

                // Output Nodes
                output: { name: 'Output', icon: 'fas fa-signal', description: 'Xuất tín hiệu' },
                alert: { name: 'Alert', icon: 'fas fa-bell', description: 'Cảnh báo' }
            };
            return info[type] || { name: 'Unknown', icon: 'fas fa-question', description: 'Unknown node' };
        }

        getNodeStatus(node) {
            try {
                if (!node || !node.properties) {
                    return 'Not configured';
                }

                switch (node.type) {
                    case 'symbol':
                        return `${node.properties.ticker || 'N/A'} (${node.properties.exchange || 'N/A'})`;
                    case 'macd':
                        return `Fast: ${node.properties.fastPeriod || 'N/A'}, Slow: ${node.properties.slowPeriod || 'N/A'}`;
                    case 'macd-multi':
                        const tfCount = node.properties.timeframes ? node.properties.timeframes.length : 0;
                        const symbolCount = node.properties.symbolThresholds ? node.properties.symbolThresholds.length : 0;
                        return `${tfCount} TFs, ${symbolCount} symbols`;
                    case 'multi-indicator':
                        const multiSymbolCount = node.properties.symbolThresholds ? node.properties.symbolThresholds.length : 0;
                        const method = node.properties.aggregation?.method || 'weighted_average';
                        return `${multiSymbolCount} symbols, ${method}`;
                    case 'flexible-multi-indicator':
                        const flexibleSymbolCount = node.properties.symbols ? node.properties.symbols.length : 0;
                        const flexibleMethod = node.properties.aggregation?.method || 'weighted_average';
                        return `${flexibleSymbolCount} symbols, ${flexibleMethod}`;
                    case 'sma':
                        return `Periods: ${node.properties.periods ? node.properties.periods.join(', ') : 'N/A'}`;
                    case 'aggregation':
                        return `Method: ${node.properties.method || 'N/A'}`;
                    case 'output':
                        return `Channels: ${node.properties.channels ? node.properties.channels.length : 0}`;
                    default:
                        return 'Configured';
                }
            } catch (error) {
                console.error('Error getting node status:', error);
                return 'Error';
            }
        }

        openInspector(nodeId) {
            try {
                const panel = document.getElementById('inspectorPanel');
                const title = document.getElementById('inspectorTitle');
                const body = document.getElementById('inspectorBody');
                if (!panel || !body) return;
                const node = this.nodes.get(nodeId);
                if (!node) return;
                title.textContent = `Inspector • ${node.type}`;
                const props = node.properties || {};
                const entries = Object.entries(props);
                body.innerHTML = entries.length ? entries.map(([k, v]) => `<div class="mb-2"><div class="text-gray-600">${k}</div><div class="font-medium break-words">${typeof v === 'object' ? JSON.stringify(v) : v}</div></div>`).join('') : '<div class="text-gray-500">No quick properties</div>';
                panel.classList.add('active');
            } catch (e) { console.warn('Open inspector failed', e); }
        }

        setupPaletteResizeAndSearch() {
            try {
                const palette = document.getElementById('compactPalette');
                const handle = document.getElementById('paletteResizeHandle');
                const search = document.getElementById('paletteSearch');
                if (!palette || !handle) return;

                // restore width
                const saved = localStorage.getItem('wb:paletteWidth');
                if (saved) {
                    palette.style.width = saved + 'px';
                    document.documentElement.style.setProperty('--palette-width', saved + 'px');
                }

                let resizing = false;
                let startX = 0;
                let startWidth = 0;
                handle.addEventListener('mousedown', (e) => {
                    resizing = true;
                    startX = e.clientX;
                    startWidth = parseInt(getComputedStyle(palette).width, 10);
                    document.body.style.cursor = 'col-resize';
                    e.preventDefault();
                });
                document.addEventListener('mousemove', (e) => {
                    if (!resizing) return;
                    const delta = startX - e.clientX; // resize from left edge
                    let newWidth = Math.max(160, Math.min(360, startWidth + delta));
                    palette.style.width = newWidth + 'px';
                    document.documentElement.style.setProperty('--palette-width', newWidth + 'px');
                });
                document.addEventListener('mouseup', () => {
                    if (!resizing) return;
                    resizing = false;
                    document.body.style.cursor = '';
                    const w = parseInt(getComputedStyle(palette).width, 10);
                    localStorage.setItem('wb:paletteWidth', String(w));
                });

                if (search) {
                    const filter = () => {
                        const q = search.value.trim().toLowerCase();
                        document.querySelectorAll('.palette-item').forEach(el => {
                            const text = (el.getAttribute('title') || el.textContent || '').toLowerCase();
                            el.style.display = q && !text.includes(q) ? 'none' : '';
                        });
                    };
                    search.addEventListener('input', filter);
                }
            } catch (e) { console.warn('Palette resize/search setup failed', e); }
        }

        selectNode(nodeId) {
            this.deselectAll();
            this.selectedNode = nodeId;
            const nodeElement = document.querySelector(`[data-node-id="${nodeId}"]`);
            if (nodeElement) {
                nodeElement.classList.add('selected');
            }
            this.openInspector(nodeId);
        }

        deselectAll() {
            try {
                document.querySelectorAll('.node').forEach(node => {
                    node.classList.remove('selected');
                });
                this.selectedNode = null;
            } catch (error) {
                console.error('Error deselecting nodes:', error);
            }
        }


        updateNodeProperty(nodeId, property, value) {
            try {
                const node = this.nodes.get(nodeId);
                if (node) {
                    // Save to history for undo/redo
                    this.saveToHistory();

                    if (!node.properties) {
                        node.properties = {};
                    }
                    node.properties[property] = value;
                    this.nodeProperties.set(nodeId, node.properties);
                    this.updateNodeDisplay(nodeId);
                }
            } catch (error) {
                console.error('Error updating node property:', error);
            }
        }

        updateNodeDisplay(nodeId) {
            try {
                const node = this.nodes.get(nodeId);
                if (node) {
                    const nodeElement = document.querySelector(`[data-node-id="${nodeId}"]`);
                    if (nodeElement) {
                        const statusElement = nodeElement.querySelector('.node-status');
                        if (statusElement) {
                            statusElement.textContent = this.getNodeStatus(node);
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating node display:', error);
            }
        }

        startDrag(nodeElement, e) {
            this.isDragging = true;
            const rect = nodeElement.getBoundingClientRect();
            this.dragOffset.x = e.clientX - rect.left;
            this.dragOffset.y = e.clientY - rect.top;

            const nodeId = nodeElement.dataset.nodeId;
            this.selectNode(nodeId);

            // Cache element and current/target positions for RAF loop
            this._dragNodeEl = nodeElement;
            const node = this.nodes.get(this.selectedNode);
            this._dragCurrentPosition = { x: node?.x || 0, y: node?.y || 0 };
            this._dragTargetPosition = { x: this._dragCurrentPosition.x, y: this._dragCurrentPosition.y };

            document.addEventListener('mousemove', this.handleDrag.bind(this));
            document.addEventListener('mouseup', this.stopDrag.bind(this));

            // Start RAF-driven drag loop
            if (!this._dragRAFHandle) {
                const tick = () => {
                    if (!this.isDragging || !this._dragNodeEl) {
                        this._dragRAFHandle = null;
                        return;
                    }
                    // Interpolate towards target to smooth micro-jitter but keep high responsiveness
                    const follow = Math.max(0.75, this.dragSmoothing || 0.75);
                    this._dragCurrentPosition.x += (this._dragTargetPosition.x - this._dragCurrentPosition.x) * follow;
                    this._dragCurrentPosition.y += (this._dragTargetPosition.y - this._dragCurrentPosition.y) * follow;

                    const node = this.nodes.get(this.selectedNode);
                    if (node) {
                        node.x = this._dragCurrentPosition.x;
                        node.y = this._dragCurrentPosition.y;
                    }

                    // Apply position (left/top kept for compatibility)
                    this._dragNodeEl.style.left = `${Math.max(0, node.x)}px`;
                    this._dragNodeEl.style.top = `${Math.max(0, node.y)}px`;

                    // Update connections once per frame
                    this.updateConnections();

                    this._dragRAFHandle = requestAnimationFrame(tick);
                };
                this._dragRAFHandle = requestAnimationFrame(tick);
            }
        }

        handleDrag(e) {
            if (!this.isDragging || !this.selectedNode) return;
            const canvasRect = this.canvas.getBoundingClientRect();
            let targetX = e.clientX - canvasRect.left - this.dragOffset.x;
            let targetY = e.clientY - canvasRect.top - this.dragOffset.y;
            // snap to grid
            targetX = Math.round(targetX / this.gridSize) * this.gridSize;
            targetY = Math.round(targetY / this.gridSize) * this.gridSize;
            // Constrain to non-negative canvas space
            targetX = Math.max(0, targetX);
            targetY = Math.max(0, targetY);
            // Store only; actual DOM update happens in RAF loop
            if (!this._dragTargetPosition) this._dragTargetPosition = { x: targetX, y: targetY };
            this._dragTargetPosition.x = targetX;
            this._dragTargetPosition.y = targetY;
        }

        stopDrag() {
            this.isDragging = false;
            // Snap to exact grid on release
            if (this.selectedNode) {
                const node = this.nodes.get(this.selectedNode);
                if (node) {
                    node.x = Math.round(node.x / this.gridSize) * this.gridSize;
                    node.y = Math.round(node.y / this.gridSize) * this.gridSize;
                    if (this._dragNodeEl) {
                        this._dragNodeEl.style.left = `${Math.max(0, node.x)}px`;
                        this._dragNodeEl.style.top = `${Math.max(0, node.y)}px`;
                    }
                }
                this.updateConnections();
            }
            // Cancel RAF
            if (this._dragRAFHandle) {
                cancelAnimationFrame(this._dragRAFHandle);
                this._dragRAFHandle = null;
            }
            this._dragNodeEl = null;
            this._dragCurrentPosition = null;
            this._dragTargetPosition = null;
            document.removeEventListener('mousemove', this.handleDrag);
            document.removeEventListener('mouseup', this.stopDrag);
        }

        startConnection(e) {
            e.stopPropagation();
            this.isConnecting = true;
            this.connectionStart = {
                nodeId: e.target.dataset.nodeId,
                type: e.target.dataset.type,
                element: e.target
            };

            // Visual feedback
            e.target.style.background = '#10b981';
            e.target.style.borderColor = '#10b981';

            console.log('Starting connection from:', this.connectionStart);

            // Add mouse move and mouse up listeners
            document.addEventListener('mousemove', this.handleConnectionDrag.bind(this));
            document.addEventListener('mouseup', this.endConnection.bind(this));
        }

        handleConnectionDrag(e) {
            if (!this.isConnecting) return;

            // Create or update connection line
            this.drawConnectionLine(e);
        }

        drawConnectionLine(e) {
            // Remove existing connection line
            const existingLine = document.getElementById('temp-connection-line');
            if (existingLine) {
                existingLine.remove();
            }

            if (!this.connectionStart) return;

            const startElement = this.connectionStart.element;
            const startRect = startElement.getBoundingClientRect();
            const canvasRect = this.canvas.getBoundingClientRect();

            const startX = startRect.left + startRect.width / 2 - canvasRect.left;
            const startY = startRect.top + startRect.height / 2 - canvasRect.top;
            const endX = e.clientX - canvasRect.left;
            const endY = e.clientY - canvasRect.top;

            // Create SVG line
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.id = 'temp-connection-line';
            svg.style.position = 'absolute';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.pointerEvents = 'none';
            svg.style.zIndex = '1';

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', startX);
            line.setAttribute('y1', startY);
            line.setAttribute('x2', endX);
            line.setAttribute('y2', endY);
            line.setAttribute('stroke', '#3b82f6');
            line.setAttribute('stroke-width', '2');
            line.setAttribute('stroke-dasharray', '5,5');

            svg.appendChild(line);
            this.canvas.appendChild(svg);
        }

        endConnection(e) {
            if (!this.isConnecting) return;

            // Remove temporary connection line
            const tempLine = document.getElementById('temp-connection-line');
            if (tempLine) {
                tempLine.remove();
            }

            // Reset connection start visual
            if (this.connectionStart && this.connectionStart.element) {
                this.connectionStart.element.style.background = 'white';
                this.connectionStart.element.style.borderColor = '#3b82f6';
            }

            // Check if we're dropping on a connection point
            const target = e.target;
            if (target.classList.contains('connection-point')) {
                const targetNodeId = target.dataset.nodeId;
                const targetType = target.dataset.type;

                // Validate connection
                if (this.isValidConnection(this.connectionStart, { nodeId: targetNodeId, type: targetType })) {
                    this.createConnection(this.connectionStart, { nodeId: targetNodeId, type: targetType });
                } else {
                    console.log('Invalid connection');
                }
            }

            // Reset connection state
            this.isConnecting = false;
            this.connectionStart = null;

            // Remove event listeners
            document.removeEventListener('mousemove', this.handleConnectionDrag);
            document.removeEventListener('mouseup', this.endConnection);
        }

        isValidConnection(start, end) {
            // Can't connect to same node
            if (start.nodeId === end.nodeId) return false;

            // Can't connect input to input or output to output
            if (start.type === end.type) return false;

            // Must be output to input
            if (start.type !== 'output' || end.type !== 'input') return false;

            // Check if connection already exists
            const connectionExists = this.connections.some(conn =>
                conn.from.nodeId === start.nodeId &&
                conn.to.nodeId === end.nodeId
            );

            return !connectionExists;
        }

        createConnection(start, end) {
            const connection = {
                id: `conn_${Date.now()}`,
                from: { nodeId: start.nodeId, type: start.type },
                to: { nodeId: end.nodeId, type: end.type }
            };

            this.connections.push(connection);
            this.drawConnection(connection);
            this.updateStatus();

            console.log('Connection created:', connection);
        }

        drawConnection(connection) {
            const fromNode = document.querySelector(`[data-node-id="${connection.from.nodeId}"]`);
            const toNode = document.querySelector(`[data-node-id="${connection.to.nodeId}"]`);

            if (!fromNode || !toNode) return;

            const fromPoint = fromNode.querySelector('.connection-point.output');
            const toPoint = toNode.querySelector('.connection-point.input');

            if (!fromPoint || !toPoint) return;

            const fromRect = fromPoint.getBoundingClientRect();
            const toRect = toPoint.getBoundingClientRect();
            const canvasRect = this.canvas.getBoundingClientRect();

            const fromX = fromRect.left + fromRect.width / 2 - canvasRect.left;
            const fromY = fromRect.top + fromRect.height / 2 - canvasRect.top;
            const toX = toRect.left + toRect.width / 2 - canvasRect.left;
            const toY = toRect.top + toRect.height / 2 - canvasRect.top;

            // Create SVG connection
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.id = `connection-${connection.id}`;
            svg.style.position = 'absolute';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.pointerEvents = 'none';
            svg.style.zIndex = '1';

            // Create curved path
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const controlPoint1X = fromX + (toX - fromX) * 0.5;
            const controlPoint1Y = fromY;
            const controlPoint2X = fromX + (toX - fromX) * 0.5;
            const controlPoint2Y = toY;

            const pathData = `M ${fromX} ${fromY} C ${controlPoint1X} ${controlPoint1Y}, ${controlPoint2X} ${controlPoint2Y}, ${toX} ${toY}`;
            path.setAttribute('d', pathData);
            path.setAttribute('stroke', '#3b82f6');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('fill', 'none');
            path.setAttribute('marker-end', 'url(#arrowhead)');

            // Make path clickable for deletion
            path.style.pointerEvents = 'stroke';
            path.style.cursor = 'pointer';
            path.addEventListener('click', (e) => {
                e.stopPropagation();
                this.deleteConnection(connection.id);
            });

            svg.appendChild(path);

            // Add arrowhead marker
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '7');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '3.5');
            marker.setAttribute('orient', 'auto');

            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
            polygon.setAttribute('fill', '#3b82f6');

            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);

            this.canvas.appendChild(svg);
        }

        deleteNode(nodeId) {
            const node = this.nodes.get(nodeId);
            if (node) {
                // Remove all connections involving this node
                this.connections = this.connections.filter(conn => {
                    if (conn.from.nodeId === nodeId || conn.to.nodeId === nodeId) {
                        // Remove connection SVG
                        const connectionSvg = document.getElementById(`connection-${conn.id}`);
                        if (connectionSvg) {
                            connectionSvg.remove();
                        }
                        return false;
                    }
                    return true;
                });

                this.nodes.delete(nodeId);
                const nodeElement = document.querySelector(`[data-node-id="${nodeId}"]`);
                if (nodeElement) {
                    // Clean up event listeners before removing
                    const clonedNode = nodeElement.cloneNode(true);
                    nodeElement.parentNode.replaceChild(clonedNode, nodeElement);
                    clonedNode.remove();
                }
                this.updateStatus();
                this.deselectAll();
            }
        }

        deleteConnection(connectionId) {
            // Remove from connections array
            this.connections = this.connections.filter(conn => conn.id !== connectionId);

            // Remove SVG element
            const connectionSvg = document.getElementById(`connection-${connectionId}`);
            if (connectionSvg) {
                connectionSvg.remove();
            }

            this.updateStatus();
            console.log('Connection deleted:', connectionId);
        }

        updateConnections() {
            // Remove all existing connection SVGs (more specific selector)
            document.querySelectorAll('svg[id^="connection-"]').forEach(svg => {
                svg.remove();
            });

            // Redraw all connections
            this.connections.forEach(connection => {
                this.drawConnection(connection);
            });
        }

        updateStatus() {
            try {
                const nodeCountElement = document.getElementById('nodeCount');
                const connectionCountElement = document.getElementById('connectionCount');
                const currentName = document.getElementById('currentWorkflowName');
                const pageTitleEl = document.getElementById('pageTitle');

                if (nodeCountElement) nodeCountElement.textContent = this.nodes ? this.nodes.size : 0;
                if (connectionCountElement) connectionCountElement.textContent = this.connections ? this.connections.length : 0;
                const title = this.currentWorkflowMeta?.name || 'Advanced Workflow Builder';
                if (currentName) currentName.textContent = this.currentWorkflowMeta?.name || '—';
                if (pageTitleEl) pageTitleEl.textContent = title;
                try { document.title = `${title} - Trading Signals`; } catch (e) { }
                this.updateControlButtonsState();
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        updateControlButtonsState() {
            const hasId = !!this.currentWorkflowId;
            const stopBtn = document.getElementById('stopRunBtn');
            const restartBtn = document.getElementById('restartRunBtn');
            const historyBtn = document.getElementById('historyBtn');
            const applyBtn = document.getElementById('applyWorkerBtn');
            const runBtn = document.querySelector('button[onclick="workflowBuilder.runWorkflow()"]');

            // Debug logging
            console.log('updateControlButtonsState:', {
                hasId,
                currentRunStatus: this.currentRunStatus,
                currentWorkflowId: this.currentWorkflowId
            });

            // Run button: disable when running
            if (runBtn) {
                const canRun = hasId && this.currentRunStatus !== 'running';
                runBtn.disabled = !canRun;
                runBtn.classList.toggle('opacity-50', runBtn.disabled);
                runBtn.classList.toggle('cursor-not-allowed', runBtn.disabled);
                console.log('Run button:', { canRun, disabled: runBtn.disabled });
            }

            // Stop button: enable when workflow exists and has a run (can stop active run)
            if (stopBtn) {
                const canStop = hasId && (this.currentRunStatus === 'running' || this.justStartedRun || this.currentRunId);
                stopBtn.disabled = !canStop;
                stopBtn.classList.toggle('opacity-50', stopBtn.disabled);
                stopBtn.classList.toggle('cursor-not-allowed', stopBtn.disabled);
                console.log('Stop button:', { canStop, disabled: stopBtn.disabled, status: this.currentRunStatus, justStarted: this.justStartedRun, runId: this.currentRunId });
            }

            // Restart button: enable when not running
            if (restartBtn) {
                const canRestart = hasId && ['error', 'success', 'stopped', 'idle'].includes(this.currentRunStatus);
                restartBtn.disabled = !canRestart;
                restartBtn.classList.toggle('opacity-50', restartBtn.disabled);
                restartBtn.classList.toggle('cursor-not-allowed', restartBtn.disabled);
            }

            // History and Apply buttons: enable when workflow exists
            if (historyBtn) {
                historyBtn.disabled = !hasId;
                historyBtn.classList.toggle('opacity-50', historyBtn.disabled);
                historyBtn.classList.toggle('cursor-not-allowed', historyBtn.disabled);
            }
            if (applyBtn) {
                applyBtn.disabled = !hasId;
                applyBtn.classList.toggle('opacity-50', applyBtn.disabled);
                applyBtn.classList.toggle('cursor-not-allowed', applyBtn.disabled);
            }
        }

        // Status polling
        startStatusPolling() {
            try {
                // Avoid duplicate intervals - more robust check
                if (this.statusPollInterval) {
                    console.log('Status polling already active, stopping first');
                    this.stopStatusPolling();
                }

                if (!this.currentWorkflowId) {
                    console.log('No workflow ID, skipping status polling');
                    return;
                }

                // Initial fetch
                this.refreshWorkflowRunStatus();

                // Set interval with error handling
                this.statusPollInterval = setInterval(() => {
                    try {
                        this.refreshWorkflowRunStatus();
                    } catch (e) {
                        console.warn('Status polling error:', e);
                    }
                }, this.statusPollMs);

                console.log('Status polling started for workflow:', this.currentWorkflowId);
            } catch (e) {
                console.warn('startStatusPolling failed', e);
            }
        }

        stopStatusPolling() {
            if (this.statusPollInterval) {
                clearInterval(this.statusPollInterval);
                this.statusPollInterval = null;
            }
        }

        async refreshWorkflowRunStatus() {
            try {
                if (!this.currentWorkflowId) return;
                if (document.visibilityState && document.visibilityState !== 'visible') return;

                const res = await fetch(`/api/workflow/status/${this.currentWorkflowId}`);

                // Check if response is ok
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                const status = (data && data.status) || 'idle';

                // Update run ID from server response
                if (data && (data.run_id || data.job_id)) {
                    this.currentRunId = data.run_id || data.job_id;
                }

                this.currentRunStatus = status;

                // Clear justStartedRun flag when we get real status from server
                // Only clear if status is not 'running' (workflow completed or failed)
                if (this.justStartedRun && status !== 'running' && status !== 'idle') {
                    this.justStartedRun = false;
                }

                // Update UI
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                if (!dot || !text) return;

                dot.style.background = status === 'running' ? '#16a34a' : status === 'error' ? '#dc2626' : status === 'success' ? '#2563eb' : '#9ca3af';
                text.textContent = status === 'running' ? 'Running' : status === 'error' ? 'Error' : status === 'success' ? 'Success' : 'Ready';

                // Update button states
                this.updateControlButtonsState();

                console.log('Status updated:', { status, runId: this.currentRunId, workflowId: this.currentWorkflowId });
            } catch (e) {
                console.warn('Status polling error:', e);
                // Don't update UI on network errors to avoid flickering
                if (e.name !== 'TypeError' || !e.message.includes('fetch')) {
                    const dot = document.getElementById('statusDot');
                    const text = document.getElementById('statusText');
                    if (dot && text) {
                        dot.style.background = '#9ca3af';
                        text.textContent = 'Ready';
                    }
                }
            }
        }

        updateSaveUIState() {
            try {
                const saveBtn = document.querySelector('button[onclick="openSaveModal()"]');
                if (!saveBtn) return;
                if (this.currentWorkflowId) {
                    saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i>Update';
                    saveBtn.className = 'px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm';
                } else {
                    saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i>Save';
                    saveBtn.className = 'px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm';
                }
            } catch (e) {
                console.warn('updateSaveUIState failed', e);
            }
        }

        // Expandable Timeframe Methods
        toggleTimeframeExpansion(tf) {
            const expandedDiv = document.getElementById(`expanded-${tf}`);
            const chevron = document.getElementById(`chevron-${tf}`);

            if (expandedDiv && chevron) {
                const isHidden = expandedDiv.classList.contains('hidden');

                if (isHidden) {
                    expandedDiv.classList.remove('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    expandedDiv.classList.add('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                }
            }
        }

        editTimeframeThresholds(tf) {
            // Open Zone Thresholds Editor for specific timeframe
            console.log(`Opening Zone Thresholds Editor for ${tf}`);
            // This will open the existing Zone Thresholds Editor but focus on the specific TF
            openZoneThresholdsEditor(tf);
        }

        copyTimeframeDown(tf) {
            const timeframes = ['1m', '2m', '5m', '15m', '30m', '1h', '4h'];
            const currentIndex = timeframes.indexOf(tf);
            const nextTf = timeframes[currentIndex + 1];

            if (nextTf) {
                // Copy values from current TF to next TF
                const currentFast = document.querySelector(`input[data-tf="${tf}"].macd-fast`)?.value;
                const currentSlow = document.querySelector(`input[data-tf="${tf}"].macd-slow`)?.value;
                const currentSignal = document.querySelector(`input[data-tf="${tf}"].macd-signal`)?.value;
                const currentMinConf = document.querySelector(`input[data-tf="${tf}"].macd-minconf`)?.value;
                const currentZone = document.querySelector(`select[data-tf="${tf}"].macd-zone`)?.value;

                if (currentFast) document.querySelector(`input[data-tf="${nextTf}"].macd-fast`).value = currentFast;
                if (currentSlow) document.querySelector(`input[data-tf="${nextTf}"].macd-slow`).value = currentSlow;
                if (currentSignal) document.querySelector(`input[data-tf="${nextTf}"].macd-signal`).value = currentSignal;
                if (currentMinConf) document.querySelector(`input[data-tf="${nextTf}"].macd-minconf`).value = currentMinConf;
                if (currentZone) document.querySelector(`select[data-tf="${nextTf}"].macd-zone`).value = currentZone;

                // Update display values
                this.updateTimeframeDisplay(nextTf);

                this.showNotification(`Copied ${tf} settings to ${nextTf}`, 'success');
            }
        }

        resetTimeframeToDefault(tf) {
            // Reset to default values
            const fastInput = document.querySelector(`input[data-tf="${tf}"].macd-fast`);
            const slowInput = document.querySelector(`input[data-tf="${tf}"].macd-slow`);
            const signalInput = document.querySelector(`input[data-tf="${tf}"].macd-signal`);
            const minConfInput = document.querySelector(`input[data-tf="${tf}"].macd-minconf`);
            const zoneSelect = document.querySelector(`select[data-tf="${tf}"].macd-zone`);

            if (fastInput) fastInput.value = '12';
            if (slowInput) slowInput.value = '26';
            if (signalInput) signalInput.value = '9';
            if (minConfInput) minConfInput.value = '0.6';
            if (zoneSelect) zoneSelect.value = 'VN Zone V1';

            this.updateTimeframeDisplay(tf);
            this.showNotification(`Reset ${tf} to default values`, 'info');
        }

        saveTimeframeConfig(tf) {
            // Save current timeframe configuration
            const config = {
                fast: document.querySelector(`input[data-tf="${tf}"].macd-fast`)?.value || '12',
                slow: document.querySelector(`input[data-tf="${tf}"].macd-slow`)?.value || '26',
                signal: document.querySelector(`input[data-tf="${tf}"].macd-signal`)?.value || '9',
                minConf: document.querySelector(`input[data-tf="${tf}"].macd-minconf`)?.value || '0.6',
                zone: document.querySelector(`select[data-tf="${tf}"].macd-zone`)?.value || 'VN Zone V1'
            };

            // Update display
            this.updateTimeframeDisplay(tf);

            // Auto-save to node properties
            this.autoSaveNodeConfig();

            this.showNotification(`Saved ${tf} configuration`, 'success');
        }

        updateTimeframeDisplay(tf) {
            const fastValue = document.querySelector(`input[data-tf="${tf}"].macd-fast`)?.value || '12';
            const slowValue = document.querySelector(`input[data-tf="${tf}"].macd-slow`)?.value || '26';
            const signalValue = document.querySelector(`input[data-tf="${tf}"].macd-signal`)?.value || '9';
            const minConfValue = document.querySelector(`input[data-tf="${tf}"].macd-minconf`)?.value || '0.6';
            const zoneValue = document.querySelector(`select[data-tf="${tf}"].macd-zone`)?.value || 'VN Zone V1';

            // Update display values in main row
            const fastDisplay = document.querySelector(`[data-tf="${tf}"] .macd-fast-value`);
            const slowDisplay = document.querySelector(`[data-tf="${tf}"] .macd-slow-value`);
            const signalDisplay = document.querySelector(`[data-tf="${tf}"] .macd-signal-value`);
            const minConfDisplay = document.querySelector(`[data-tf="${tf}"] .macd-minconf-value`);
            const zoneDisplay = document.querySelector(`[data-tf="${tf}"] .macd-zone-value`);

            if (fastDisplay) fastDisplay.textContent = fastValue;
            if (slowDisplay) slowDisplay.textContent = slowValue;
            if (signalDisplay) signalDisplay.textContent = signalValue;
            if (minConfDisplay) minConfDisplay.textContent = minConfValue;
            if (zoneDisplay) zoneDisplay.textContent = zoneValue;
        }

        // Matrix Table Methods
        autoSaveTimeframe(tf) {
            console.log(`Auto-saving timeframe ${tf}`);
            // Collect all data for this timeframe
            const timeframeData = this.collectTimeframeData(tf);

            // Auto-save to node properties
            this.autoSaveNodeConfig();

            // Show subtle indicator
            this.showAutoSaveIndicator(`${tf} auto-saved`);
        }

        collectTimeframeData(tf) {
            const data = {
                macd: {
                    fast: document.querySelector(`input[data-tf="${tf}"].macd-fast`)?.value || '12',
                    slow: document.querySelector(`input[data-tf="${tf}"].macd-slow`)?.value || '26',
                    signal: document.querySelector(`input[data-tf="${tf}"].macd-signal`)?.value || '9'
                },
                minConf: document.querySelector(`input[data-tf="${tf}"].macd-minconf`)?.value || '0.6',
                zoneThresholds: {},
                barsMomentums: {}
            };

            // Collect zone thresholds
            const zoneInputs = document.querySelectorAll(`input[data-tf="${tf}"].zone-threshold`);
            zoneInputs.forEach(input => {
                const type = input.dataset.type;
                const zone = input.dataset.zone;
                if (!data.zoneThresholds[type]) data.zoneThresholds[type] = {};
                data.zoneThresholds[type][zone] = input.value;
            });

            // Collect bars momentums
            const barsInputs = document.querySelectorAll(`input[data-tf="${tf}"].bars-momentum`);
            barsInputs.forEach(input => {
                const momentum = input.dataset.momentum;
                data.barsMomentums[momentum] = input.value;
            });

            return data;
        }

        saveAllTimeframes() {
            console.log('Saving all timeframes...');
            const allData = {};

            ['4h', '1h', '30m', '15m', '5m', '2m', '1m'].forEach(tf => {
                allData[tf] = this.collectTimeframeData(tf);
            });

            // Save to node properties
            this.autoSaveNodeConfig();

            // Show success message
            this.showNotification('All timeframes saved successfully!', 'success');
        }

        resetAllToDefault() {
            if (!confirm('Are you sure you want to reset all timeframes to default values?')) {
                return;
            }

            ['4h', '1h', '30m', '15m', '5m', '2m', '1m'].forEach(tf => {
                // Reset MACD parameters
                const fastInput = document.querySelector(`input[data-tf="${tf}"].macd-fast`);
                const slowInput = document.querySelector(`input[data-tf="${tf}"].macd-slow`);
                const signalInput = document.querySelector(`input[data-tf="${tf}"].macd-signal`);
                const minConfInput = document.querySelector(`input[data-tf="${tf}"].macd-minconf`);

                if (fastInput) fastInput.value = '12';
                if (slowInput) slowInput.value = '26';
                if (signalInput) signalInput.value = '9';
                if (minConfInput) minConfInput.value = '0.6';

                // Reset zone thresholds
                const zoneInputs = document.querySelectorAll(`input[data-tf="${tf}"].zone-threshold`);
                zoneInputs.forEach(input => {
                    const type = input.dataset.type;
                    const zone = input.dataset.zone;
                    input.value = this.getDefaultZoneThreshold(tf, type, zone);
                });

                // Reset bars momentums
                const barsInputs = document.querySelectorAll(`input[data-tf="${tf}"].bars-momentum`);
                barsInputs.forEach(input => {
                    const momentum = input.dataset.momentum;
                    input.value = this.getDefaultBarsMomentum(tf, momentum);
                });
            });

            this.showNotification('All timeframes reset to default values', 'info');
        }

        // Load real data from database for matrix table
        async loadMatrixDataFromDB(properties) {
            try {
                // First try to load from saved node properties
                if (properties.matrixData) {
                    console.log('Loading matrix data from node properties');
                    this.populateMatrixTableFromNodeProperties(properties.matrixData);
                    return;
                }

                const templateId = properties.templateId || document.getElementById('templateId')?.value;
                if (!templateId) {
                    console.log('No template ID, using default values');
                    return;
                }

                console.log('Loading matrix data from DB for template:', templateId);

                const response = await fetch(`/api/threshold/template-values?strategy=MACD&templateId=${encodeURIComponent(templateId)}&market=VN`);
                const data = await response.json();

                if (data && data.timeframes) {
                    console.log('Loaded DB data:', data);
                    this.populateMatrixTableFromDB(data);
                } else {
                    console.log('No DB data found, using default values');
                }
            } catch (error) {
                console.error('Error loading matrix data from DB:', error);
                this.showNotification('Failed to load data from database, using defaults', 'warning');
            }
        }

        populateMatrixTableFromNodeProperties(matrixData) {
            ['4h', '1h', '30m', '15m', '5m', '2m', '1m'].forEach(tf => {
                const tfData = matrixData[tf];
                if (!tfData) return;

                // Update MACD parameters
                if (tfData.macd) {
                    const fastInput = document.querySelector(`input[data-tf="${tf}"].macd-fast`);
                    const slowInput = document.querySelector(`input[data-tf="${tf}"].macd-slow`);
                    const signalInput = document.querySelector(`input[data-tf="${tf}"].macd-signal`);

                    if (fastInput && tfData.macd.fast) fastInput.value = tfData.macd.fast;
                    if (slowInput && tfData.macd.slow) slowInput.value = tfData.macd.slow;
                    if (signalInput && tfData.macd.signal) signalInput.value = tfData.macd.signal;
                }

                // Update MinConf
                const minConfInput = document.querySelector(`input[data-tf="${tf}"].macd-minconf`);
                if (minConfInput && tfData.minConf) minConfInput.value = tfData.minConf;

                // Update zone thresholds
                if (tfData.zoneThresholds) {
                    const zoneInputs = document.querySelectorAll(`input[data-tf="${tf}"].zone-threshold`);
                    zoneInputs.forEach(input => {
                        const type = input.dataset.type;
                        const zone = input.dataset.zone;
                        const value = tfData.zoneThresholds[type]?.[zone];
                        if (value) input.value = value;
                    });
                }

                // Update bars momentums
                if (tfData.barsMomentums) {
                    const barsInputs = document.querySelectorAll(`input[data-tf="${tf}"].bars-momentum`);
                    barsInputs.forEach(input => {
                        const momentum = input.dataset.momentum;
                        const value = tfData.barsMomentums[momentum];
                        if (value) input.value = value;
                    });
                }
            });

            this.showNotification('Matrix data loaded from node properties', 'success');
        }

        populateMatrixTableFromDB(data) {
            const tfMap = new Map(data.timeframes.map(x => [x.tf, x]));

            ['4h', '1h', '30m', '15m', '5m', '2m', '1m'].forEach(tf => {
                const item = tfMap.get(tf);
                if (!item) return;

                // Update MACD parameters from DB
                const macdParams = item.params?.macd || {};
                const fastInput = document.querySelector(`input[data-tf="${tf}"].macd-fast`);
                const slowInput = document.querySelector(`input[data-tf="${tf}"].macd-slow`);
                const signalInput = document.querySelector(`input[data-tf="${tf}"].macd-signal`);
                const minConfInput = document.querySelector(`input[data-tf="${tf}"].macd-minconf`);

                if (fastInput && macdParams.fast) fastInput.value = macdParams.fast;
                if (slowInput && macdParams.slow) slowInput.value = macdParams.slow;
                if (signalInput && macdParams.signal) signalInput.value = macdParams.signal;
                if (minConfInput && macdParams.minConf) minConfInput.value = macdParams.minConf;

                // Update zone thresholds from DB
                const zoneThresholds = item.params?.zone_thresholds || {};
                const zoneInputs = document.querySelectorAll(`input[data-tf="${tf}"].zone-threshold`);
                zoneInputs.forEach(input => {
                    const type = input.dataset.type;
                    const zone = input.dataset.zone;
                    const dbValue = zoneThresholds[type.toUpperCase()]?.[zone];
                    if (dbValue) {
                        input.value = dbValue;
                    }
                });

                // Update bars momentums from DB
                const barsMomentums = item.params?.bars_momentums || {};
                const barsInputs = document.querySelectorAll(`input[data-tf="${tf}"].bars-momentum`);
                barsInputs.forEach(input => {
                    const momentum = input.dataset.momentum;
                    const dbValue = barsMomentums[momentum];
                    if (dbValue) {
                        input.value = dbValue;
                    }
                });
            });

            this.showNotification('Matrix data loaded from database', 'success');
        }

        // Public method to load data from database (called by button)
        async loadFromDatabase() {
            const templateId = document.getElementById('templateId')?.value;
            if (!templateId) {
                this.showNotification('Please select a template first', 'warning');
                return;
            }

            try {
                await this.loadMatrixDataFromDB({ templateId });
            } catch (error) {
                this.showNotification('Failed to load from database', 'error');
            }
        }

        async saveWorkflow() {
            const workflowName = prompt('Enter workflow name:', 'My Trading Workflow');
            if (!workflowName) return;

            try {
                // Validate data before saving
                const nodes = Array.from(this.nodes.values());
                const connections = this.connections || [];
                const properties = Object.fromEntries(this.nodeProperties || new Map());

                console.log('Saving workflow with data:', {
                    nodesCount: nodes.length,
                    connectionsCount: connections.length,
                    propertiesCount: Object.keys(properties).length
                });

                const workflow = {
                    name: workflowName,
                    description: 'Trading workflow created with Simple Workflow Builder',
                    nodes: nodes,
                    connections: connections,
                    properties: properties,
                    metadata: {
                        created: new Date().toISOString(),
                        version: '1.0.0',
                        builder: 'Simple Workflow Builder'
                    }
                };

                const response = await fetch('/api/workflow/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(workflow)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Workflow saved successfully! ID: ${result.workflow_id}`);
                    console.log('Workflow saved:', result);
                } else {
                    alert(`Error saving workflow: ${result.error}`);
                }
            } catch (error) {
                console.error('Error saving workflow:', error);
                alert(`Error saving workflow: ${error.message}`);
            }
        }

        async runWorkflow() {
            if (this.nodes.size === 0) {
                alert('Please add some nodes to the workflow');
                return;
            }

            // Disable Run button immediately
            this.currentRunStatus = 'running';
            this.justStartedRun = true; // Set flag
            console.log('runWorkflow: Set status to running, currentWorkflowId =', this.currentWorkflowId);
            this.updateControlButtonsState();

            try {
                let workflowId = this.currentWorkflowId;
                console.log('runWorkflow: currentWorkflowId =', workflowId);

                // If no current workflow, save first
                if (!workflowId) {
                    const workflowName = prompt('Enter workflow name to save and run:', 'Test Workflow');
                    if (!workflowName) {
                        // Reset status if user cancels
                        this.currentRunStatus = 'idle';
                        this.updateControlButtonsState();
                        return;
                    }

                    // Validate data before saving
                    const nodes = Array.from(this.nodes.values());
                    const connections = this.connections || [];
                    const properties = Object.fromEntries(this.nodeProperties || new Map());

                    const workflow = {
                        name: workflowName,
                        description: 'Test workflow execution',
                        nodes: nodes,
                        connections: connections,
                        properties: properties,
                        metadata: {
                            created: new Date().toISOString(),
                            version: '1.0.0',
                            builder: 'Simple Workflow Builder'
                        }
                    };

                    // Save workflow
                    const saveResponse = await fetch('/api/workflow/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(workflow)
                    });

                    const saveResult = await saveResponse.json();

                    if (!saveResult.success) {
                        alert(`Error saving workflow: ${saveResult.error}`);
                        return;
                    }

                    workflowId = saveResult.workflow_id;
                    // Update current workflow ID and start polling
                    this.currentWorkflowId = workflowId;
                    this.currentWorkflowMeta = { name: workflowName, description: workflow.description };
                    this.updateStatus();
                    this.startStatusPolling();
                }

                // Execute workflow
                const executeResponse = await fetch(`/api/workflow/execute/${workflowId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const executeResult = await executeResponse.json();

                if (executeResult.success) {
                    // Store the new run ID
                    this.currentRunId = executeResult.run_id;
                    this.currentRunStatus = 'running'; // Set status immediately

                    this.showNotification(`Workflow executed successfully! Run ID: ${executeResult.run_id}`, 'success');
                    console.log('Workflow execution result:', executeResult);

                    // Update UI immediately
                    this.updateControlButtonsState();
                    this.updateStatus();

                    // Ask if user wants to deploy to worker
                    const deploy = confirm('Workflow executed successfully! Do you want to deploy it to a worker for continuous execution?');
                    if (deploy) {
                        this.openApplyWorkerModal();
                    }

                    // Refresh status from server after a longer delay to allow user to see running state
                    setTimeout(() => {
                        this.refreshWorkflowRunStatus();
                    }, 3000);
                } else {
                    this.showNotification(`Error executing workflow: ${executeResult.error}`, 'error');
                    // Reset status on error
                    this.currentRunStatus = 'error';
                    this.updateControlButtonsState();
                }
            } catch (error) {
                console.error('Error running workflow:', error);
                this.showNotification(`Error running workflow: ${error.message}`, 'error');
                // Reset status on error
                this.currentRunStatus = 'error';
                this.updateControlButtonsState();
            }
        }

        clearWorkflow() {
            if (confirm('Are you sure you want to clear the workflow?')) {
                try {
                    if (this.nodes) {
                        this.nodes.clear();
                    }
                    this.connections = [];
                    if (this.nodeProperties) {
                        this.nodeProperties.clear();
                    }
                    // Clear canvas with proper cleanup
                    if (this.canvas) {
                        // Remove all child elements to clean up event listeners
                        while (this.canvas.firstChild) {
                            this.canvas.removeChild(this.canvas.firstChild);
                        }
                    }

                    // Reset state
                    this.currentWorkflowId = null;
                    this.currentRunId = null;
                    this.currentRunStatus = 'idle';
                    this.currentWorkflowMeta = null;
                    this.selectedNode = null;

                    // Stop status polling
                    this.stopStatusPolling();

                    this.updateStatus();
                    this.updateControlButtonsState();
                    this.updateSaveUIState();
                    console.log('Workflow cleared successfully');
                    this.showNotification('Workflow cleared successfully', 'success');
                } catch (error) {
                    console.error('Error clearing workflow:', error);
                    this.showNotification(`Error clearing workflow: ${error.message}`, 'error');
                }
            }
        }

        loadWorkflowData(workflow) {
            try {
                // Validate workflow data
                if (!workflow) {
                    throw new Error('Workflow data is null or undefined');
                }

                // Load nodes - ensure nodes is an array
                const nodes = workflow.nodes || [];
                if (!Array.isArray(nodes)) {
                    throw new Error('Workflow nodes is not an array');
                }

                this.nodeCounter = 0;

                nodes.forEach(nodeData => {
                    if (!nodeData || !nodeData.id) {
                        console.warn('Invalid node data:', nodeData);
                        return;
                    }

                    const nodeId = nodeData.id;
                    const node = {
                        id: nodeId,
                        type: nodeData.type || 'unknown',
                        x: nodeData.x || 100,
                        y: nodeData.y || 100,
                        properties: (workflow.properties && workflow.properties[nodeId]) || this.getDefaultProperties(nodeData.type || 'unknown')
                    };

                    this.nodes.set(nodeId, node);
                    this.renderNode(node);

                    // Update counter - more robust parsing
                    const nodeNumMatch = nodeId.match(/node_(\d+)/);
                    if (nodeNumMatch) {
                        const nodeNum = parseInt(nodeNumMatch[1]);
                        if (!isNaN(nodeNum) && nodeNum > this.nodeCounter) {
                            this.nodeCounter = nodeNum;
                        }
                    }
                });

                // Load connections - ensure connections is an array
                const connections = workflow.connections || [];
                if (!Array.isArray(connections)) {
                    console.warn('Workflow connections is not an array, using empty array');
                    this.connections = [];
                } else {
                    this.connections = connections;
                }

                this.updateConnections();
                // Set current workflow identity/meta for controls and polling
                this.currentWorkflowId = workflow.id || this.currentWorkflowId;
                console.log('loadWorkflowData: Set currentWorkflowId =', this.currentWorkflowId);
                this.currentWorkflowMeta = {
                    name: workflow.name || (this.currentWorkflowMeta && this.currentWorkflowMeta.name) || '',
                    description: workflow.description || (this.currentWorkflowMeta && this.currentWorkflowMeta.description) || ''
                };
                this.updateStatus();
                this.updateControlButtonsState();
                this.updateSaveUIState && this.updateSaveUIState();
                this.startStatusPolling();

                // Save as last edited workflow
                if (workflow.id) {
                    this.saveLastWorkflowId(workflow.id);
                }

                console.log('Workflow data loaded successfully:', {
                    nodesCount: nodes.length,
                    connectionsCount: this.connections.length,
                    workflowName: workflow.name
                });
            } catch (error) {
                console.error('Error loading workflow data:', error);
                this.showNotification(`Error loading workflow data: ${error.message}`, 'error');
            }
        }

        showNotification(message, type = 'info', title = null) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            const icons = {
                success: 'fas fa-check',
                error: 'fas fa-times',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            const titles = {
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                info: 'Info'
            };

            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${icons[type]}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title || titles[type]}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(notification);

            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Last Workflow Management
        saveLastWorkflowId(workflowId) {
            try {
                localStorage.setItem('workflowBuilder_lastWorkflowId', workflowId);
                console.log('Saved last workflow ID:', workflowId);
            } catch (error) {
                console.warn('Failed to save last workflow ID:', error);
            }
        }

        getLastWorkflowId() {
            try {
                return localStorage.getItem('workflowBuilder_lastWorkflowId');
            } catch (error) {
                console.warn('Failed to get last workflow ID:', error);
                return null;
            }
        }

        async autoLoadLastWorkflow() {
            try {
                const lastWorkflowId = this.getLastWorkflowId();
                if (!lastWorkflowId) {
                    console.log('No last workflow found, starting with empty canvas');
                    return;
                }

                console.log('Auto-loading last workflow:', lastWorkflowId);

                // Show loading indicator
                this.showNotification('Loading last edited workflow...', 'info');

                const response = await fetch(`/api/workflow/load/${lastWorkflowId}`);
                const result = await response.json();

                if (result.success && result.workflow) {
                    this.loadWorkflowData(result.workflow);
                    this.showNotification(`Auto-loaded: "${result.workflow.name}"`, 'success');
                } else {
                    console.log('Last workflow not found or failed to load, starting with empty canvas');
                    this.showNotification('Last workflow not found, starting with empty canvas', 'info');
                }
            } catch (error) {
                console.error('Error auto-loading last workflow:', error);
                this.showNotification('Failed to auto-load last workflow', 'warning');
            }
        }

        // Zoom and Pan methods
        zoomIn() {
            this.zoomLevel = Math.min(this.zoomLevel * 1.05, 3);
            this.applyTransform();
        }

        zoomOut() {
            this.zoomLevel = Math.max(this.zoomLevel / 1.05, 0.3);
            this.applyTransform();
        }

        resetZoom() {
            this.zoomLevel = 1;
            this.panX = 0;
            this.panY = 0;
            this.applyTransform();
        }

        togglePan() {
            this.isPanning = !this.isPanning;
            const canvas = this.canvas;
            const panButton = document.querySelector('.control-button[onclick="togglePan()"] i');

            if (this.isPanning) {
                canvas.classList.add('zoomed');
                panButton.className = 'fas fa-hand-rock text-blue-600';
                canvas.style.cursor = 'grab';
            } else {
                canvas.classList.remove('zoomed');
                panButton.className = 'fas fa-hand-paper text-gray-600';
                canvas.style.cursor = 'default';
            }
        }

        applyTransform() {
            const canvas = this.canvas;
            // Apply zoom and pan like n8n - scale everything together
            canvas.style.transform = `translate(${this.panX}px, ${this.panY}px) scale(${this.zoomLevel})`;
            canvas.style.transformOrigin = '0 0';

            // Remove individual node transforms - let them scale with canvas
            this.nodes.forEach(node => {
                const nodeElement = document.getElementById(`node-${node.id}`);
                if (nodeElement) {
                    nodeElement.style.transform = '';
                }
            });
        }

        startPan(e) {
            if (!this.isPanning) return;

            this.panStart = { x: e.clientX - this.panX, y: e.clientY - this.panY };
            this.canvas.style.cursor = 'grabbing';

            document.addEventListener('mousemove', this.handlePan.bind(this));
            document.addEventListener('mouseup', this.endPan.bind(this));
        }

        handlePan(e) {
            if (!this.isPanning) return;

            this.panX = e.clientX - this.panStart.x;
            this.panY = e.clientY - this.panStart.y;
            this.applyTransform();
        }

        endPan() {
            if (!this.isPanning) return;

            this.canvas.style.cursor = 'grab';
            document.removeEventListener('mousemove', this.handlePan);
            document.removeEventListener('mouseup', this.endPan);
        }

        // Advanced Features
        saveToHistory() {
            const state = {
                nodes: new Map(this.nodes),
                connections: [...this.connections],
                nodeProperties: new Map(this.nodeProperties),
                timestamp: Date.now()
            };

            // Remove future history if we're not at the end
            if (this.historyIndex < this.history.length - 1) {
                this.history = this.history.slice(0, this.historyIndex + 1);
            }

            this.history.push(state);
            this.historyIndex++;

            // Limit history size
            if (this.history.length > this.maxHistorySize) {
                this.history.shift();
                this.historyIndex--;
            }
        }

        undo() {
            if (this.historyIndex > 0) {
                this.historyIndex--;
                this.restoreState(this.history[this.historyIndex]);
                this.showNotification('Undo successful', 'success');
            } else {
                this.showNotification('Nothing to undo', 'warning');
            }
        }

        redo() {
            if (this.historyIndex < this.history.length - 1) {
                this.historyIndex++;
                this.restoreState(this.history[this.historyIndex]);
                this.showNotification('Redo successful', 'success');
            } else {
                this.showNotification('Nothing to redo', 'warning');
            }
        }

        restoreState(state) {
            // Clear current state
            this.clearWorkflow();

            // Restore nodes
            this.nodes = new Map(state.nodes);
            this.connections = [...state.connections];
            this.nodeProperties = new Map(state.nodeProperties);

            // Re-render everything
            this.nodes.forEach(node => this.renderNode(node));
            this.connections.forEach(conn => this.drawConnection(conn));
            this.updateStatus();
        }

        copySelected() {
            if (!this.selectedNode) {
                this.showNotification('No node selected', 'warning');
                return;
            }

            const node = this.nodes.get(this.selectedNode);
            if (node) {
                this.clipboard = {
                    type: node.type,
                    properties: { ...node.properties },
                    x: node.x + 50, // Offset for paste
                    y: node.y + 50
                };
                this.showNotification('Node copied to clipboard', 'success');
            }
        }

        paste() {
            if (!this.clipboard) {
                this.showNotification('Nothing to paste', 'warning');
                return;
            }

            this.saveToHistory();
            const node = this.createNode(this.clipboard.type, this.clipboard.x, this.clipboard.y);
            node.properties = { ...this.clipboard.properties };
            this.nodeProperties.set(node.id, node.properties);
            this.renderNode(node);
            this.updateStatus();
            this.showNotification('Node pasted', 'success');
        }

        validateWorkflow() {
            const errors = [];
            const warnings = [];

            // Check for required nodes
            const hasSymbol = Array.from(this.nodes.values()).some(n => n.type === 'symbol');
            const hasOutput = Array.from(this.nodes.values()).some(n => n.type === 'output' || n.type === 'alert');

            if (!hasSymbol) {
                errors.push('Workflow must have at least one Symbol node');
            }

            if (!hasOutput) {
                errors.push('Workflow must have at least one Output or Alert node');
            }

            // Check for isolated nodes
            const connectedNodes = new Set();
            this.connections.forEach(conn => {
                connectedNodes.add(conn.from.nodeId);
                connectedNodes.add(conn.to.nodeId);
            });

            this.nodes.forEach((node, nodeId) => {
                if (!connectedNodes.has(nodeId) && node.type !== 'symbol') {
                    warnings.push(`Node "${node.type}" is not connected`);
                }
            });

            // Check for cycles
            if (this.hasCycles()) {
                errors.push('Workflow contains cycles');
            }

            // Display results
            if (errors.length === 0 && warnings.length === 0) {
                this.showNotification('Workflow validation passed', 'success');
            } else {
                let message = '';
                if (errors.length > 0) {
                    message += 'Errors: ' + errors.join(', ') + '. ';
                }
                if (warnings.length > 0) {
                    message += 'Warnings: ' + warnings.join(', ') + '.';
                }
                this.showNotification(message, errors.length > 0 ? 'error' : 'warning');
            }
        }

        hasCycles() {
            const visited = new Set();
            const recursionStack = new Set();

            const dfs = (nodeId) => {
                visited.add(nodeId);
                recursionStack.add(nodeId);

                const outgoingConnections = this.connections.filter(conn => conn.from.nodeId === nodeId);
                for (const conn of outgoingConnections) {
                    if (!visited.has(conn.to.nodeId)) {
                        if (dfs(conn.to.nodeId)) return true;
                    } else if (recursionStack.has(conn.to.nodeId)) {
                        return true;
                    }
                }

                recursionStack.delete(nodeId);
                return false;
            };

            for (const nodeId of this.nodes.keys()) {
                if (!visited.has(nodeId)) {
                    if (dfs(nodeId)) return true;
                }
            }

            return false;
        }

        // Node Configuration Modal
        openNodeConfiguration(nodeId) {
            const node = this.nodes.get(nodeId);
            if (!node) return;

            const modal = this.createConfigurationModal(node);
            this.showModal(modal);

            // Initialize dynamic selects (DB templates) after modal is mounted
            try {
                if (node.type === 'vn-macd-7tf') {
                    this.initializeTemplateSelects('macd', node.properties || {});
                    // Load real data from DB for matrix table
                    this.loadMatrixDataFromDB(node.properties || {});
                } else if (node.type === 'vn-sma-7tf') {
                    this.initializeTemplateSelects('sma', node.properties || {});
                }
            } catch (e) {
                console.warn('Template init error:', e);
            }
        }

        createConfigurationModal(node) {
            const nodeInfo = this.getNodeInfo(node.type);
            const properties = node.properties || {};

            let modalContent = '';

            switch (node.type) {
                case 'symbol':
                    modalContent = this.createSymbolConfigurationForm(node, properties);
                    break;
                case 'vn-macd-7tf':
                    modalContent = this.createVNMACD7TFConfigurationForm(node, properties);
                    break;
                case 'vn-sma-7tf':
                    modalContent = this.createVNSMA7TFConfigurationForm(node, properties);
                    break;
                case 'macd':
                    modalContent = this.createMACDConfigurationForm(node, properties);
                    break;
                case 'macd-multi':
                    modalContent = this.createMACDMultiConfigurationForm(node, properties);
                    break;
                case 'sma':
                    modalContent = this.createSMAConfigurationForm(node, properties);
                    break;
                case 'rsi':
                    modalContent = this.createRSIConfigurationForm(node, properties);
                    break;
                case 'bollinger':
                    modalContent = this.createBollingerConfigurationForm(node, properties);
                    break;
                case 'multi-indicator':
                    modalContent = this.createMultiIndicatorConfigurationForm(node, properties);
                    break;
                case 'flexible-multi-indicator':
                    modalContent = createFlexibleMultiIndicatorConfigurationForm(node, properties);
                    break;
                case 'data-source':
                    modalContent = this.createDataSourceConfigurationForm(node, properties);
                    break;
                case 'condition':
                    modalContent = this.createConditionConfigurationForm(node, properties);
                    break;
                case 'aggregation':
                    modalContent = this.createAggregationConfigurationForm(node, properties);
                    break;
                case 'filter':
                    modalContent = this.createFilterConfigurationForm(node, properties);
                    break;
                case 'output':
                    modalContent = this.createOutputConfigurationForm(node, properties);
                    break;
                case 'alert':
                    modalContent = this.createAlertConfigurationForm(node, properties);
                    break;
                default:
                    modalContent = this.createDefaultConfigurationForm(node, properties);
            }

            return `
                <div class="modal-overlay" id="nodeConfigModal" data-node-id="${node.id}">
                    <div class="modal" style="max-width: 1100px; width: 95%">
                        <div class="modal-header">
                            <h3 class="modal-title">
                                <i class="${nodeInfo.icon} mr-2"></i>
                                Configure ${nodeInfo.name}
                            </h3>
                            <button class="modal-close" onclick="closeNodeConfigModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${modalContent}
                        </div>
                        <div class="modal-footer">
                            <button onclick="closeNodeConfigModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                            <button onclick="saveNodeConfiguration('${node.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Save Configuration
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        showModal(modalHtml) {
            // Remove existing modal if any
            const existingModal = document.getElementById('nodeConfigModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            // Try to find the last inserted modal overlay and activate it
            const overlays = document.querySelectorAll('.modal-overlay');
            const modalOverlay = overlays[overlays.length - 1];
            if (modalOverlay && modalOverlay.classList) {
                modalOverlay.classList.add('active');
            }

            // Setup auto-save for modal
            this.setupModalAutoSave();

            // Restore draft if available
            this.restoreNodeDraft();


            // Warn on close if unsaved changes
            this.setupUnsavedGuard();
        }

        setupUnsavedGuard() {
            const modal = document.getElementById('nodeConfigModal');
            if (!modal) return;
            const markDirty = () => modal.dataset.dirty = '1';
            modal.querySelectorAll('input,select,textarea').forEach(el => {
                el.addEventListener('input', markDirty);
                el.addEventListener('change', markDirty);
            });
            // Intercept close buttons
            const askConfirm = (e) => {
                if (modal.dataset.dirty === '1') {
                    const ok = confirm('Bạn có thay đổi chưa lưu. Bạn có chắc muốn đóng?');
                    if (!ok) {
                        e?.preventDefault?.();
                        e?.stopPropagation?.();
                        return false;
                    }
                }
                return true;
            };
            const closeBtns = modal.querySelectorAll('.modal-close, [onclick^="closeNodeConfigModal"]');
            closeBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!askConfirm(e)) return;
                    closeNodeConfigModal();
                });
            });
            // ESC key inside modal
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    if (!askConfirm(e)) return;
                    closeNodeConfigModal();
                }
            };
            modal._escHandler = escHandler;
            document.addEventListener('keydown', escHandler);
        }

        restoreNodeDraft() {
            const modal = document.getElementById('nodeConfigModal');
            if (!modal) return;
            const nodeId = modal.dataset.nodeId;
            try {
                const key = `wb:nodeDraft:${nodeId}`;
                const raw = localStorage.getItem(key);
                if (!raw) return;
                const values = JSON.parse(raw);
                Object.entries(values).forEach(([id, val]) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (el.type === 'checkbox') el.checked = !!val; else el.value = val;
                });
            } catch { }
        }

        setupModalAutoSave() {
            // Auto-save when any input changes
            const modal = document.getElementById('nodeConfigModal');
            if (!modal) return;

            const inputs = modal.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    this.autoSaveNodeConfig();
                    // Update timeframe display if it's a timeframe-specific input
                    const tf = input.dataset.tf;
                    if (tf) {
                        this.updateTimeframeDisplay(tf);
                    }
                });
                input.addEventListener('input', () => {
                    // Debounce input events
                    clearTimeout(input._autoSaveTimeout);
                    input._autoSaveTimeout = setTimeout(() => {
                        this.autoSaveNodeConfig();
                        // Update timeframe display if it's a timeframe-specific input
                        const tf = input.dataset.tf;
                        if (tf) {
                            this.updateTimeframeDisplay(tf);
                        }
                    }, 1000);
                });

                // Highlight modified fields
                const originalValue = input.type === 'checkbox' ? input.checked : input.value;
                input.dataset.originalValue = String(originalValue);
                const updateHighlight = () => {
                    const current = input.type === 'checkbox' ? input.checked : input.value;
                    const changed = String(current) !== input.dataset.originalValue;
                    input.classList.toggle('ring-2', changed);
                    input.classList.toggle('ring-yellow-300', changed);
                    input.classList.toggle('bg-yellow-50', changed);
                };
                input.addEventListener('input', updateHighlight);
                input.addEventListener('change', updateHighlight);
            });
        }

        autoSaveNodeConfig() {
            try {
                const modal = document.getElementById('nodeConfigModal');
                if (!modal) return;

                // Find the current node being edited
                const nodeId = modal.dataset.nodeId;
                if (!nodeId) return;

                const node = this.nodes.get(nodeId);
                if (!node) return;

                // Collect current form data
                const properties = this.collectCurrentFormData(node.type);

                // Update node properties
                node.properties = properties;
                this.nodeProperties.set(nodeId, properties);

                // Update node display
                this.updateNodeDisplay(nodeId);

                // Show subtle auto-save indicator
                this.showAutoSaveIndicator('Node config auto-saved');

                // Persist draft to localStorage for restore
                const values = {};
                modal.querySelectorAll('input,select,textarea').forEach(el => {
                    if (!el.id) return;
                    values[el.id] = el.type === 'checkbox' ? el.checked : el.value;
                });
                localStorage.setItem(`wb:nodeDraft:${nodeId}`, JSON.stringify(values));

                console.log('Auto-saved node config for:', nodeId);

                // Auto-save workflow to database if we have a workflow ID (debounced)
                if (this.currentWorkflowId) {
                    clearTimeout(this._autoSaveDatabaseTimeout);
                    this._autoSaveDatabaseTimeout = setTimeout(() => {
                        this.autoSaveWorkflowToDatabase();
                    }, 2000); // Wait 2 seconds before saving to database
                }

            } catch (error) {
                console.warn('Auto-save failed:', error);
            }
        }

        showAutoSaveIndicator(message) {
            // Remove existing indicator
            const existing = document.getElementById('autoSaveIndicator');
            if (existing) {
                existing.remove();
            }

            // Create new indicator
            const indicator = document.createElement('div');
            indicator.id = 'autoSaveIndicator';
            indicator.className = 'fixed top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-lg text-sm shadow-lg z-50 transition-opacity duration-300';
            indicator.textContent = message;
            indicator.style.opacity = '0.8';

            document.body.appendChild(indicator);

            // Auto-remove after 2 seconds
            setTimeout(() => {
                if (indicator) {
                    indicator.style.opacity = '0';
                    setTimeout(() => indicator.remove(), 300);
                }
            }, 2000);
        }

        collectCurrentFormData(nodeType) {
            const properties = {};

            switch (nodeType) {
                case 'vn-macd-7tf':
                    properties.useDbParams = document.getElementById('useDbParams')?.checked || false;
                    properties.templateId = document.getElementById('templateId')?.value || '';
                    properties.zoneTemplateId = document.getElementById('zoneTemplateId')?.value || '';
                    properties.fastPeriod = parseInt(document.getElementById('fastPeriod')?.value) || 12;
                    properties.slowPeriod = parseInt(document.getElementById('slowPeriod')?.value) || 26;
                    properties.signalPeriod = parseInt(document.getElementById('signalPeriod')?.value) || 9;
                    properties.timeframes = ['1m', '2m', '5m', '15m', '30m', '1h', '4h'];
                    properties.timeframeWeights = { '1m': 2, '2m': 3, '5m': 4, '15m': 5, '30m': 6, '1h': 7, '4h': 8 };
                    properties.useZones = document.getElementById('useZones')?.checked || false;
                    properties.minTrendConsensus = parseInt(document.getElementById('minTrendConsensus')?.value) || 2;
                    properties.minEntryConsensus = parseInt(document.getElementById('minEntryConsensus')?.value) || 2;
                    properties.minConfidence = parseFloat(document.getElementById('minConfidence')?.value) || 0.6;
                    properties.strategyType = 'VN_MACD_7TF';
                    properties.isProductionReady = true;

                    // Collect matrix table data
                    properties.matrixData = {};
                    ['4h', '1h', '30m', '15m', '5m', '2m', '1m'].forEach(tf => {
                        properties.matrixData[tf] = this.collectTimeframeData(tf);
                    });
                    break;

                case 'vn-sma-7tf':
                    properties.useDbSmaConfig = document.getElementById('useDbSmaConfig')?.checked || false;
                    properties.smaTemplateId = document.getElementById('smaTemplateId')?.value || '';
                    const smaPeriods = ['18', '36', '48', '144'];
                    const selectedPeriodEls = Array.from(document.querySelectorAll('input[type="checkbox"]')).filter(cb => smaPeriods.includes(cb.value) && cb.checked);
                    properties.periods = selectedPeriodEls.length ? selectedPeriodEls.map(cb => parseInt(cb.value)) : [18, 36, 48, 144];
                    properties.timeframes = ['1m', '2m', '5m', '15m', '30m', '1h', '4h'];
                    properties.timeframeWeights = { '1m': 2, '2m': 3, '5m': 4, '15m': 5, '30m': 6, '1h': 7, '4h': 8 };
                    properties.tripleConfirmation = document.getElementById('tripleConfirmation')?.checked || false;
                    properties.minConfirmation = parseInt(document.getElementById('minConfirmation')?.value) || 3;
                    properties.minTrendConsensus = parseInt(document.getElementById('minTrendConsensus')?.value) || 2;
                    properties.minEntryConsensus = parseInt(document.getElementById('minEntryConsensus')?.value) || 2;
                    properties.minConfidence = parseFloat(document.getElementById('minConfidence')?.value) || 0.5;
                    properties.strategyType = 'VN_SMA_7TF';
                    properties.isProductionReady = true;
                    break;

                case 'symbol':
                    properties.ticker = document.getElementById('ticker')?.value || 'VN30';
                    properties.exchange = document.getElementById('exchange')?.value || 'HOSE';
                    properties.market = document.getElementById('market')?.value || 'VN';
                    const timeframeCheckboxes = document.querySelectorAll('input[type="checkbox"]');
                    properties.timeframes = Array.from(timeframeCheckboxes)
                        .filter(cb => cb.checked && ['1m', '2m', '5m', '15m', '30m', '1h', '4h'].includes(cb.value))
                        .map(cb => cb.value);
                    break;

                case 'macd-multi':
                    properties.fastPeriod = parseInt(document.getElementById('fastPeriod')?.value) || 7;
                    properties.slowPeriod = parseInt(document.getElementById('slowPeriod')?.value) || 113;
                    properties.signalPeriod = parseInt(document.getElementById('signalPeriod')?.value) || 144;

                    // Collect symbol thresholds from table
                    properties.symbolThresholds = [];
                    const symbolRows = document.querySelectorAll('#symbolThresholdsTableBody > tr');
                    symbolRows.forEach(row => {
                        const symbol = row.querySelector('[data-field="symbol"]')?.value?.trim();
                        const company = row.querySelector('[data-field="company"]')?.value?.trim() || '';
                        const weight = row.querySelector('[data-field="weight"]')?.value?.trim() || '';
                        const sector = row.querySelector('[data-field="sector"]')?.value?.trim() || '';
                        const exchange = row.querySelector('[data-field="exchange"]')?.value?.trim() || '';
                        const active = !!row.querySelector('[data-field="active"]')?.checked;
                        const bubefsm1 = parseFloat(row.querySelector('[data-field="bubefsm1"]')?.value) || 0;
                        const bubefsm2 = parseFloat(row.querySelector('[data-field="bubefsm2"]')?.value) || 0;
                        const bubefsm5 = parseFloat(row.querySelector('[data-field="bubefsm5"]')?.value) || 0;
                        const bubefsm15 = parseFloat(row.querySelector('[data-field="bubefsm15"]')?.value) || 0;
                        const bubefsm30 = parseFloat(row.querySelector('[data-field="bubefsm30"]')?.value) || 0;
                        const bubefs_1h = parseFloat(row.querySelector('[data-field="bubefs_1h"]')?.value) || 0;

                        if (symbol) {
                            properties.symbolThresholds.push({
                                symbol,
                                company,
                                weight,
                                sector,
                                exchange,
                                active,
                                bubefsm1, bubefsm2, bubefsm5, bubefsm15, bubefsm30, bubefs_1h
                            });
                        }
                    });
                    break;

                case 'multi-indicator':
                    // Collect aggregation settings
                    properties.aggregation = {
                        method: document.getElementById('aggregationMethod')?.value || 'weighted_average',
                        minStrategies: parseInt(document.getElementById('minStrategies')?.value) || 3,
                        consensusThreshold: parseFloat(document.getElementById('consensusThreshold')?.value) || 0.7,
                        confidenceThreshold: parseFloat(document.getElementById('confidenceThreshold')?.value) || 0.6,
                        customWeights: {
                            macd_multi: parseFloat(document.getElementById('weightMacdMulti')?.value) || 0.3,
                            sma: parseFloat(document.getElementById('weightSma')?.value) || 0.25,
                            rsi: parseFloat(document.getElementById('weightRsi')?.value) || 0.2,
                            bollinger: parseFloat(document.getElementById('weightBollinger')?.value) || 0.25
                        }
                    };

                    // Collect symbol thresholds from table
                    properties.symbolThresholds = [];
                    const multiIndicatorRows = document.querySelectorAll('#multiIndicatorSymbolsTableBody > tr');
                    multiIndicatorRows.forEach(row => {
                        const symbol = row.querySelector('[data-field="symbol"]')?.value?.trim();
                        const bubefsm1 = parseFloat(row.querySelector('[data-field="bubefsm1"]')?.value) || 0;
                        const bubefsm2 = parseFloat(row.querySelector('[data-field="bubefsm2"]')?.value) || 0;
                        const bubefsm5 = parseFloat(row.querySelector('[data-field="bubefsm5"]')?.value) || 0;
                        const bubefsm15 = parseFloat(row.querySelector('[data-field="bubefsm15"]')?.value) || 0;
                        const bubefsm30 = parseFloat(row.querySelector('[data-field="bubefsm30"]')?.value) || 0;
                        const bubefs_1h = parseFloat(row.querySelector('[data-field="bubefs_1h"]')?.value) || 0;

                        if (symbol) {
                            properties.symbolThresholds.push({
                                symbol,
                                bubefsm1, bubefsm2, bubefsm5, bubefsm15, bubefsm30, bubefs_1h
                            });
                        }
                    });
                    break;

                case 'flexible-multi-indicator':
                    // Collect flexible configuration
                    properties.symbols = [];
                    properties.symbolConfigs = {};

                    // Collect symbols and their configurations
                    const flexibleSymbolRows = document.querySelectorAll('#flexibleSymbolsTableBody tr');
                    flexibleSymbolRows.forEach(row => {
                        const symbol = row.querySelector('[data-field="symbol"]')?.value;
                        if (symbol) {
                            properties.symbols.push(symbol);

                            // Collect indicator configurations for this symbol
                            const indicators = [];
                            const indicatorCheckboxes = row.querySelectorAll('.indicator-checkbox:checked');
                            indicatorCheckboxes.forEach(checkbox => {
                                const indicatorType = checkbox.dataset.indicator;
                                const weight = parseFloat(checkbox.closest('tr').querySelector(`[data-field="weight_${indicatorType}"]`)?.value) || 0.25;
                                indicators.push({
                                    type: indicatorType,
                                    enabled: true,
                                    weight: weight,
                                    config: {}
                                });
                            });

                            properties.symbolConfigs[symbol] = {
                                indicators: indicators
                            };
                        }
                    });

                    // Collect aggregation settings
                    properties.aggregation = {
                        method: document.getElementById('flexibleAggregationMethod')?.value || 'weighted_average',
                        minIndicators: parseInt(document.getElementById('flexibleMinIndicators')?.value) || 3,
                        consensusThreshold: parseFloat(document.getElementById('flexibleConsensusThreshold')?.value) || 0.7,
                        confidenceThreshold: parseFloat(document.getElementById('flexibleConfidenceThreshold')?.value) || 0.6
                    };
                    break;

                default:
                    // For other node types, collect basic properties
                    const inputs = document.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        if (input.id && input.value !== undefined) {
                            if (input.type === 'checkbox') {
                                properties[input.id] = input.checked;
                            } else if (input.type === 'number') {
                                properties[input.id] = parseFloat(input.value) || 0;
                            } else {
                                properties[input.id] = input.value;
                            }
                        }
                    });
            }

            return properties;
        }

        showZoneThresholdsModal(modalHtml) {
            // Remove existing zone modal if any
            const existingModal = document.getElementById('zoneThresholdsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Insert modal HTML
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Activate the zone modal specifically
            const zoneModal = document.getElementById('zoneThresholdsModal');
            if (zoneModal) {
                zoneModal.classList.add('active');
            }

            // Setup auto-save for zone thresholds
            this.setupZoneThresholdsAutoSave();

            // Restore draft if exists
            this.restoreZoneDraft();

            // Setup unsaved guard for zone modal
            this.setupZoneUnsavedGuard();
        }

        setupZoneThresholdsAutoSave() {
            const modal = document.getElementById('zoneThresholdsModal');
            if (!modal) return;

            // Auto-save when any input changes in zone thresholds
            const inputs = modal.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    this.autoSaveZoneThresholds();
                });
                input.addEventListener('input', () => {
                    // Debounce input events
                    clearTimeout(input._zoneAutoSaveTimeout);
                    input._zoneAutoSaveTimeout = setTimeout(() => {
                        this.autoSaveZoneThresholds();
                    }, 1000);
                });

                // Highlight modified
                const original = input.value;
                input.dataset.originalValue = original;
                const update = () => {
                    const changed = input.value !== input.dataset.originalValue;
                    input.classList.toggle('ring-2', changed);
                    input.classList.toggle('ring-yellow-300', changed);
                    input.classList.toggle('bg-yellow-50', changed);
                };
                input.addEventListener('input', update);
                input.addEventListener('change', update);
            });
        }

        restoreZoneDraft() {
            const modal = document.getElementById('zoneThresholdsModal');
            if (!modal) return;
            const templateId = modal.getAttribute('data-template-id') || 'unknown';
            try {
                const raw = localStorage.getItem(`wb:zoneDraft:${templateId}`);
                if (!raw) return;
                const map = JSON.parse(raw);
                Object.entries(map).forEach(([key, val]) => {
                    const el = document.getElementById(key);
                    if (el) el.value = val;
                });
                this.validateZoneThresholds();
            } catch { }
        }

        setupZoneUnsavedGuard() {
            const modal = document.getElementById('zoneThresholdsModal');
            if (!modal) return;
            const markDirty = () => modal.dataset.dirty = '1';
            modal.querySelectorAll('input').forEach(el => {
                el.addEventListener('input', markDirty);
                el.addEventListener('change', markDirty);
            });
            const ask = (e) => {
                if (modal.dataset.dirty === '1') {
                    const ok = confirm('Bạn có thay đổi chưa lưu. Đóng Zone Editor?');
                    if (!ok) {
                        e?.preventDefault?.();
                        e?.stopPropagation?.();
                        return false;
                    }
                }
                return true;
            };
            const closeBtns = modal.querySelectorAll('.modal-close, [onclick^="workflowBuilder.closeZoneThresholdsModal"]');
            closeBtns.forEach(btn => btn.addEventListener('click', (e) => {
                if (!ask(e)) return;
                this.closeZoneThresholdsModal();
            }));
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    if (!ask(e)) return;
                    this.closeZoneThresholdsModal();
                }
            };
            modal._escHandler = escHandler;
            document.addEventListener('keydown', escHandler);
        }

        autoSaveZoneThresholds() {
            try {
                console.log('Auto-saving zone thresholds...');

                // Collect current zone threshold data
                const zoneData = this.collectZoneThresholdsData();

                // Store in temporary storage (could be localStorage or a class property)
                this.tempZoneThresholds = zoneData;

                // Show subtle auto-save indicator
                this.showAutoSaveIndicator('Zone thresholds auto-saved');

                // Persist to localStorage by element id for restore
                const modal = document.getElementById('zoneThresholdsModal');
                const templateId = modal?.getAttribute('data-template-id') || 'unknown';
                const values = {};
                modal?.querySelectorAll('input').forEach(el => {
                    if (el.id) values[el.id] = el.value;
                });
                localStorage.setItem(`wb:zoneDraft:${templateId}`, JSON.stringify(values));

                console.log('Zone thresholds auto-saved:', zoneData);

            } catch (error) {
                console.warn('Zone thresholds auto-save failed:', error);
            }
        }

        collectZoneThresholdsData() {
            const data = {};
            const timeframes = ['1m', '2m', '5m', '15m', '30m', '1h', '4h'];

            timeframes.forEach(tf => {
                // Try to get data from the new direct input fields first
                const fmacdInput = document.getElementById(`fmacd-${tf}`);
                const smacdInput = document.getElementById(`smacd-${tf}`);
                const barsInput = document.getElementById(`bars-${tf}`);

                if (fmacdInput && smacdInput && barsInput) {
                    // New format - direct input fields
                    const fmacd = parseFloat(fmacdInput.value) || 0.5;
                    const smacd = parseFloat(smacdInput.value) || 0.5;
                    const bars = barsInput.value || '0.1,0.2,0.3,0.4,0.5';

                    data[tf] = {
                        fmacd: [fmacd.toString()],
                        smacd: [smacd.toString()],
                        bars: bars.split(',').map(x => parseFloat(x.trim())).filter(x => !isNaN(x))
                    };
                } else {
                    // Fallback to old format - use collectZoneThresholdsFromInputs
                    data[tf] = this.collectZoneThresholdsFromInputs(tf);
                }
            });

            return data;
        }

        closeZoneThresholdsModal() {
            const modal = document.getElementById('zoneThresholdsModal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        async initializeTemplateSelects(strategyType, existingProps) {
            // strategyType: 'macd' | 'sma'
            const isMacd = strategyType === 'macd';
            const templateSelectId = isMacd ? 'templateId' : 'smaTemplateId';
            const zoneSelectId = isMacd ? 'zoneTemplateId' : null;

            const templateSelect = document.getElementById(templateSelectId);
            const zoneSelect = zoneSelectId ? document.getElementById(zoneSelectId) : null;

            // Fallback data in case API not available yet
            const fallbackTemplates = isMacd
                ? [
                    { id: 'VN_DEFAULT', name: 'VN MACD Default' },
                    { id: 'VN_AGGRESSIVE', name: 'VN MACD Aggressive' }
                ]
                : [
                    { id: 'VN_SMA_DEFAULT', name: 'VN SMA Default' },
                    { id: 'VN_SMA_TREND', name: 'VN SMA Trend Focus' }
                ];

            const fallbackZones = [
                { id: 'VN_ZONE_V1', name: 'VN Zone V1' },
                { id: 'VN_ZONE_V2', name: 'VN Zone V2' }
            ];

            try {
                // Attempt to fetch templates
                const templates = await this.fetchTemplatesFromApi(isMacd ? 'MACD' : 'SMA');
                this.populateSelect(templateSelect, templates || fallbackTemplates, existingProps[isMacd ? 'templateId' : 'smaTemplateId']);

                if (isMacd && zoneSelect) {
                    const zones = await this.fetchZonesFromApi() || fallbackZones;
                    this.populateSelect(zoneSelect, zones, existingProps.zoneTemplateId);
                }
            } catch (e) {
                // Populate fallbacks on error
                this.populateSelect(templateSelect, fallbackTemplates, existingProps[isMacd ? 'templateId' : 'smaTemplateId']);
                if (isMacd && zoneSelect) {
                    this.populateSelect(zoneSelect, fallbackZones, existingProps.zoneTemplateId);
                }
            }

            // Auto-load template values if DB mode is enabled and template exists
            try {
                if (strategyType === 'macd' && (existingProps.useDbParams || document.getElementById('useDbParams')?.checked)) {
                    const tid = document.getElementById('templateId')?.value || existingProps.templateId;
                    if (tid) {
                        await this.reloadTemplateValues('MACD');
                        // Apply overrides from node (if any)
                        if (existingProps.overrides) this.applyOverridesToTable('MACD', existingProps.overrides);
                    }
                }
                if (strategyType === 'sma' && (existingProps.useDbSmaConfig || document.getElementById('useDbSmaConfig')?.checked)) {
                    const tid = document.getElementById('smaTemplateId')?.value || existingProps.smaTemplateId;
                    if (tid) {
                        await this.reloadTemplateValues('SMA');
                        if (existingProps.overrides) this.applyOverridesToTable('SMA', existingProps.overrides);
                    }
                }
            } catch (e) {
                console.warn('auto-load template values error', e);
            }
        }

        async reloadTemplateValues(strategy) {
            try {
                const isMacd = strategy === 'MACD';
                const templateId = isMacd ? (document.getElementById('templateId')?.value || '') : (document.getElementById('smaTemplateId')?.value || '');
                if (!templateId) {
                    this.showNotification('Vui lòng chọn template trước', 'warning');
                    return;
                }
                const res = await fetch(`/api/threshold/template-values?strategy=${encodeURIComponent(strategy)}&templateId=${encodeURIComponent(templateId)}&market=VN`);
                const data = await res.json();
                if (isMacd) {
                    this.fillMacdTemplateTable(data);
                } else {
                    this.fillSmaTemplateTable(data);
                }
                this.showNotification('Loaded template values', 'success');
            } catch (e) {
                this.showNotification(`Load failed: ${e.message}`, 'error');
            }
        }

        fillMacdTemplateTable(payload) {
            try {
                const zonesSelectOptions = (document.getElementById('zoneTemplateId') || { options: [] }).options;
                const tbody = document.getElementById('macdTemplateTableBody');
                if (!tbody) return;
                const map = new Map((payload.timeframes || []).map(x => [x.tf, x]));
                Array.from(tbody.querySelectorAll('tr[data-tf]')).forEach(row => {
                    const tf = row.getAttribute('data-tf');
                    const item = map.get(tf) || { params: {} };
                    row.querySelector('.macd-fast').value = item.params.fastPeriod ?? 12;
                    row.querySelector('.macd-slow').value = item.params.slowPeriod ?? 26;
                    row.querySelector('.macd-signal').value = item.params.signalPeriod ?? 9;
                    row.querySelector('.macd-minconf').value = item.params.minConfidence ?? 0.6;
                    const zoneSel = row.querySelector('.macd-zone');
                    if (zoneSel && zonesSelectOptions && zonesSelectOptions.length) {
                        zoneSel.innerHTML = '';
                        Array.from(zonesSelectOptions).forEach(opt => {
                            const o = document.createElement('option');
                            o.value = opt.value; o.textContent = opt.textContent;
                            if (item.zone_id && item.zone_id == opt.value) o.selected = true;
                            zoneSel.appendChild(o);
                        });
                    }
                });
            } catch (e) {
                console.warn('fillMacdTemplateTable error', e);
            }
        }

        fillSmaTemplateTable(payload) {
            try {
                const tbody = document.getElementById('smaTemplateTableBody');
                if (!tbody) return;
                const map = new Map((payload.timeframes || []).map(x => [x.tf, x]));
                Array.from(tbody.querySelectorAll('tr[data-tf]')).forEach(row => {
                    const tf = row.getAttribute('data-tf');
                    const item = map.get(tf) || { params: {} };
                    const periods = Array.isArray(item.params.periods) ? item.params.periods.join(',') : '18,36,48,144';
                    row.querySelector('.sma-periods').value = periods;
                    row.querySelector('.sma-minconf').value = item.params.minConfidence ?? 0.5;
                    row.querySelector('.sma-triple').checked = item.params.tripleConfirmation ?? true;
                    row.querySelector('.sma-minconfirm').value = item.params.minConfirmation ?? 3;
                });
            } catch (e) {
                console.warn('fillSmaTemplateTable error', e);
            }
        }

        getMacdTableItems() {
            console.log('getMacdTableItems called');
            const tbody = document.getElementById('macdTemplateTableBody');
            if (!tbody) {
                console.warn('macdTemplateTableBody not found');
                return [];
            }
            const items = [];
            const rows = Array.from(tbody.querySelectorAll('tr[data-tf]'));
            console.log('Found rows:', rows.length);

            rows.forEach(row => {
                const tf = row.getAttribute('data-tf');
                const fast = parseInt(row.querySelector('.macd-fast').value) || 12;
                const slow = parseInt(row.querySelector('.macd-slow').value) || 26;
                const signal = parseInt(row.querySelector('.macd-signal').value) || 9;
                const minConfidence = parseFloat(row.querySelector('.macd-minconf').value) || 0.6;
                const zone_id = row.querySelector('.macd-zone').value || null;
                const item = { tf, params: { fastPeriod: fast, slowPeriod: slow, signalPeriod: signal, minConfidence }, zone_id };
                items.push(item);
                console.log(`MACD ${tf}:`, item);
            });
            console.log('MACD items collected:', items);
            return items;
        }

        getSmaTableItems() {
            console.log('getSmaTableItems called');
            const tbody = document.getElementById('smaTemplateTableBody');
            if (!tbody) {
                console.warn('smaTemplateTableBody not found');
                return [];
            }
            const items = [];
            const rows = Array.from(tbody.querySelectorAll('tr[data-tf]'));
            console.log('Found SMA rows:', rows.length);

            rows.forEach(row => {
                const tf = row.getAttribute('data-tf');
                const periods = (row.querySelector('.sma-periods').value || '18,36,48,144').split(',').map(x => parseInt(x.trim())).filter(Boolean);
                const minConfidence = parseFloat(row.querySelector('.sma-minconf').value) || 0.5;
                const tripleConfirmation = !!row.querySelector('.sma-triple').checked;
                const minConfirmation = parseInt(row.querySelector('.sma-minconfirm').value) || 3;
                const item = { tf, params: { periods, minConfidence, tripleConfirmation, minConfirmation } };
                items.push(item);
                console.log(`SMA ${tf}:`, item);
            });
            console.log('SMA items collected:', items);
            return items;
        }

        applyOverridesToTable(strategy, overrides) {
            try {
                const isMacd = strategy === 'MACD';
                const tfs = ['1m', '2m', '5m', '15m', '30m', '1h', '4h'];
                tfs.forEach(tf => {
                    const ov = overrides[tf];
                    if (!ov) return;
                    if (isMacd) {
                        const row = document.querySelector(`#macdTemplateTableBody tr[data-tf="${tf}"]`);
                        if (!row) return;
                        if (ov.fastPeriod != null) row.querySelector('.macd-fast').value = ov.fastPeriod;
                        if (ov.slowPeriod != null) row.querySelector('.macd-slow').value = ov.slowPeriod;
                        if (ov.signalPeriod != null) row.querySelector('.macd-signal').value = ov.signalPeriod;
                        if (ov.minConfidence != null) row.querySelector('.macd-minconf').value = ov.minConfidence;
                        if (ov.zone_id != null) row.querySelector('.macd-zone').value = ov.zone_id;
                    } else {
                        const row = document.querySelector(`#smaTemplateTableBody tr[data-tf="${tf}"]`);
                        if (!row) return;
                        if (Array.isArray(ov.periods)) row.querySelector('.sma-periods').value = ov.periods.join(',');
                        if (ov.minConfidence != null) row.querySelector('.sma-minconf').value = ov.minConfidence;
                        if (ov.tripleConfirmation != null) row.querySelector('.sma-triple').checked = !!ov.tripleConfirmation;
                        if (ov.minConfirmation != null) row.querySelector('.sma-minconfirm').value = ov.minConfirmation;
                    }
                });
            } catch (e) {
                console.warn('applyOverridesToTable error', e);
            }
        }

        async saveTemplateValues(strategy) {
            try {
                console.log('saveTemplateValues called for strategy:', strategy);
                const isMacd = strategy === 'MACD';
                const templateId = isMacd ? (document.getElementById('templateId')?.value || '') : (document.getElementById('smaTemplateId')?.value || '');
                console.log('Template ID:', templateId);

                if (!templateId) {
                    this.showNotification('Vui lòng chọn template trước', 'warning');
                    return;
                }

                const items = isMacd ? this.getMacdTableItems() : this.getSmaTableItems();
                console.log('Collected items:', items);

                if (!items || items.length === 0) {
                    this.showNotification('Không có dữ liệu để lưu', 'warning');
                    return;
                }

                const payload = { strategy, templateId, items };
                console.log('Sending payload:', payload);

                const res = await fetch('/api/threshold/template-values', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', res.status);
                const data = await res.json();
                console.log('Response data:', data);

                if (res.ok) {
                    this.showNotification('Template saved successfully', 'success');
                } else {
                    this.showNotification(data.message || 'Save failed', 'error');
                }
            } catch (e) {
                console.error('Save template error:', e);
                this.showNotification(`Save failed: ${e.message}`, 'error');
            }
        }

        applyMacdRowToAll() {
            const tbody = document.getElementById('macdTemplateTableBody');
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr[data-tf]'));
            if (rows.length === 0) return;
            const first = rows[0];
            const fast = first.querySelector('.macd-fast').value;
            const slow = first.querySelector('.macd-slow').value;
            const signal = first.querySelector('.macd-signal').value;
            const minconf = first.querySelector('.macd-minconf').value;
            const zone = first.querySelector('.macd-zone').value;
            rows.forEach(r => {
                r.querySelector('.macd-fast').value = fast;
                r.querySelector('.macd-slow').value = slow;
                r.querySelector('.macd-signal').value = signal;
                r.querySelector('.macd-minconf').value = minconf;
                r.querySelector('.macd-zone').value = zone;
            });
        }

        copyMacdDown() {
            const tbody = document.getElementById('macdTemplateTableBody');
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr[data-tf]'));
            for (let i = 0; i < rows.length - 1; i++) {
                const cur = rows[i];
                const nxt = rows[i + 1];
                nxt.querySelector('.macd-fast').value = cur.querySelector('.macd-fast').value;
                nxt.querySelector('.macd-slow').value = cur.querySelector('.macd-slow').value;
                nxt.querySelector('.macd-signal').value = cur.querySelector('.macd-signal').value;
                nxt.querySelector('.macd-minconf').value = cur.querySelector('.macd-minconf').value;
                nxt.querySelector('.macd-zone').value = cur.querySelector('.macd-zone').value;
            }
        }

        applySmaRowToAll() {
            const tbody = document.getElementById('smaTemplateTableBody');
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr[data-tf]'));
            if (rows.length === 0) return;
            const first = rows[0];
            const periods = first.querySelector('.sma-periods').value;
            const minconf = first.querySelector('.sma-minconf').value;
            const triple = first.querySelector('.sma-triple').checked;
            const minconfirm = first.querySelector('.sma-minconfirm').value;
            rows.forEach(r => {
                r.querySelector('.sma-periods').value = periods;
                r.querySelector('.sma-minconf').value = minconf;
                r.querySelector('.sma-triple').checked = triple;
                r.querySelector('.sma-minconfirm').value = minconfirm;
            });
        }

        copySmaDown() {
            const tbody = document.getElementById('smaTemplateTableBody');
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr[data-tf]'));
            for (let i = 0; i < rows.length - 1; i++) {
                const cur = rows[i];
                const nxt = rows[i + 1];
                nxt.querySelector('.sma-periods').value = cur.querySelector('.sma-periods').value;
                nxt.querySelector('.sma-minconf').value = cur.querySelector('.sma-minconf').value;
                nxt.querySelector('.sma-triple').checked = cur.querySelector('.sma-triple').checked;
                nxt.querySelector('.sma-minconfirm').value = cur.querySelector('.sma-minconfirm').value;
            }
        }

        populateSelect(selectEl, items, selectedId) {
            if (!selectEl) return;
            selectEl.innerHTML = '';
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = 'Chọn template';
            selectEl.appendChild(defaultOpt);
            (items || []).forEach(it => {
                const opt = document.createElement('option');
                opt.value = it.id;
                opt.textContent = it.name || it.id;
                if (selectedId && selectedId === it.id) opt.selected = true;
                selectEl.appendChild(opt);
            });
        }

        async fetchTemplatesFromApi(strategy) {
            // Expected backend: /api/threshold/templates?market=VN&strategy=MACD|SMA
            const url = `/api/threshold/templates?market=VN&strategy=${encodeURIComponent(strategy)}`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Bad status');
                const data = await res.json();
                // Expect [{id, name}] shape
                return Array.isArray(data) ? data : data.templates;
            } catch (e) {
                console.warn('fetchTemplatesFromApi fallback used:', e.message);
                return null;
            }
        }

        async fetchZonesFromApi() {
            // Expected backend: /api/threshold/zones?market=VN
            const url = `/api/threshold/zones?market=VN`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Bad status');
                const data = await res.json();
                return Array.isArray(data) ? data : data.zones;
            } catch (e) {
                console.warn('fetchZonesFromApi fallback used:', e.message);
                return null;
            }
        }

        // Configuration Forms
        createSymbolConfigurationForm(node, properties) {
            return `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ticker Symbol</label>
                        <input type="text" id="ticker" value="${properties.ticker || 'VN30'}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Enter ticker symbol">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Exchange</label>
                        <select id="exchange" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="HOSE" ${properties.exchange === 'HOSE' ? 'selected' : ''}>HOSE</option>
                            <option value="HNX" ${properties.exchange === 'HNX' ? 'selected' : ''}>HNX</option>
                            <option value="UPCOM" ${properties.exchange === 'UPCOM' ? 'selected' : ''}>UPCOM</option>
                            <option value="US" ${properties.exchange === 'US' ? 'selected' : ''}>US</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Market</label>
                        <select id="market" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="VN" ${properties.market === 'VN' ? 'selected' : ''}>Vietnam</option>
                            <option value="US" ${properties.market === 'US' ? 'selected' : ''}>United States</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">7 Timeframes System</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" value="1m" ${(properties.timeframes || []).includes('1m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">1 Minute (Weight: 2)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="2m" ${(properties.timeframes || []).includes('2m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">2 Minutes (Weight: 3)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="5m" ${(properties.timeframes || []).includes('5m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">5 Minutes (Weight: 4)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="15m" ${(properties.timeframes || []).includes('15m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">15 Minutes (Weight: 5)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="30m" ${(properties.timeframes || []).includes('30m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">30 Minutes (Weight: 6)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="1h" ${(properties.timeframes || []).includes('1h') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">1 Hour (Weight: 7)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="4h" ${(properties.timeframes || []).includes('4h') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">4 Hours (Weight: 8)</span>
                            </label>
                        </div>
                        <div class="mt-2 p-2 bg-blue-50 rounded text-xs text-blue-700">
                            <strong>Strategy:</strong> Khung lớn (1h, 4h) tìm xu hướng, khung nhỏ (1m, 2m, 5m) tìm điểm vào lệnh
                        </div>
                    </div>
                </div>
            `;
        }

        createMACDConfigurationForm(node, properties) {
            return `
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fast Period</label>
                            <input type="number" id="fastPeriod" value="${properties.fastPeriod || 12}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Slow Period</label>
                            <input type="number" id="slowPeriod" value="${properties.slowPeriod || 26}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Signal Period</label>
                            <input type="number" id="signalPeriod" value="${properties.signalPeriod || 9}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">7 Timeframes System</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" value="1m" ${(properties.timeframes || []).includes('1m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">1m (Weight: 2)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="2m" ${(properties.timeframes || []).includes('2m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">2m (Weight: 3)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="5m" ${(properties.timeframes || []).includes('5m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">5m (Weight: 4)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="15m" ${(properties.timeframes || []).includes('15m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">15m (Weight: 5)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="30m" ${(properties.timeframes || []).includes('30m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">30m (Weight: 6)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="1h" ${(properties.timeframes || []).includes('1h') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">1h (Weight: 7)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="4h" ${(properties.timeframes || []).includes('4h') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">4h (Weight: 8)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Market Template</label>
                        <select id="marketTemplate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="VN" ${properties.marketTemplate === 'VN' ? 'selected' : ''}>Vietnam</option>
                            <option value="US" ${properties.marketTemplate === 'US' ? 'selected' : ''}>United States</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="useZones" ${properties.useZones ? 'checked' : ''} class="mr-2">
                        <label for="useZones" class="text-sm font-medium text-gray-700">Use Zone System</label>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Min Trend Consensus</label>
                            <input type="number" id="minTrendConsensus" value="${properties.minTrendConsensus || 2}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <div class="text-xs text-gray-500 mt-1">Min khung lớn (1h, 4h) đồng thuận</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Min Entry Consensus</label>
                            <input type="number" id="minEntryConsensus" value="${properties.minEntryConsensus || 2}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <div class="text-xs text-gray-500 mt-1">Min khung nhỏ (1m, 2m, 5m) đồng thuận</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Confidence</label>
                        <input type="range" id="minConfidence" min="0" max="1" step="0.1" value="${properties.minConfidence || 0.6}" 
                               class="w-full">
                        <div class="text-sm text-gray-600 mt-1">Value: <span id="minConfidenceValue">${properties.minConfidence || 0.6}</span></div>
                    </div>
                    
                    <div class="mt-2 p-2 bg-green-50 rounded text-xs text-green-700">
                        <strong>MACD 7 Timeframes Strategy:</strong> Khung lớn (1h, 4h) tìm xu hướng, khung nhỏ (1m, 2m, 5m) tìm điểm vào lệnh
                    </div>
                </div>
            `;
        }

        createMACDMultiConfigurationForm(node, properties) {
            // Load symbol-specific thresholds if they exist
            const symbolThresholds = properties.symbolThresholds || [];
            const symbolThresholdsHTML = symbolThresholds.map(st => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${st.symbol}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="symbol">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${st.company || ''}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="company">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${st.weight || ''}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="weight">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${st.sector || ''}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="sector">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${st.exchange || ''}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="exchange" placeholder="NASDAQ/HOSE/HNX/UPCOM">
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-center">
                        <input type="checkbox" ${st.active === false ? '' : 'checked'} data-field="active">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefsm1 || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm1">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefsm2 || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm2">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefsm5 || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm5">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefsm15 || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm15">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefsm30 || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm30">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefs_1h || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefs_1h">
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-center">
                        <button type="button" onclick="this.closest('tr').remove()" class="px-1 py-0.5 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">MACD Multi-Timeframe Analysis</h4>
                        <p class="text-sm text-blue-700">BuBeFSM: BULL/BEAR signals dựa trên FastMACD và SignalMACD crossover</p>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fast Period</label>
                            <input type="number" id="fastPeriod" value="${properties.fastPeriod || 7}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Slow Period</label>
                            <input type="number" id="slowPeriod" value="${properties.slowPeriod || 113}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Signal Period</label>
                            <input type="number" id="signalPeriod" value="${properties.signalPeriod || 144}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <div class="mb-3">
                            <button type="button" onclick="workflowBuilder.addSymbolThreshold()" class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 mr-2">
                                <i class="fas fa-plus mr-1"></i>Add Symbol
                            </button>
                            <button type="button" onclick="workflowBuilder.loadDefaultSymbols()" class="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700">
                                <i class="fas fa-download mr-1"></i>Load 25 Symbols
                            </button>
                        </div>
                        
                        <!-- Symbol Thresholds Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs border-collapse border border-gray-300">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="border border-gray-300 px-2 py-1 text-left">Symbol</th>
                                            <th class="border border-gray-300 px-2 py-1 text-left">Company</th>
                                            <th class="border border-gray-300 px-2 py-1 text-center">Weight</th>
                                            <th class="border border-gray-300 px-2 py-1 text-left">Sector</th>
                                            <th class="border border-gray-300 px-2 py-1 text-left">Exchange</th>
                                            <th class="border border-gray-300 px-2 py-1 text-center">Active</th>
                                            <th class="border border-gray-300 px-2 py-1 text-center" title="BULL/BEAR, FastMACD, SignalMACD, 1m">BuBeFSM1</th>
                                            <th class="border border-gray-300 px-2 py-1 text-center" title="BULL/BEAR, FastMACD, SignalMACD, 2m">BuBeFSM2</th>
                                            <th class="border border-gray-300 px-2 py-1 text-center" title="BULL/BEAR, FastMACD, SignalMACD, 5m">BuBeFSM5</th>
                                            <th class="border border-gray-300 px-2 py-1 text-center" title="BULL/BEAR, FastMACD, SignalMACD, 15m">BuBeFSM15</th>
                                            <th class="border border-gray-300 px-2 py-1 text-center" title="BULL/BEAR, FastMACD, SignalMACD, 30m">BuBeFSM30</th>
                                            <th class="border border-gray-300 px-2 py-1 text-center" title="BULL/BEAR, FastMACD, SignalMACD, 1H">BuBeFS_1H</th>
                                            <th class="border border-gray-300 px-2 py-1 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                <tbody id="symbolThresholdsTableBody">
                                    ${symbolThresholdsHTML}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        addSymbolThreshold() {
            const container = document.getElementById('symbolThresholdsTableBody');
            if (!container) return;

            const symbolRow = document.createElement('tr');
            symbolRow.className = 'hover:bg-gray-50';
            symbolRow.innerHTML = `
                <td class="border border-gray-300 px-2 py-1">
                    <input type="text" placeholder="NVDA" class="w-full px-1 py-0.5 text-xs border rounded" data-field="symbol">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="text" placeholder="Company Name" class="w-full px-1 py-0.5 text-xs border rounded" data-field="company">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="text" placeholder="Weight %" class="w-full px-1 py-0.5 text-xs border rounded" data-field="weight">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="text" placeholder="Sector" class="w-full px-1 py-0.5 text-xs border rounded" data-field="sector">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="text" placeholder="NASDAQ/HOSE" class="w-full px-1 py-0.5 text-xs border rounded" data-field="exchange">
                </td>
                <td class="border border-gray-300 px-2 py-1 text-center">
                    <input type="checkbox" data-field="active" checked>
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="0.33" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm1">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="0.47" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm2">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="0.47" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm5">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="0.47" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm15">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="0.47" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm30">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="1.74" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefs_1h">
                </td>
                <td class="border border-gray-300 px-2 py-1 text-center">
                    <button type="button" onclick="this.closest('tr').remove()" class="px-1 py-0.5 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            container.appendChild(symbolRow);
        }

        loadDefaultSymbols() {
            const container = document.getElementById('symbolThresholdsTableBody');
            if (!container) return;

            // Clear existing data
            container.innerHTML = '';

            // Default data - 26 symbols with complete information from the image
            const defaultData = [
                { symbol: 'NVDA', company: 'NVIDIA Corporation', weight: '10.08%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.74, bubefsm15: 1.0, bubefsm30: 1.47, bubefs_1h: 1.74 },
                { symbol: 'MSFT', company: 'Microsoft Corporation', weight: '8.98%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 0.74, bubefsm5: 1.0, bubefsm15: 1.47, bubefsm30: 1.74, bubefs_1h: 2.2 },
                { symbol: 'AAPL', company: 'Apple Inc.', weight: '7.33%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 0.74, bubefsm5: 1.0, bubefsm15: 1.47, bubefsm30: 1.74, bubefs_1h: 2.2 },
                { symbol: 'AMZN', company: 'Amazon.com, Inc.', weight: '5.43%', sector: 'Consumer Discretionary', bubefsm1: 0.33, bubefsm2: 0.33, bubefsm5: 0.47, bubefsm15: 0.74, bubefsm30: 1.0, bubefs_1h: 1.47 },
                { symbol: 'AVGO', company: 'Broadcom Inc.', weight: '4.12%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 0.74, bubefsm5: 1.0, bubefsm15: 1.47, bubefsm30: 1.74, bubefs_1h: 2.2 },
                { symbol: 'META', company: 'Meta Platforms, Inc.', weight: '3.89%', sector: 'Communication Services', bubefsm1: 0.33, bubefsm2: 1.0, bubefsm5: 1.74, bubefsm15: 2.2, bubefsm30: 4.17, bubefs_1h: 6.6 },
                { symbol: 'NFLX', company: 'Netflix, Inc.', weight: '2.45%', sector: 'Communication Services', bubefsm1: 0.33, bubefsm2: 1.0, bubefsm5: 1.74, bubefsm15: 2.2, bubefsm30: 4.17, bubefs_1h: 6.6 },
                { symbol: 'TSLA', company: 'Tesla, Inc.', weight: '2.12%', sector: 'Consumer Discretionary', bubefsm1: 0.33, bubefsm2: 1.0, bubefsm5: 1.74, bubefsm15: 2.2, bubefsm30: 4.17, bubefs_1h: 6.6 },
                { symbol: 'GOOGL', company: 'Alphabet Inc. Class A', weight: '1.98%', sector: 'Communication Services', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.74, bubefsm15: 1.0, bubefsm30: 1.47, bubefs_1h: 1.74 },
                { symbol: 'GOOG', company: 'Alphabet Inc. Class C', weight: '1.87%', sector: 'Communication Services', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.74, bubefsm15: 1.0, bubefsm30: 1.47, bubefs_1h: 1.74 },
                { symbol: 'COST', company: 'Costco Wholesale Corporation', weight: '1.65%', sector: 'Consumer Staples', bubefsm1: 0.33, bubefsm2: 1.74, bubefsm5: 2.2, bubefsm15: 3.3, bubefsm30: 4.17, bubefs_1h: 6.6 },
                { symbol: 'PLTR', company: 'Palantir Technologies Inc.', weight: '1.43%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 0.74, bubefsm5: 1.0, bubefsm15: 1.74, bubefsm30: 2.2, bubefs_1h: 3.3 },
                { symbol: 'CSCO', company: 'Cisco Systems, Inc.', weight: '1.32%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 0.33, bubefsm5: 0.47, bubefsm15: 0.74, bubefsm30: 1.0, bubefs_1h: 1.47 },
                { symbol: 'TMUS', company: 'T-Mobile US, Inc.', weight: '1.21%', sector: 'Communication Services', bubefsm1: 0.33, bubefsm2: 0.74, bubefsm5: 1.0, bubefsm15: 1.74, bubefsm30: 2.2, bubefs_1h: 3.3 },
                { symbol: 'AMD', company: 'Advanced Micro Devices, Inc.', weight: '1.15%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 1.0, bubefsm5: 1.74, bubefsm15: 2.2, bubefsm30: 4.17, bubefs_1h: 6.6 },
                { symbol: 'LIN', company: 'Linde plc', weight: '1.08%', sector: 'Industrials', bubefsm1: 0.33, bubefsm2: 0.74, bubefsm5: 1.0, bubefsm15: 1.74, bubefsm30: 2.2, bubefs_1h: 3.3 },
                { symbol: 'INTU', company: 'Intuit Inc.', weight: '1.02%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 1.74, bubefsm5: 2.2, bubefsm15: 3.3, bubefsm30: 4.17, bubefs_1h: 6.6 },
                { symbol: 'PEP', company: 'PepsiCo, Inc.', weight: '0.98%', sector: 'Consumer Staples', bubefsm1: 0.33, bubefsm2: 0.33, bubefsm5: 0.47, bubefsm15: 0.74, bubefsm30: 1.0, bubefs_1h: 1.47 },
                { symbol: 'SHOP', company: 'Shopify Inc.', weight: '0.95%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 0.74, bubefsm5: 1.0, bubefsm15: 1.74, bubefsm30: 2.2, bubefs_1h: 3.3 },
                { symbol: 'BKNG', company: 'Booking Holdings Inc.', weight: '0.92%', sector: 'Consumer Discretionary', bubefsm1: 0.33, bubefsm2: 0, bubefsm5: 0, bubefsm15: 0, bubefsm30: 0, bubefs_1h: 0 },
                { symbol: 'ISRG', company: 'Intuitive Surgical, Inc.', weight: '0.89%', sector: 'Healthcare', bubefsm1: 0.33, bubefsm2: 1.0, bubefsm5: 1.74, bubefsm15: 2.2, bubefsm30: 4.17, bubefs_1h: 6.6 },
                { symbol: 'TXN', company: 'Texas Instruments Incorporated', weight: '0.86%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 0.74, bubefsm5: 1.0, bubefsm15: 1.74, bubefsm30: 2.2, bubefs_1h: 3.3 },
                { symbol: 'QCOM', company: 'QUALCOMM Incorporated', weight: '0.83%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 0.74, bubefsm5: 1.0, bubefsm15: 1.74, bubefsm30: 2.2, bubefs_1h: 3.3 },
                { symbol: 'AMGN', company: 'Amgen Inc.', weight: '0.80%', sector: 'Healthcare', bubefsm1: 0.33, bubefsm2: 0.74, bubefsm5: 1.0, bubefsm15: 1.74, bubefsm30: 2.2, bubefs_1h: 3.3 },
                { symbol: 'ADBE', company: 'Adobe Inc.', weight: '0.77%', sector: 'Technology', bubefsm1: 0.33, bubefsm2: 0.74, bubefsm5: 1.0, bubefsm15: 1.74, bubefsm30: 2.2, bubefs_1h: 3.3 },
                { symbol: 'TQQQ', company: 'QQQ Triple Index', weight: '0.74%', sector: 'Index', bubefsm1: 0.33, bubefsm2: 0.33, bubefsm5: 0.47, bubefsm15: 0.74, bubefsm30: 1.0, bubefs_1h: 1.47 }
            ];

            // Add rows for each symbol
            defaultData.forEach(data => {
                const symbolRow = document.createElement('tr');
                symbolRow.className = 'hover:bg-gray-50';
                symbolRow.innerHTML = `
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${data.symbol}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="symbol">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${data.company || ''}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="company">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${data.weight || ''}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="weight">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${data.sector || ''}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="sector">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefsm1}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm1">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefsm2}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm2">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefsm5}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm5">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefsm15}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm15">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefsm30}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm30">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefs_1h}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefs_1h">
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-center">
                        <button type="button" onclick="this.closest('tr').remove()" class="px-1 py-0.5 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                container.appendChild(symbolRow);
            });

            this.showNotification('Default symbol data loaded successfully!', 'success');
        }

        createMultiIndicatorConfigurationForm(node, properties) {
            // Load symbol-specific thresholds if they exist
            const symbolThresholds = properties.symbolThresholds || [];
            const symbolThresholdsHTML = symbolThresholds.map(st => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${st.symbol}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="symbol">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefsm1 || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm1">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefsm2 || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm2">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefsm5 || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm5">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefsm15 || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm15">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefsm30 || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm30">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${st.bubefs_1h || ''}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefs_1h">
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-center">
                        <button type="button" onclick="this.closest('tr').remove()" class="px-1 py-0.5 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="font-semibold text-purple-800 mb-2 flex items-center">
                            <i class="fas fa-layer-group mr-2"></i>
                            Multi-Indicator Analysis System
                        </h4>
                        <p class="text-sm text-purple-700">
                            Tổng hợp tín hiệu từ 4 chỉ báo: MACD Multi-TF + SMA + RSI + Bollinger Bands
                        </p>
                    </div>
                    
                    <!-- Symbol Configuration -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-coins mr-2"></i>
                            Symbol Configuration
                        </h5>
                        
                        <div class="mb-3">
                            <button type="button" onclick="workflowBuilder.addMultiIndicatorSymbol()" class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 mr-2">
                                <i class="fas fa-plus mr-1"></i>Add Symbol
                            </button>
                            <button type="button" onclick="workflowBuilder.loadMultiIndicatorSymbols()" class="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700">
                                <i class="fas fa-download mr-1"></i>Load 25 Symbols
                            </button>
                        </div>
                        
                        <!-- Symbol Thresholds Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs border-collapse border border-gray-300">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="border border-gray-300 px-2 py-1 text-left">Symbol</th>
                                        <th class="border border-gray-300 px-2 py-1 text-center" title="MACD 1m">1m</th>
                                        <th class="border border-gray-300 px-2 py-1 text-center" title="MACD 2m">2m</th>
                                        <th class="border border-gray-300 px-2 py-1 text-center" title="MACD 5m">5m</th>
                                        <th class="border border-gray-300 px-2 py-1 text-center" title="MACD 15m">15m</th>
                                        <th class="border border-gray-300 px-2 py-1 text-center" title="MACD 30m">30m</th>
                                        <th class="border border-gray-300 px-2 py-1 text-center" title="MACD 1h">1h</th>
                                        <th class="border border-gray-300 px-2 py-1 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="multiIndicatorSymbolsTableBody">
                                    ${symbolThresholdsHTML}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Aggregation Configuration -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-puzzle-piece mr-2"></i>
                            Aggregation Settings
                        </h5>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Method</label>
                                <select id="aggregationMethod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="weighted_average" ${(properties.aggregation?.method || 'weighted_average') === 'weighted_average' ? 'selected' : ''}>Weighted Average</option>
                                    <option value="majority_vote" ${(properties.aggregation?.method || '') === 'majority_vote' ? 'selected' : ''}>Majority Vote</option>
                                    <option value="consensus" ${(properties.aggregation?.method || '') === 'consensus' ? 'selected' : ''}>Consensus</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Min Strategies</label>
                                <input type="number" id="minStrategies" value="${properties.aggregation?.minStrategies || 3}" min="2" max="4"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Consensus Threshold</label>
                                <input type="number" id="consensusThreshold" value="${properties.aggregation?.consensusThreshold || 0.7}" step="0.1" min="0.5" max="1.0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Confidence Threshold</label>
                                <input type="number" id="confidenceThreshold" value="${properties.aggregation?.confidenceThreshold || 0.6}" step="0.1" min="0.3" max="1.0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <!-- Custom Weights -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Custom Weights</label>
                            <div class="grid grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">MACD Multi-TF</label>
                                    <input type="number" id="weightMacdMulti" value="${properties.aggregation?.customWeights?.macd_multi || 0.3}" step="0.05" min="0" max="1"
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">SMA</label>
                                    <input type="number" id="weightSma" value="${properties.aggregation?.customWeights?.sma || 0.25}" step="0.05" min="0" max="1"
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">RSI</label>
                                    <input type="number" id="weightRsi" value="${properties.aggregation?.customWeights?.rsi || 0.2}" step="0.05" min="0" max="1"
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Bollinger Bands</label>
                                    <input type="number" id="weightBollinger" value="${properties.aggregation?.customWeights?.bollinger || 0.25}" step="0.05" min="0" max="1"
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Indicator Configuration Summary -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>
                            Configuration Summary
                        </h5>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <h6 class="font-medium text-gray-700 mb-2">MACD Multi-TF</h6>
                                <ul class="text-gray-600 space-y-1">
                                    <li>• Fast: 7, Slow: 113, Signal: 144</li>
                                    <li>• Timeframes: 1m, 2m, 5m, 15m, 30m, 1h</li>
                                    <li>• Weight: ${properties.aggregation?.customWeights?.macd_multi || 0.3}</li>
                                </ul>
                            </div>
                            <div>
                                <h6 class="font-medium text-gray-700 mb-2">SMA</h6>
                                <ul class="text-gray-600 space-y-1">
                                    <li>• Periods: 5, 10, 20, 50, 100, 200, 144</li>
                                    <li>• Timeframes: 1m, 2m, 5m, 15m, 30m, 1h, 4h</li>
                                    <li>• Weight: ${properties.aggregation?.customWeights?.sma || 0.25}</li>
                                </ul>
                            </div>
                            <div>
                                <h6 class="font-medium text-gray-700 mb-2">RSI</h6>
                                <ul class="text-gray-600 space-y-1">
                                    <li>• Period: 14</li>
                                    <li>• Timeframes: 5m, 15m, 30m, 1h, 4h</li>
                                    <li>• Weight: ${properties.aggregation?.customWeights?.rsi || 0.2}</li>
                                </ul>
                            </div>
                            <div>
                                <h6 class="font-medium text-gray-700 mb-2">Bollinger Bands</h6>
                                <ul class="text-gray-600 space-y-1">
                                    <li>• Period: 20, StdDev: 2</li>
                                    <li>• Timeframes: 15m, 30m, 1h, 4h</li>
                                    <li>• Weight: ${properties.aggregation?.customWeights?.bollinger || 0.25}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        addMultiIndicatorSymbol() {
            const container = document.getElementById('multiIndicatorSymbolsTableBody');
            if (!container) return;

            const symbolRow = document.createElement('tr');
            symbolRow.className = 'hover:bg-gray-50';
            symbolRow.innerHTML = `
                <td class="border border-gray-300 px-2 py-1">
                    <input type="text" placeholder="NVDA" class="w-full px-1 py-0.5 text-xs border rounded" data-field="symbol">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="0.33" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm1">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="0.47" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm2">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="0.47" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm5">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="0.22" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm15">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="0.47" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm30">
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" placeholder="0.07" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefs_1h">
                </td>
                <td class="border border-gray-300 px-2 py-1 text-center">
                    <button type="button" onclick="this.closest('tr').remove()" class="px-1 py-0.5 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            container.appendChild(symbolRow);
        }

        loadMultiIndicatorSymbols() {
            const container = document.getElementById('multiIndicatorSymbolsTableBody');
            if (!container) return;

            // Clear existing data
            container.innerHTML = '';

            // Default data - 25 symbols for Multi-Indicator
            const defaultData = [
                { symbol: 'NVDA', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'MSFT', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'AAPL', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'GOOGL', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'AMZN', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'TSLA', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'META', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'NFLX', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'AMD', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'INTC', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'CRM', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'ORCL', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'ADBE', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'PYPL', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'UBER', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'SQ', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'ZM', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'SHOP', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'ROKU', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'PTON', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'PELOTON', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'DOCU', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'SNOW', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'PLTR', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 },
                { symbol: 'COIN', bubefsm1: 0.33, bubefsm2: 0.47, bubefsm5: 0.47, bubefsm15: 0.22, bubefsm30: 0.47, bubefs_1h: 0.07 }
            ];

            // Add rows for each symbol
            defaultData.forEach(data => {
                const symbolRow = document.createElement('tr');
                symbolRow.className = 'hover:bg-gray-50';
                symbolRow.innerHTML = `
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${data.symbol}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="symbol">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefsm1}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm1">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefsm2}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm2">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefsm5}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm5">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefsm15}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm15">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefsm30}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefsm30">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${data.bubefs_1h}" step="0.01" class="w-full px-1 py-0.5 text-xs border rounded text-center" data-field="bubefs_1h">
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-center">
                        <button type="button" onclick="this.closest('tr').remove()" class="px-1 py-0.5 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                container.appendChild(symbolRow);
            });

            this.showNotification('Multi-Indicator symbols loaded successfully!', 'success');
        }


        createSMAConfigurationForm(node, properties) {
            return `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SMA Periods</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" value="18" ${(properties.periods || []).includes(18) ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">18 Periods</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="36" ${(properties.periods || []).includes(36) ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">36 Periods</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="48" ${(properties.periods || []).includes(48) ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">48 Periods</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="144" ${(properties.periods || []).includes(144) ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">144 Periods</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">7 Timeframes System</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" value="1m" ${(properties.timeframes || []).includes('1m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">1m (Weight: 2)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="2m" ${(properties.timeframes || []).includes('2m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">2m (Weight: 3)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="5m" ${(properties.timeframes || []).includes('5m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">5m (Weight: 4)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="15m" ${(properties.timeframes || []).includes('15m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">15m (Weight: 5)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="30m" ${(properties.timeframes || []).includes('30m') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">30m (Weight: 6)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="1h" ${(properties.timeframes || []).includes('1h') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">1h (Weight: 7)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="4h" ${(properties.timeframes || []).includes('4h') ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">4h (Weight: 8)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="tripleConfirmation" ${properties.tripleConfirmation ? 'checked' : ''} class="mr-2">
                        <label for="tripleConfirmation" class="text-sm font-medium text-gray-700">Triple Confirmation</label>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Confirmation</label>
                        <input type="number" id="minConfirmation" value="${properties.minConfirmation || 3}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Min Trend Consensus</label>
                            <input type="number" id="minTrendConsensus" value="${properties.minTrendConsensus || 2}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <div class="text-xs text-gray-500 mt-1">Min khung lớn (1h, 4h) đồng thuận</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Min Entry Consensus</label>
                            <input type="number" id="minEntryConsensus" value="${properties.minEntryConsensus || 2}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <div class="text-xs text-gray-500 mt-1">Min khung nhỏ (1m, 2m, 5m) đồng thuận</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Confidence</label>
                        <input type="range" id="minConfidence" min="0" max="1" step="0.1" value="${properties.minConfidence || 0.5}" 
                               class="w-full">
                        <div class="text-sm text-gray-600 mt-1">Value: <span id="minConfidenceValue">${properties.minConfidence || 0.5}</span></div>
                    </div>
                    
                    <div class="mt-2 p-2 bg-orange-50 rounded text-xs text-orange-700">
                        <strong>SMA 7 Timeframes Strategy:</strong> Khung lớn (1h, 4h) tìm xu hướng, khung nhỏ (1m, 2m, 5m) tìm điểm vào lệnh
                    </div>
                </div>
            `;
        }

        createVNMACD7TFConfigurationForm(node, properties) {
            return `
                <div class="space-y-4">
                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center">
                            <i class="fas fa-star text-blue-500 mr-2"></i>
                            <span class="text-sm font-medium text-blue-700">VN MACD 7 Timeframes - Production Ready</span>
                        </div>
                        <p class="text-xs text-blue-600 mt-1">Chiến lược MACD 7 khung thời gian cho thị trường VN</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="col-span-1 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dùng tham số từ DB</label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="useDbParams" ${properties.useDbParams ? 'checked' : ''} class="mr-2">
                                <span class="text-sm text-gray-700">Enable</span>
                            </label>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">MACD Template</label>
                            <select id="templateId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Zone Template</label>
                            <select id="zoneTemplateId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fast Period</label>
                            <input type="number" id="fastPeriod" value="${properties.fastPeriod || 12}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Slow Period</label>
                            <input type="number" id="slowPeriod" value="${properties.slowPeriod || 26}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Signal Period</label>
                            <input type="number" id="signalPeriod" value="${properties.signalPeriod || 9}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">7 Timeframes System (Fixed)</label>
                        <div class="grid grid-cols-2 gap-2 p-3 bg-gray-50 rounded">
                            <div class="flex items-center justify-between">
                                <span class="text-sm">1m</span>
                                <span class="text-xs text-gray-500">Weight: 2</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">2m</span>
                                <span class="text-xs text-gray-500">Weight: 3</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">5m</span>
                                <span class="text-xs text-gray-500">Weight: 4</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">15m</span>
                                <span class="text-xs text-gray-500">Weight: 5</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">30m</span>
                                <span class="text-xs text-gray-500">Weight: 6</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">1h</span>
                                <span class="text-xs text-gray-500">Weight: 7</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">4h</span>
                                <span class="text-xs text-gray-500">Weight: 8</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="useZones" ${properties.useZones ? 'checked' : ''} class="mr-2">
                        <label for="useZones" class="text-sm font-medium text-gray-700">Use Zone System</label>
                    </div>
                    
                    <!-- Matrix Table Configuration -->
                    <div class="mt-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-sm text-gray-700">VN MACD 7 Timeframes - Zone Thresholds Matrix</h4>
                            <div class="flex gap-2">
                                <button type="button" class="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700" onclick="workflowBuilder.loadFromDatabase()">
                                    <i class="fas fa-database mr-1"></i>Load from DB
                                </button>
                                <button type="button" class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700" onclick="workflowBuilder.saveAllTimeframes()">
                                    <i class="fas fa-save mr-1"></i>Save All
                                </button>
                                <button type="button" class="px-3 py-1 text-xs bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200" onclick="workflowBuilder.resetAllToDefault()">
                                    <i class="fas fa-undo mr-1"></i>Reset All
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="min-w-full text-xs">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-700">Zone / Momentum</th>
                                        ${['4h', '1h', '30m', '15m', '5m', '2m', '1m'].map(tf => `
                                            <th class="px-2 py-2 text-center font-medium text-gray-700">
                                                <div class="flex flex-col items-center">
                                                    <span class="text-sm">${tf}</span>
                                                    <span class="text-xs text-gray-500">${this.getTimeframeCategory(tf)}</span>
                                                </div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- MACD Parameters Row -->
                                    <tr class="border-t bg-blue-50">
                                        <td class="px-3 py-2 font-medium text-blue-700">MACD Fast</td>
                                        ${['4h', '1h', '30m', '15m', '5m', '2m', '1m'].map(tf => `
                                            <td class="px-2 py-1 text-center">
                                                <input type="number" class="w-16 px-1 py-1 text-center border rounded macd-fast" 
                                                       data-tf="${tf}" value="12" 
                                                       onchange="workflowBuilder.autoSaveTimeframe('${tf}')">
                                            </td>
                                        `).join('')}
                                        </tr>
                                    <tr class="border-t bg-blue-50">
                                        <td class="px-3 py-2 font-medium text-blue-700">MACD Slow</td>
                                        ${['4h', '1h', '30m', '15m', '5m', '2m', '1m'].map(tf => `
                                            <td class="px-2 py-1 text-center">
                                                <input type="number" class="w-16 px-1 py-1 text-center border rounded macd-slow" 
                                                       data-tf="${tf}" value="26" 
                                                       onchange="workflowBuilder.autoSaveTimeframe('${tf}')">
                                            </td>
                                    `).join('')}
                                    </tr>
                                    <tr class="border-t bg-blue-50">
                                        <td class="px-3 py-2 font-medium text-blue-700">MACD Signal</td>
                                        ${['4h', '1h', '30m', '15m', '5m', '2m', '1m'].map(tf => `
                                            <td class="px-2 py-1 text-center">
                                                <input type="number" class="w-16 px-1 py-1 text-center border rounded macd-signal" 
                                                       data-tf="${tf}" value="9" 
                                                       onchange="workflowBuilder.autoSaveTimeframe('${tf}')">
                                            </td>
                                        `).join('')}
                                    </tr>
                                    <tr class="border-t bg-blue-50">
                                        <td class="px-3 py-2 font-medium text-blue-700">Min Confidence</td>
                                        ${['4h', '1h', '30m', '15m', '5m', '2m', '1m'].map(tf => `
                                            <td class="px-2 py-1 text-center">
                                                <input type="number" step="0.1" min="0" max="1" class="w-16 px-1 py-1 text-center border rounded macd-minconf" 
                                                       data-tf="${tf}" value="0.6" 
                                                       onchange="workflowBuilder.autoSaveTimeframe('${tf}')">
                                            </td>
                                        `).join('')}
                                    </tr>
                                    
                                    <!-- Zone Thresholds -->
                                    ${this.getZoneThresholdsRows()}
                                    
                                    <!-- BARS Momentums -->
                                    ${this.getBarsMomentumsRows()}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3 text-xs text-gray-500">
                            <p><strong>Instructions:</strong> Click any cell to edit directly. Changes are auto-saved. Use "Save All" to persist to database.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Min Trend Consensus</label>
                            <input type="number" id="minTrendConsensus" value="${properties.minTrendConsensus || 2}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <div class="text-xs text-gray-500 mt-1">Min khung lớn (1h, 4h) đồng thuận</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Min Entry Consensus</label>
                            <input type="number" id="minEntryConsensus" value="${properties.minEntryConsensus || 2}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <div class="text-xs text-gray-500 mt-1">Min khung nhỏ (1m, 2m, 5m) đồng thuận</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Confidence</label>
                        <input type="range" id="minConfidence" min="0" max="1" step="0.1" value="${properties.minConfidence || 0.6}" 
                               class="w-full">
                        <div class="text-sm text-gray-600 mt-1">Value: <span id="minConfidenceValue">${properties.minConfidence || 0.6}</span></div>
                    </div>
                    
                    <div class="mt-2 p-3 bg-green-50 rounded text-xs text-green-700 border border-green-200">
                        <strong>VN MACD 7 Timeframes Strategy:</strong><br>
                        • Khung lớn (1h, 4h) tìm xu hướng chính<br>
                        • Khung nhỏ (1m, 2m, 5m) tìm điểm vào lệnh<br>
                        • Tích hợp với hệ thống hiện tại
                    </div>
                </div>
            `;
        }

        createVNSMA7TFConfigurationForm(node, properties) {
            return `
                <div class="space-y-4">
                    <div class="p-3 bg-orange-50 rounded-lg border border-orange-200">
                        <div class="flex items-center">
                            <i class="fas fa-star text-orange-500 mr-2"></i>
                            <span class="text-sm font-medium text-orange-700">VN SMA 7 Timeframes - Production Ready</span>
                        </div>
                        <p class="text-xs text-orange-600 mt-1">Chiến lược SMA 7 khung thời gian cho thị trường VN</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="col-span-1 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dùng cấu hình SMA từ DB</label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="useDbSmaConfig" ${properties.useDbSmaConfig ? 'checked' : ''} class="mr-2">
                                <span class="text-sm text-gray-700">Enable</span>
                            </label>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">SMA Template</label>
                            <select id="smaTemplateId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="col-span-1"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SMA Periods</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" value="18" ${(properties.periods || []).includes(18) ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">18 Periods</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="36" ${(properties.periods || []).includes(36) ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">36 Periods</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="48" ${(properties.periods || []).includes(48) ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">48 Periods</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="144" ${(properties.periods || []).includes(144) ? 'checked' : ''} class="mr-2">
                                <span class="text-sm">144 Periods</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">7 Timeframes System (Fixed)</label>
                        <div class="grid grid-cols-2 gap-2 p-3 bg-gray-50 rounded">
                            <div class="flex items-center justify-between">
                                <span class="text-sm">1m</span>
                                <span class="text-xs text-gray-500">Weight: 2</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">2m</span>
                                <span class="text-xs text-gray-500">Weight: 3</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">5m</span>
                                <span class="text-xs text-gray-500">Weight: 4</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">15m</span>
                                <span class="text-xs text-gray-500">Weight: 5</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">30m</span>
                                <span class="text-xs text-gray-500">Weight: 6</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">1h</span>
                                <span class="text-xs text-gray-500">Weight: 7</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">4h</span>
                                <span class="text-xs text-gray-500">Weight: 8</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Template Params Table (Editable 7 TF) -->
                    <div class="mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-sm text-gray-700">Template Params (per timeframe)</h4>
                            <div class="flex gap-2">
                                <button type="button" class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200" onclick="workflowBuilder.applySmaRowToAll()">Apply to all</button>
                                <button type="button" class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200" onclick="workflowBuilder.copySmaDown()">Copy down</button>
                                <button type="button" class="px-2 py-1 text-xs bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200" onclick="workflowBuilder.reloadTemplateValues('SMA')">Reset to template</button>
                                <button type="button" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700" onclick="workflowBuilder.saveTemplateValues('SMA')">Save Template</button>
                            </div>
                        </div>
                        <div class="overflow-auto border rounded">
                            <table class="min-w-full text-xs">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-2 text-left">TF</th>
                                        <th class="px-2 py-2">Periods</th>
                                        <th class="px-2 py-2">MinConf</th>
                                        <th class="px-2 py-2">Triple</th>
                                        <th class="px-2 py-2">MinConfirm</th>
                                    </tr>
                                </thead>
                                <tbody id="smaTemplateTableBody">
                                    ${['1m', '2m', '5m', '15m', '30m', '1h', '4h'].map(tf => `
                                        <tr data-tf="${tf}" class="border-t">
                                            <td class="px-2 py-1 text-gray-600">${tf}</td>
                                            <td class="px-2 py-1"><input type="text" placeholder="18,36,48,144" class="w-40 px-2 py-1 border rounded sma-periods"></td>
                                            <td class="px-2 py-1"><input type="number" step="0.1" min="0" max="1" class="w-20 px-2 py-1 border rounded sma-minconf"></td>
                                            <td class="px-2 py-1 text-center"><input type="checkbox" class="sma-triple"></td>
                                            <td class="px-2 py-1"><input type="number" step="1" class="w-20 px-2 py-1 border rounded sma-minconfirm"></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="tripleConfirmation" ${properties.tripleConfirmation ? 'checked' : ''} class="mr-2">
                        <label for="tripleConfirmation" class="text-sm font-medium text-gray-700">Triple Confirmation</label>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Confirmation</label>
                        <input type="number" id="minConfirmation" value="${properties.minConfirmation || 3}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Min Trend Consensus</label>
                            <input type="number" id="minTrendConsensus" value="${properties.minTrendConsensus || 2}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <div class="text-xs text-gray-500 mt-1">Min khung lớn (1h, 4h) đồng thuận</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Min Entry Consensus</label>
                            <input type="number" id="minEntryConsensus" value="${properties.minEntryConsensus || 2}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <div class="text-xs text-gray-500 mt-1">Min khung nhỏ (1m, 2m, 5m) đồng thuận</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Confidence</label>
                        <input type="range" id="minConfidence" min="0" max="1" step="0.1" value="${properties.minConfidence || 0.5}" 
                               class="w-full">
                        <div class="text-sm text-gray-600 mt-1">Value: <span id="minConfidenceValue">${properties.minConfidence || 0.5}</span></div>
                    </div>
                    
                    <div class="mt-2 p-3 bg-orange-50 rounded text-xs text-orange-700 border border-orange-200">
                        <strong>VN SMA 7 Timeframes Strategy:</strong><br>
                        • Khung lớn (1h, 4h) tìm xu hướng chính<br>
                        • Khung nhỏ (1m, 2m, 5m) tìm điểm vào lệnh<br>
                        • Tích hợp với hệ thống hiện tại
                    </div>
                </div>
            `;
        }

        createDefaultConfigurationForm(node, properties) {
            return `
                <div class="space-y-4">
                    <div class="text-center py-8">
                        <i class="fas fa-cog text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">Configuration form for ${node.type} node</p>
                        <p class="text-sm text-gray-500 mt-2">This node type doesn't have a specific configuration form yet.</p>
                    </div>
                </div>
            `;
        }

        async saveNodeConfiguration(nodeId) {
            try {
                console.log('saveNodeConfiguration called for nodeId:', nodeId);
                const node = this.nodes.get(nodeId);
                if (!node) {
                    console.error('Node not found:', nodeId);
                    return;
                }
                console.log('Node found:', node);

                // Use the same logic as auto-save
                const properties = this.collectCurrentFormData(node.type);

                console.log('Collected properties:', properties);

                // Update node properties
                node.properties = properties;
                this.nodeProperties.set(nodeId, properties);

                console.log('Node properties updated');

                // Update node display
                this.updateNodeDisplay(nodeId);

                console.log('Node display updated');

                // Close modal
                closeNodeConfigModal();

                // Show success notification
                this.showNotification('Node configuration saved successfully', 'success');

                // Auto-save workflow to database if we have a workflow ID
                if (this.currentWorkflowId) {
                    console.log('Auto-saving workflow to database...');
                    await this.autoSaveWorkflowToDatabase();
                }

            } catch (error) {
                console.error('Error saving node configuration:', error);
                this.showNotification('Error saving configuration: ' + error.message, 'error');
            }
        }

        async autoSaveWorkflowToDatabase() {
            try {
                if (!this.currentWorkflowId) {
                    console.log('No current workflow ID, skipping auto-save');
                    return;
                }

                // Collect current workflow data
                const nodes = Array.from(this.nodes.values());
                const connections = this.connections || [];
                const properties = Object.fromEntries(this.nodeProperties || new Map());

                const workflow = {
                    id: this.currentWorkflowId,
                    name: this.currentWorkflowMeta?.name || 'Untitled Workflow',
                    description: this.currentWorkflowMeta?.description || 'Trading workflow',
                    nodes: nodes,
                    connections: connections,
                    properties: properties,
                    workflow_meta: {
                        updated: new Date().toISOString(),
                        version: '1.0.0',
                        builder: 'Workflow Builder'
                    }
                };

                console.log('Auto-saving workflow to database:', {
                    workflowId: this.currentWorkflowId,
                    nodesCount: nodes.length,
                    connectionsCount: connections.length,
                    propertiesCount: Object.keys(properties).length
                });

                const response = await fetch(`/api/workflow/update/${this.currentWorkflowId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(workflow)
                });

                const result = await response.json();

                if (result.success) {
                    console.log('Workflow auto-saved successfully');
                    this.showAutoSaveIndicator('Workflow saved to database');
                } else {
                    console.error('Error auto-saving workflow:', result.error);
                    this.showNotification('Error saving to database: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error in auto-save workflow:', error);
                this.showNotification('Error saving to database: ' + error.message, 'error');
            }
        }


        // ===== Zone Thresholds Editor (MACD) =====
        async openZoneThresholdsEditor(targetTimeframe = null) {
            try {
                const templateId = document.getElementById('templateId')?.value || '';
                if (!templateId) {
                    this.showNotification('Chọn template trước khi chỉnh zone thresholds', 'warning');
                    return;
                }

                // If targetTimeframe is specified, use mock data for that specific TF
                let data;
                if (targetTimeframe) {
                    data = this.getMockZoneThresholdsForTimeframe(targetTimeframe);
                } else {
                    const res = await fetch(`/api/threshold/template-values?strategy=MACD&templateId=${encodeURIComponent(templateId)}&market=VN`);
                    data = await res.json();
                }

                this.showZoneThresholdsModal(this.renderZoneThresholdsModal(templateId, targetTimeframe));
                this.populateZoneThresholdsForm(data, targetTimeframe);
                // Populate defaults selector with available templates and preselect current
                await this.populateDefaultTemplateOptions('MACD', templateId);
                this.attachZoneThresholdInputHandlers();
                this.validateZoneThresholds();
            } catch (e) {
                this.showNotification(`Load zone thresholds failed: ${e.message}`, 'error');
            }
        }

        renderZoneThresholdsModal(templateId, targetTimeframe = null) {
            const title = targetTimeframe ?
                `Edit Zone Thresholds - ${templateId} (${targetTimeframe})` :
                `Edit Zone Thresholds - ${templateId}`;

            // If targetTimeframe is specified, only show that TF
            const timeframesToShow = targetTimeframe ? [targetTimeframe] : ['4h', '1h', '30m', '15m', '5m', '2m', '1m'];

            return `
            <div class="modal-overlay" id="zoneThresholdsModal" data-template-id="${templateId}" data-target-tf="${targetTimeframe || ''}">
                <div class="modal" style="max-width: 900px; width: 95%">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-sliders-h mr-2"></i>
                            ${title}
                        </h3>
                        <button class="modal-close" aria-label="Close zone thresholds editor" onclick="workflowBuilder.closeZoneThresholdsModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-600">Load defaults from</label>
                                <select id="zoneDefaultTemplate" class="px-2 py-1 border rounded text-sm"></select>
                                <button id="btnLoadZoneDefaults" class="px-2 py-1 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700">Load defaults</button>
                                <button id="btnTestSample" class="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700">Test Sample</button>
                            </div>
                            <div class="text-[11px] text-gray-500">Chọn template khác để nhập giá trị mặc định từ DB</div>
                        </div>
                        <div class="text-xs text-gray-600 mb-3">Nhập ngưỡng theo định dạng: ví dụ FMACD ">=3.0, >=2.2, >=1.74, >=1.47, >=1.0, >=0.74, >=0.47, >=0.33, >=0.22"; BARS có đúng 5 giá trị.</div>
                        <div id="zoneValidationSummary" class="hidden text-xs mb-3 p-2 rounded bg-red-50 text-red-700"></div>
                        <div class="space-y-4" id="zoneThresholdsContainer">
                            ${timeframesToShow.map(tf => `
                                <div class="border rounded p-3">
                                <div class="flex items-baseline justify-between mb-2">
                                    <div class="font-semibold text-sm">${this.getTfTitle(tf)}</div>
                                    <div class="text-[11px] text-gray-500">MACD MT & Zoning</div>
                                        </div>
                                <div class="text-[12px] border rounded">
                                    <div class="grid grid-cols-3 bg-gray-50 px-2 py-1 font-semibold">
                                        <div>Zone</div>
                                        <div>FMACD</div>
                                        <div>SMACD</div>
                                        </div>
                                    ${['IgR', 'Greed', 'Bull', 'Pos', 'Neutral', 'Neg', 'Bear', 'Fear', 'Panic'].map((z, i) => `
                                    <div class="grid grid-cols-3 px-2 py-1 ${i % 2 ? 'bg-white' : 'bg-gray-50'}">
                                        <div class="${i < 4 ? 'text-green-600' : i === 4 ? 'italic text-gray-700' : 'text-red-600'} flex items-center">${this.getZoneTitle(z)}</div>
                                        <div class="px-1">
                                            <input type="text" class="w-full px-1 py-0.5 text-[11px] border-0 bg-transparent focus:bg-white focus:border focus:border-blue-300 rounded" 
                                                   data-tf="${tf}" data-type="fmacd" data-zone="${z}" placeholder=">=3.0" 
                                                   onblur="workflowBuilder.validateZoneThresholds()" oninput="workflowBuilder.validateZoneThresholds()">
                                        </div>
                                        <div class="px-1">
                                            <input type="text" class="w-full px-1 py-0.5 text-[11px] border-0 bg-transparent focus:bg-white focus:border focus:border-blue-300 rounded" 
                                                   data-tf="${tf}" data-type="smacd" data-zone="${z}" placeholder=">=2.2" 
                                                   onblur="workflowBuilder.validateZoneThresholds()" oninput="workflowBuilder.validateZoneThresholds()">
                                    </div>
                                </div>
                            `).join('')}
                                    <div class="px-2 py-2 border-t">
                                        <div class="font-semibold text-blue-700 text-[12px] mb-1">BARS Momentums</div>
                                        <div class="grid grid-cols-5 gap-1">
                                            ${['Hurricane', 'Storm', 'StrongWind', 'Windy', 'Neutral'].map((z, i) => `
                                            <div class="text-center">
                                                <div class="text-[10px] ${z === 'Hurricane' || z === 'Storm' ? 'text-blue-700' : 'text-gray-700'} mb-1">${z}</div>
                                                <input type="text" class="w-full px-1 py-0.5 text-[10px] border border-gray-200 rounded text-center" 
                                                       data-tf="${tf}" data-type="bars" data-zone="${z}" placeholder="3.0" 
                                                       onblur="workflowBuilder.validateZoneThresholds()" oninput="workflowBuilder.validateZoneThresholds()">
                                            </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2 text-[10px] text-red-600 hidden" data-error-summary="${tf}"></div>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="workflowBuilder.closeZoneThresholdsModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button id="zoneSaveBtn" onclick="workflowBuilder.saveZoneThresholds('${templateId}')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Save</button>
                    </div>
                </div>
            </div>
        `;
        }

        populateZoneThresholdsForm(payload, targetTimeframe = null) {
            try {
                console.log('populateZoneThresholdsForm called with:', payload, 'targetTimeframe:', targetTimeframe);

                if (!payload || !payload.timeframes) {
                    console.warn('No timeframes data in payload');
                    return;
                }

                const tfMap = new Map((payload.timeframes || []).map(x => [x.tf, x]));
                let populatedCount = 0;

                // If targetTimeframe is specified, only populate that TF
                const timeframesToProcess = targetTimeframe ? [targetTimeframe] : ['4h', '1h', '30m', '15m', '5m', '2m', '1m'];

                timeframesToProcess.forEach(tf => {
                    const item = tfMap.get(tf);
                    if (!item) {
                        console.log(`No data for timeframe ${tf}`);
                        return;
                    }

                    const zt = (item.params && item.params.zone_thresholds) || {};
                    const f = zt.FMACD || [];
                    const s = zt.SMACD || [];
                    const b = zt.BARS || [];

                    console.log(`Populating ${tf}:`, { f, s, b });

                    const zones = ['IgR', 'Greed', 'Bull', 'Pos', 'Neutral', 'Neg', 'Bear', 'Fear', 'Panic'];
                    const bars = ['Hurricane', 'Storm', 'StrongWind', 'Windy', 'Neutral'];

                    // Populate FMACD inputs
                    zones.forEach((z, idx) => {
                        const selector = `input[data-tf="${tf}"][data-type="fmacd"][data-zone="${z}"]`;
                        const input = document.querySelector(selector);
                        if (input) {
                            input.value = f[idx] || '';
                            console.log(`✓ Set FMACD ${tf}-${z} to:`, f[idx] || '');
                            populatedCount++;
                        } else {
                            console.warn(`✗ FMACD input not found: ${selector}`);
                        }
                    });

                    // Populate SMACD inputs
                    zones.forEach((z, idx) => {
                        const selector = `input[data-tf="${tf}"][data-type="smacd"][data-zone="${z}"]`;
                        const input = document.querySelector(selector);
                        if (input) {
                            input.value = s[idx] || '';
                            console.log(`✓ Set SMACD ${tf}-${z} to:`, s[idx] || '');
                            populatedCount++;
                        } else {
                            console.warn(`✗ SMACD input not found: ${selector}`);
                        }
                    });

                    // Populate BARS inputs
                    bars.forEach((z, idx) => {
                        const selector = `input[data-tf="${tf}"][data-type="bars"][data-zone="${z}"]`;
                        const input = document.querySelector(selector);
                        if (input) {
                            input.value = b[idx] || '';
                            console.log(`✓ Set BARS ${tf}-${z} to:`, b[idx] || '');
                            populatedCount++;
                        } else {
                            console.warn(`✗ BARS input not found: ${selector}`);
                        }
                    });
                });

                console.log(`Total inputs populated: ${populatedCount}`);

            } catch (e) {
                console.error('populateZoneThresholdsForm error', e);
            }
        }

        attachZoneThresholdInputHandlers() {
            // Close on overlay click or Escape
            const overlay = document.getElementById('zoneThresholdsModal');
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        e.stopPropagation();
                        this.closeZoneThresholdsModal();
                    }
                });
            }
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('zoneThresholdsModal');
                    if (modal) {
                        e.stopPropagation();
                        this.closeZoneThresholdsModal();
                        document.removeEventListener('keydown', escHandler);
                    }
                }
            };
            document.addEventListener('keydown', escHandler);

            // Defaults loader
            const btn = document.getElementById('btnLoadZoneDefaults');
            if (btn) {
                btn.addEventListener('click', async () => {
                    await this.loadZoneDefaultsFromDb();
                });
            }

            // Test sample button
            const testBtn = document.getElementById('btnTestSample');
            if (testBtn) {
                testBtn.addEventListener('click', () => {
                    this.testPopulateWithSampleData();
                });
            }
        }

        getTfTitle(tf) {
            const label = { '4h': '1D4hr (Long)', '1h': '1D1hr (Long)', '30m': '1D30Min (Mid)', '15m': '1D15Min (Mid)', '5m': '1D5Min (ShortLead)', '2m': '1D2Min (Short)', '1m': '1D1Min (Short)' }[tf] || tf;
            return label;
        }

        getZoneTitle(key) {
            const map = { IgR: 'IgR Zone', Greed: 'Greed Zone', Bull: 'Bull Zone', Pos: 'Pos Zone', Neutral: 'Neutral', Neg: 'Neg Zone', Bear: 'Bear Zone', Fear: 'Fear Zone', Panic: 'Panic Zone' };
            return map[key] || key;
        }

        collectZoneThresholdsFromInputs(tf) {
            const zones = ['IgR', 'Greed', 'Bull', 'Pos', 'Neutral', 'Neg', 'Bear', 'Fear', 'Panic'];
            const bars = ['Hurricane', 'Storm', 'StrongWind', 'Windy', 'Neutral'];

            const fmacd = zones.map(z => {
                const input = document.querySelector(`input[data-tf="${tf}"][data-type="fmacd"][data-zone="${z}"]`);
                return input?.value?.trim() || '';
            }).filter(Boolean);

            const smacd = zones.map(z => {
                const input = document.querySelector(`input[data-tf="${tf}"][data-type="smacd"][data-zone="${z}"]`);
                return input?.value?.trim() || '';
            }).filter(Boolean);

            const barsValues = bars.map(z => {
                const input = document.querySelector(`input[data-tf="${tf}"][data-type="bars"][data-zone="${z}"]`);
                return input?.value?.trim() || '';
            }).filter(Boolean);

            return { fmacd, smacd, bars: barsValues };
        }

        parseThresholdList(raw) {
            if (!raw) return [];
            return raw.split(',')
                .map(x => x.trim())
                .filter(Boolean);
        }

        validateZoneThresholds() {
            const tfs = ['4h', '1h', '30m', '15m', '5m', '2m', '1m'];
            const errors = [];
            const numOrComparator = /^(>=|<=|>|<)?\s*-?\d+(\.\d+)?$/;

            // reset borders and error summaries
            document.querySelectorAll('#zoneThresholdsContainer input').forEach(i => i.classList.remove('border-red-500'));
            document.querySelectorAll('[data-error-summary]').forEach(el => el.classList.add('hidden'));

            tfs.forEach(tf => {
                const tfErrors = [];
                const data = this.collectZoneThresholdsFromInputs(tf);

                // Validate FMACD
                const badFmacd = data.fmacd.find(v => !numOrComparator.test(v.replace(/\s+/g, '')));
                if (badFmacd) {
                    tfErrors.push(`FMACD: giá trị không hợp lệ "${badFmacd}"`);
                    document.querySelectorAll(`input[data-tf="${tf}"][data-type="fmacd"]`).forEach(i => i.classList.add('border-red-500'));
                }

                // Validate SMACD
                const badSmacd = data.smacd.find(v => !numOrComparator.test(v.replace(/\s+/g, '')));
                if (badSmacd) {
                    tfErrors.push(`SMACD: giá trị không hợp lệ "${badSmacd}"`);
                    document.querySelectorAll(`input[data-tf="${tf}"][data-type="smacd"]`).forEach(i => i.classList.add('border-red-500'));
                }

                // Validate BARS (must have exactly 5 values)
                if (data.bars.length > 0 && data.bars.length !== 5) {
                    tfErrors.push(`BARS: phải có đúng 5 giá trị (hiện tại: ${data.bars.length})`);
                    document.querySelectorAll(`input[data-tf="${tf}"][data-type="bars"]`).forEach(i => i.classList.add('border-red-500'));
                } else {
                    const badBars = data.bars.find(v => !numOrComparator.test(v.replace(/\s+/g, '')));
                    if (badBars) {
                        tfErrors.push(`BARS: giá trị không hợp lệ "${badBars}"`);
                        document.querySelectorAll(`input[data-tf="${tf}"][data-type="bars"]`).forEach(i => i.classList.add('border-red-500'));
                    }
                }

                if (tfErrors.length > 0) {
                    errors.push(`[${tf}] ${tfErrors.join(', ')}`);
                    const summary = document.querySelector(`[data-error-summary="${tf}"]`);
                    if (summary) {
                        summary.textContent = tfErrors.join(', ');
                        summary.classList.remove('hidden');
                    }
                }
            });

            const globalSummary = document.getElementById('zoneValidationSummary');
            const saveBtn = document.getElementById('zoneSaveBtn');
            if (errors.length > 0) {
                if (globalSummary) {
                    globalSummary.innerHTML = errors.map(e => `• ${e}`).join('<br>');
                    globalSummary.classList.remove('hidden');
                }
                if (saveBtn) saveBtn.disabled = true;
                return false;
            } else {
                if (globalSummary) globalSummary.classList.add('hidden');
                if (saveBtn) saveBtn.disabled = false;
                return true;
            }
        }

        async saveZoneThresholds(templateId) {
            try {
                console.log('saveZoneThresholds called for templateId:', templateId);

                if (!this.validateZoneThresholds()) {
                    this.showNotification('Sửa các lỗi trước khi lưu thresholds', 'warning');
                    return;
                }

                // Use the new collectZoneThresholdsData method
                const zoneData = this.collectZoneThresholdsData();
                console.log('Collected zone data:', zoneData);

                const tfs = ['4h', '1h', '30m', '15m', '5m', '2m', '1m'];
                const items = tfs.map(tf => {
                    const data = zoneData[tf];
                    const params = { zone_thresholds: { FMACD: data.fmacd, SMACD: data.smacd, BARS: data.bars } };
                    return { tf, params };
                });

                console.log('Sending zone items:', items);

                const res = await fetch('/api/threshold/template-values', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy: 'MACD', templateId, items })
                });

                console.log('Zone save response status:', res.status);
                const data = await res.json();
                console.log('Zone save response data:', data);

                if (!res.ok) {
                    this.showNotification(data.message || 'Save zone thresholds failed', 'error');
                    return;
                }
                this.showNotification('Zone thresholds saved successfully', 'success');
                await this.reloadTemplateValues('MACD');
                this.closeZoneThresholdsModal();
            } catch (e) {
                console.error('Save zone thresholds error:', e);
                this.showNotification(`Save zone thresholds failed: ${e.message}`, 'error');
            }
        }

        async populateDefaultTemplateOptions(strategy, currentTemplateId) {
            try {
                const select = document.getElementById('zoneDefaultTemplate');
                if (!select) return;
                select.innerHTML = '<option value="">Loading...</option>';
                const list = await this.fetchTemplatesFromApi(strategy);
                select.innerHTML = '';
                list.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.name;
                    if (t.id === currentTemplateId) opt.selected = true;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.warn('populateDefaultTemplateOptions error', e);
            }
        }

        async loadZoneDefaultsFromDb() {
            try {
                const select = document.getElementById('zoneDefaultTemplate');
                const templateId = select?.value || '';
                if (!templateId) {
                    this.showNotification('Chọn template để tải dữ liệu mặc định', 'warning');
                    return;
                }

                // Show loading state
                const btn = document.getElementById('btnLoadZoneDefaults');
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = 'Loading...';
                }

                const url = `/api/threshold/template-values?strategy=MACD&templateId=${encodeURIComponent(templateId)}&market=VN`;
                const res = await fetch(url);
                const data = await res.json();
                console.log('=== API Response ===');
                console.log('Status:', res.status);
                console.log('Data:', JSON.stringify(data, null, 2));

                if (data && (data.timeframes || []).length) {
                    // Wait a bit to ensure modal is fully rendered
                    await new Promise(resolve => setTimeout(resolve, 200));

                    // Check if inputs exist before populating
                    const testInput = document.querySelector('input[data-tf="4h"][data-type="fmacd"][data-zone="IgR"]');
                    console.log('Test input found:', testInput);

                    if (!testInput) {
                        console.warn('Input fields not found, modal may not be fully rendered');
                        this.showNotification('Modal chưa sẵn sàng, thử lại sau', 'warning');
                        return;
                    }

                    // Test with sample data first
                    console.log('=== Testing with sample data ===');
                    this.testPopulateWithSampleData();

                    console.log('=== Populating with real data ===');
                    this.populateZoneThresholdsForm(data);
                    this.validateZoneThresholds();
                    this.showNotification(`Đã nạp dữ liệu mặc định từ DB (${data.timeframes.length} timeframes)`, 'success');
                } else {
                    console.log('No timeframes data found');
                    this.showNotification('Không tìm thấy dữ liệu mặc định', 'warning');
                }
            } catch (e) {
                console.error('Load defaults error:', e);
                this.showNotification(`Tải dữ liệu mặc định thất bại: ${e.message}`, 'error');
            } finally {
                // Restore button state
                const btn = document.getElementById('btnLoadZoneDefaults');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Load defaults';
                }
            }
        }

        testPopulateWithSampleData() {
            // Test with hardcoded sample data for all 7 timeframes
            const sampleData = {
                timeframes: [
                    {
                        tf: '4h',
                        params: {
                            zone_thresholds: {
                                FMACD: ['>=3.0', '>=2.2', '>=1.74', '>=1.47', '>=1.0', '>=0.74', '>=0.47', '>=0.33', '>=0.22'],
                                SMACD: ['>=2.0', '>=1.74', '>=1.47', '>=1.0', '>=0.74', '>=0.47', '>=0.33', '>=0.22', '>=0.15'],
                                BARS: ['>=3.0', '>=2.0', '>=1.74', '>=1.47', '>=1.0']
                            }
                        }
                    },
                    {
                        tf: '1h',
                        params: {
                            zone_thresholds: {
                                FMACD: ['>=2.5', '>=1.8', '>=1.4', '>=1.2', '>=0.8', '>=0.6', '>=0.4', '>=0.3', '>=0.2'],
                                SMACD: ['>=1.7', '>=1.4', '>=1.2', '>=0.8', '>=0.6', '>=0.4', '>=0.3', '>=0.2', '>=0.15'],
                                BARS: ['>=2.5', '>=1.7', '>=1.4', '>=1.2', '>=0.8']
                            }
                        }
                    },
                    {
                        tf: '30m',
                        params: {
                            zone_thresholds: {
                                FMACD: ['>=2.0', '>=1.5', '>=1.2', '>=1.0', '>=0.7', '>=0.5', '>=0.35', '>=0.25', '>=0.18'],
                                SMACD: ['>=1.4', '>=1.2', '>=1.0', '>=0.7', '>=0.5', '>=0.35', '>=0.25', '>=0.18', '>=0.12'],
                                BARS: ['>=2.0', '>=1.4', '>=1.2', '>=1.0', '>=0.7']
                            }
                        }
                    },
                    {
                        tf: '15m',
                        params: {
                            zone_thresholds: {
                                FMACD: ['>=1.5', '>=1.2', '>=1.0', '>=0.8', '>=0.6', '>=0.4', '>=0.3', '>=0.22', '>=0.15'],
                                SMACD: ['>=1.1', '>=1.0', '>=0.8', '>=0.6', '>=0.4', '>=0.3', '>=0.22', '>=0.15', '>=0.1'],
                                BARS: ['>=1.5', '>=1.1', '>=1.0', '>=0.8', '>=0.6']
                            }
                        }
                    },
                    {
                        tf: '5m',
                        params: {
                            zone_thresholds: {
                                FMACD: ['>=1.2', '>=1.0', '>=0.8', '>=0.6', '>=0.5', '>=0.35', '>=0.25', '>=0.18', '>=0.12'],
                                SMACD: ['>=0.9', '>=0.8', '>=0.6', '>=0.5', '>=0.35', '>=0.25', '>=0.18', '>=0.12', '>=0.08'],
                                BARS: ['>=1.2', '>=0.9', '>=0.8', '>=0.6', '>=0.5']
                            }
                        }
                    },
                    {
                        tf: '2m',
                        params: {
                            zone_thresholds: {
                                FMACD: ['>=1.0', '>=0.8', '>=0.6', '>=0.5', '>=0.4', '>=0.3', '>=0.22', '>=0.15', '>=0.1'],
                                SMACD: ['>=0.7', '>=0.6', '>=0.5', '>=0.4', '>=0.3', '>=0.22', '>=0.15', '>=0.1', '>=0.07'],
                                BARS: ['>=1.0', '>=0.7', '>=0.6', '>=0.5', '>=0.4']
                            }
                        }
                    },
                    {
                        tf: '1m',
                        params: {
                            zone_thresholds: {
                                FMACD: ['>=0.8', '>=0.6', '>=0.5', '>=0.4', '>=0.3', '>=0.22', '>=0.15', '>=0.1', '>=0.07'],
                                SMACD: ['>=0.6', '>=0.5', '>=0.4', '>=0.3', '>=0.22', '>=0.15', '>=0.1', '>=0.07', '>=0.05'],
                                BARS: ['>=0.8', '>=0.6', '>=0.5', '>=0.4', '>=0.3']
                            }
                        }
                    }
                ]
            };

            console.log('Testing with sample data for all 7 timeframes:', sampleData);
            this.populateZoneThresholdsForm(sampleData);
        }
    }
    // Initialize workflow builder
    let workflowBuilder;
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded, initializing simple workflow builder...');
        try {
            // Keep menus visible for this view per user's request
            try { document.body?.removeAttribute('data-hide-menu'); } catch { }
            // Ensure sidebar items are visible and content offset accounts for it
            try {
                const sb = document.getElementById('sidebar');
                if (sb) sb.style.display = '';
                const mainContainer = document.querySelector('[x-data][class*="pl-"]');
                if (mainContainer) mainContainer.style.paddingLeft = '16rem'; /* 64 * 0.25rem */
            } catch (e) { console.warn('Padding/Sidebar adjust failed', e); }
            workflowBuilder = new SimpleWorkflowBuilder();
            console.log('Simple workflow builder initialized successfully');

            // Auto-load last edited workflow
            workflowBuilder.autoLoadLastWorkflow();

            // Update Save/Update button label based on currentWorkflowId
            workflowBuilder.updateSaveUIState = function () {
                const saveBtn = document.querySelector('button[onclick="openSaveModal()"]');
                if (!saveBtn) return;
                if (workflowBuilder.currentWorkflowId) {
                    saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i>Update';
                    saveBtn.className = 'px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm';
                } else {
                    saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i>Save';
                    saveBtn.className = 'px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm';
                }
            };
            workflowBuilder.updateSaveUIState();

            // Actions dropdown behavior and populate nodes
            try {
                const btn = document.getElementById('actionsBtn');
                const menu = document.getElementById('actionsMenu');
                const nodesWrap = document.getElementById('actionsNodes');
                if (btn && menu && nodesWrap) {
                    const nodes = [
                        { type: 'symbol', icon: 'fas fa-coins', label: 'Symbol' },
                        { type: 'data-source', icon: 'fas fa-database', label: 'Data Source' },
                        { type: 'vn-macd-7tf', icon: 'fas fa-chart-line', label: 'VN MACD 7TF' },
                        { type: 'vn-sma-7tf', icon: 'fas fa-chart-area', label: 'VN SMA 7TF' },
                        { type: 'macd', icon: 'fas fa-chart-line', label: 'MACD' },
                        { type: 'macd-multi', icon: 'fas fa-chart-line', label: 'MACD Multi-TF' },
                        { type: 'multi-indicator', icon: 'fas fa-layer-group', label: 'Multi-Indicator' },
                        { type: 'flexible-multi-indicator', icon: 'fas fa-cogs', label: 'Flexible Multi-Indicator' },
                        { type: 'sma', icon: 'fas fa-chart-area', label: 'SMA' },
                        { type: 'rsi', icon: 'fas fa-chart-bar', label: 'RSI' },
                        { type: 'bollinger', icon: 'fas fa-chart-pie', label: 'Bollinger' },
                        { type: 'condition', icon: 'fas fa-question-circle', label: 'Condition' },
                        { type: 'aggregation', icon: 'fas fa-puzzle-piece', label: 'Aggregation' },
                        { type: 'filter', icon: 'fas fa-filter', label: 'Filter' },
                        { type: 'output', icon: 'fas fa-signal', label: 'Output' },
                        { type: 'alert', icon: 'fas fa-bell', label: 'Alert' }
                    ];
                    nodesWrap.innerHTML = nodes.map(n => `<div class="dropdown-item" data-type="${n.type}"><i class="${n.icon} text-gray-600"></i>${n.label}</div>`).join('');
                    nodesWrap.querySelectorAll('.dropdown-item').forEach(el => {
                        el.addEventListener('click', () => {
                            const x = 80, y = 80; // default drop point
                            workflowBuilder.createNode(el.dataset.type, x, y);
                            menu.classList.remove('active');
                        });
                    });
                    btn.addEventListener('click', (e) => { e.stopPropagation(); menu.classList.toggle('active'); });
                    document.addEventListener('click', () => menu.classList.remove('active'));
                }
            } catch (e) { console.warn('Actions dropdown init failed', e); }

            // Sidebar toggle removed on workflow page (focus mode always on)
        } catch (error) {
            console.error('Error initializing simple workflow builder:', error);
        }
    });

    // Global functions for HTML onclick handlers
    function saveWorkflow() {
        workflowBuilder.saveWorkflow();
    }

    async function loadWorkflow() {
        try {
            // Get list of workflows
            const response = await fetch('/api/workflow/list');
            const result = await response.json();

            if (!result.success) {
                alert(`Error loading workflows: ${result.error}`);
                return;
            }

            if (result.workflows.length === 0) {
                alert('No workflows found. Please save a workflow first.');
                return;
            }

            // Create selection dialog
            let options = 'Select a workflow to load:\n\n';
            result.workflows.forEach((workflow, index) => {
                options += `${index + 1}. ${workflow.name} (${workflow.created_at})\n`;
            });

            const selection = prompt(options + '\nEnter number:');
            if (!selection) return;

            const index = parseInt(selection) - 1;
            if (index < 0 || index >= result.workflows.length) {
                alert('Invalid selection');
                return;
            }

            const selectedWorkflow = result.workflows[index];

            // Load the selected workflow
            const loadResponse = await fetch(`/api/workflow/load/${selectedWorkflow.id}`);
            const loadResult = await loadResponse.json();

            if (!loadResult.success) {
                alert(`Error loading workflow: ${loadResult.error}`);
                return;
            }

            // Clear current workflow
            workflowBuilder.clearWorkflow();

            // Load workflow data
            const workflow = loadResult.workflow;
            workflowBuilder.loadWorkflowData(workflow);

            alert(`Workflow "${workflow.name}" loaded successfully!`);

        } catch (error) {
            console.error('Error loading workflow:', error);
            alert('Error loading workflow. Check console for details.');
        }
    }


    function runWorkflow() {
        workflowBuilder.runWorkflow();
    }

    function clearWorkflow() {
        workflowBuilder.clearWorkflow();
    }

    // Modal functions
    function openSaveModal() {
        const modal = document.getElementById('saveModal');
        const nodeCount = document.getElementById('saveNodeCount');
        const connectionCount = document.getElementById('saveConnectionCount');
        const modalTitle = document.querySelector('#saveModal .modal-title');
        const saveButton = document.querySelector('#saveModal .modal-footer button:last-child');

        // Update counts
        nodeCount.textContent = workflowBuilder.nodes ? workflowBuilder.nodes.size : 0;
        connectionCount.textContent = workflowBuilder.connections ? workflowBuilder.connections.length : 0;

        // Check if updating existing workflow
        if (workflowBuilder.currentWorkflowId) {
            modalTitle.textContent = 'Update Workflow';
            saveButton.textContent = 'Update Workflow';
            saveButton.className = 'px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700';
        } else {
            modalTitle.textContent = 'Save Workflow';
            saveButton.textContent = 'Save Workflow';
            saveButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700';
        }

        // Clear form by default; if updating and workflowBuilder exposes metadata, prefill best-effort
        const nameInput = document.getElementById('workflowName');
        const descInput = document.getElementById('workflowDescription');
        if (workflowBuilder.currentWorkflowId && workflowBuilder.currentWorkflowMeta) {
            nameInput.value = workflowBuilder.currentWorkflowMeta.name || '';
            descInput.value = workflowBuilder.currentWorkflowMeta.description || '';
        } else {
            nameInput.value = '';
            descInput.value = '';
        }

        // Disable save button until a valid name is entered
        saveButton.disabled = nameInput.value.trim().length === 0;
        nameInput.removeEventListener('input', window.__wfNameInputListener);
        window.__wfNameInputListener = function () {
            saveButton.disabled = nameInput.value.trim().length === 0;
        };
        nameInput.addEventListener('input', window.__wfNameInputListener);

        modal.classList.add('active');
    }

    // Apply to Worker Modal
    function openApplyWorkerModal() {
        const existing = document.getElementById('applyWorkerModal');
        if (existing) existing.remove();
        const modal = document.createElement('div');
        modal.id = 'applyWorkerModal';
        modal.className = 'modal-overlay active';
        modal.innerHTML = `
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Apply Workflow to Worker</h3>
                <button class="modal-close" onclick="closeApplyWorkerModal()">&times;</button>
            </div>
            <div class="modal-body space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Worker</label>
                    <select id="workerSelect" class="w-full px-3 py-2 border border-gray-300 rounded">
                        <option>Loading workers...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Or enter Worker ID</label>
                    <input id="workerIdInput" type="text" placeholder="worker-123" class="w-full px-3 py-2 border border-gray-300 rounded" />
                </div>
                <div class="text-xs text-gray-500">Current Workflow ID: ${workflowBuilder.currentWorkflowId || '—'}</div>
            </div>
            <div class="modal-footer">
                <button onclick="closeApplyWorkerModal()" class="px-3 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button onclick="bindWorkflowToWorker()" class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Apply</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
        loadWorkersIntoSelect();
    }

    function closeApplyWorkerModal() {
        const modal = document.getElementById('applyWorkerModal');
        if (modal) modal.remove();
    }

    async function loadWorkersIntoSelect() {
        const sel = document.getElementById('workerSelect');
        if (!sel) return;
        try {
            const res = await fetch('/api/workers');
            const data = await res.json();
            const workers = Array.isArray(data) ? data : (data.workers || []);
            if (!workers.length) {
                throw new Error('empty');
            }
            sel.innerHTML = workers.map(w => `<option value="${w.id}">${w.name || ('Worker ' + w.id)}</option>`).join('');
        } catch (e) {
            // Fallback to alternative endpoint
            try {
                const res2 = await fetch('/api/worker/list');
                const data2 = await res2.json();
                const workers2 = Array.isArray(data2) ? data2 : (data2.workers || []);
                if (!workers2.length) throw new Error('empty');
                sel.innerHTML = workers2.map(w => `<option value="${w.id}">${w.name || ('Worker ' + w.id)}</option>`).join('');
            } catch (err) {
                sel.innerHTML = `<option disabled selected>Enter Worker ID below</option>`;
            }
        }
    }

    async function bindWorkflowToWorker() {
        if (!workflowBuilder.currentWorkflowId) {
            workflowBuilder.showNotification('Please save or load a workflow first', 'warning');
            return;
        }
        const sel = document.getElementById('workerSelect');
        const manual = document.getElementById('workerIdInput');
        const workerId = (sel && sel.value) ? sel.value : (manual && manual.value ? manual.value.trim() : '');
        if (!workerId) {
            workflowBuilder.showNotification('Please select or enter a worker', 'warning');
            return;
        }
        try {
            const res = await fetch(`/api/worker/${workerId}/assign-workflow`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ workflow_id: workflowBuilder.currentWorkflowId })
            });
            const data = await res.json();
            if (res.ok && (data.success !== false)) {
                workflowBuilder.showNotification('Workflow applied to worker successfully', 'success');
                closeApplyWorkerModal();
            } else {
                throw new Error(data.error || 'Assign failed');
            }
        } catch (e) {
            workflowBuilder.showNotification(`Failed to apply workflow: ${e.message}`, 'error');
        }
    }

    // Run controls
    async function stopWorkflowRun() {
        if (!workflowBuilder.currentWorkflowId) {
            workflowBuilder.showNotification('No workflow selected', 'warning');
            return;
        }
        try {
            let res = await fetch(`/api/workflow/stop/${workflowBuilder.currentWorkflowId}`, { method: 'POST' });
            let data = await res.json();
            if (!(res.ok && (data.success !== false)) && workflowBuilder.currentRunId) {
                // Fallback to run-id based endpoint
                res = await fetch(`/api/workflow/run/${workflowBuilder.currentRunId}/stop`, { method: 'POST' });
                data = await res.json();
            }
            if (res.ok && (data.success !== false)) {
                workflowBuilder.showNotification('Stop signal sent', 'info');
                workflowBuilder.currentRunStatus = 'stopped';
                workflowBuilder.updateControlButtonsState();
                workflowBuilder.refreshWorkflowRunStatus();
            } else {
                throw new Error(data.error || 'Stop failed');
            }
        } catch (e) {
            workflowBuilder.showNotification(`Failed to stop: ${e.message}`, 'error');
        }
    }

    async function restartWorkflowRun() {
        if (!workflowBuilder.currentWorkflowId) {
            workflowBuilder.showNotification('No workflow selected', 'warning');
            return;
        }
        try {
            let res = await fetch(`/api/workflow/restart/${workflowBuilder.currentWorkflowId}`, { method: 'POST' });
            let data = await res.json();
            if (!(res.ok && (data.success !== false)) && workflowBuilder.currentRunId) {
                // Fallback to run-id based endpoint
                res = await fetch(`/api/workflow/run/${workflowBuilder.currentRunId}/restart`, { method: 'POST' });
                data = await res.json();
            }
            if (res.ok && (data.success !== false)) {
                workflowBuilder.showNotification('Restart requested', 'success');
                // Update run ID if provided
                if (data.run_id) {
                    workflowBuilder.currentRunId = data.run_id;
                }
                workflowBuilder.currentRunStatus = 'running';
                workflowBuilder.updateControlButtonsState();
                workflowBuilder.refreshWorkflowRunStatus();
            } else {
                throw new Error(data.error || 'Restart failed');
            }
        } catch (e) {
            workflowBuilder.showNotification(`Failed to restart: ${e.message}`, 'error');
        }
    }

    function openRunHistoryModal() {
        const existing = document.getElementById('runHistoryModal');
        if (existing) existing.remove();
        const modal = document.createElement('div');
        modal.id = 'runHistoryModal';
        modal.className = 'modal-overlay active';
        modal.innerHTML = `
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Run History</h3>
                <button class="modal-close" onclick="closeRunHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="runHistoryList" class="space-y-2 text-sm text-gray-700">Loading...</div>
            </div>
            <div class="modal-footer">
                <button onclick="closeRunHistoryModal()" class="px-3 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
        loadRunHistory();
    }

    function closeRunHistoryModal() {
        const modal = document.getElementById('runHistoryModal');
        if (modal) modal.remove();
    }

    async function loadRunHistory() {
        const box = document.getElementById('runHistoryList');
        if (!box) return;
        if (!workflowBuilder.currentWorkflowId) {
            box.innerHTML = '<div class="text-gray-500">No workflow selected</div>';
            return;
        }
        try {
            let res = await fetch(`/api/workflow/runs/${workflowBuilder.currentWorkflowId}`);
            let data = await res.json();
            if (!(res.ok) && workflowBuilder.currentRunId) {
                res = await fetch(`/api/workflow/run/${workflowBuilder.currentRunId}`);
                data = await res.json();
                if (res.ok && data && data.run) {
                    data = { runs: [data.run] };
                }
            }
            const runs = Array.isArray(data) ? data : (data.runs || []);
            if (!runs.length) {
                box.innerHTML = '<div class="text-gray-500">No runs found</div>';
                return;
            }
            box.innerHTML = runs.map(r => `
                <div class="flex items-center justify-between p-2 border border-gray-200 rounded">
                    <div>
                        <div class="font-medium">${r.status || 'unknown'}</div>
                        <div class="text-xs text-gray-500">${r.started_at || ''} → ${r.finished_at || ''}</div>
                    </div>
                    <div class="text-xs text-gray-600">${r.duration || ''}</div>
                </div>
            `).join('');
        } catch (e) {
            box.innerHTML = '<div class="text-red-600">Failed to load history</div>';
        }
    }

    // Expose editor open as global for onclick
    function openZoneThresholdsEditor(targetTimeframe = null) {
        if (workflowBuilder && typeof workflowBuilder.openZoneThresholdsEditor === 'function') {
            workflowBuilder.openZoneThresholdsEditor(targetTimeframe);
        }
    }

    function closeSaveModal() {
        document.getElementById('saveModal').classList.remove('active');
    }

    function openLoadModal() {
        const modal = document.getElementById('loadModal');
        modal.classList.add('active');
        loadWorkflowList();
    }

    function createNewWorkflow() {
        // Clear current workflow without confirmation dialog
        try {
            if (workflowBuilder.nodes) {
                workflowBuilder.nodes.clear();
            }
            workflowBuilder.connections = [];
            if (workflowBuilder.nodeProperties) {
                workflowBuilder.nodeProperties.clear();
            }
            // Clear canvas with proper cleanup
            if (workflowBuilder.canvas) {
                // Remove all child elements to clean up event listeners
                while (workflowBuilder.canvas.firstChild) {
                    workflowBuilder.canvas.removeChild(workflowBuilder.canvas.firstChild);
                }
            }

            // Reset state
            workflowBuilder.currentWorkflowId = null;
            workflowBuilder.currentRunId = null;
            workflowBuilder.currentRunStatus = 'idle';
            workflowBuilder.currentWorkflowMeta = null;
            workflowBuilder.selectedNode = null;

            // Stop status polling
            workflowBuilder.stopStatusPolling();

            workflowBuilder.updateStatus();
            workflowBuilder.updateControlButtonsState();
            workflowBuilder.updateSaveUIState();

            // Reset workflow status
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            if (statusText) statusText.textContent = 'New Workflow';
            if (statusDot) statusDot.style.background = '#eab308'; // yellow-500

            // Show notification
            workflowBuilder.showNotification('New workflow created. Start adding nodes to build your strategy.', 'success');
        } catch (error) {
            console.error('Error creating new workflow:', error);
            workflowBuilder.showNotification(`Error creating new workflow: ${error.message}`, 'error');
        }
    }

    function closeLoadModal() {
        document.getElementById('loadModal').classList.remove('active');
        // Clear selection
        document.querySelectorAll('.workflow-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.getElementById('loadWorkflowBtn').disabled = true;
    }

    async function loadWorkflowList() {
        try {
            const response = await fetch('/api/workflow/list');
            const result = await response.json();

            const workflowList = document.getElementById('workflowList');
            const noWorkflows = document.getElementById('noWorkflows');

            if (result.success && result.workflows.length > 0) {
                workflowList.innerHTML = '';
                result.workflows.forEach(workflow => {
                    const workflowItem = document.createElement('div');
                    workflowItem.className = 'workflow-item';
                    workflowItem.dataset.workflowId = workflow.id;

                    const createdDate = new Date(workflow.created_at).toLocaleDateString();

                    workflowItem.innerHTML = `
                        <div class="workflow-name">${workflow.name}</div>
                        <div class="workflow-description">${workflow.description || 'No description'}</div>
                        <div class="workflow-meta">
                            <div class="workflow-stats">
                                <div class="workflow-stat">
                                    <i class="fas fa-calendar"></i>
                                    <span>${createdDate}</span>
                                </div>
                                <div class="workflow-stat">
                                    <i class="fas fa-circle text-green-500"></i>
                                    <span>${workflow.status}</span>
                                </div>
                            </div>
                        </div>
                    `;

                    workflowItem.addEventListener('click', () => {
                        // Remove previous selection
                        document.querySelectorAll('.workflow-item').forEach(item => {
                            item.classList.remove('selected');
                        });

                        // Select current item
                        workflowItem.classList.add('selected');
                        document.getElementById('loadWorkflowBtn').disabled = false;
                    });

                    workflowList.appendChild(workflowItem);
                });

                noWorkflows.classList.add('hidden');
            } else {
                workflowList.innerHTML = '';
                noWorkflows.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error loading workflow list:', error);
            alert('Error loading workflow list. Check console for details.');
        }
    }

    async function saveWorkflowFromModal() {
        const name = document.getElementById('workflowName').value.trim();
        const description = document.getElementById('workflowDescription').value.trim();

        if (!name) {
            workflowBuilder.showNotification('Please enter a workflow name', 'warning');
            return;
        }

        try {
            const nodes = Array.from(workflowBuilder.nodes.values());
            const connections = workflowBuilder.connections || [];
            const properties = Object.fromEntries(workflowBuilder.nodeProperties || new Map());

            const workflow = {
                name: name,
                description: description || 'Trading workflow created with Simple Workflow Builder',
                nodes: nodes,
                connections: connections,
                properties: properties,
                metadata: {
                    created: new Date().toISOString(),
                    version: '1.0.0',
                    builder: 'Simple Workflow Builder'
                }
            };

            // Check if updating existing workflow
            const isUpdate = workflowBuilder.currentWorkflowId;
            const url = isUpdate ? `/api/workflow/update/${workflowBuilder.currentWorkflowId}` : '/api/workflow/save';
            const method = isUpdate ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(workflow)
            });

            const result = await response.json();

            if (result.success) {
                const action = isUpdate ? 'updated' : 'saved';
                workflowBuilder.showNotification(`Workflow "${name}" ${action} successfully!`, 'success');
                // Persist current workflow id/meta after saving when backend returns it
                const returned = result.workflow || result.data || result;
                if (returned && (returned.id || returned.workflow_id)) {
                    workflowBuilder.currentWorkflowId = returned.id || returned.workflow_id;
                    // Save as last edited workflow
                    workflowBuilder.saveLastWorkflowId(returned.id || returned.workflow_id);
                }
                if (returned && (returned.name || returned.description)) {
                    workflowBuilder.currentWorkflowMeta = {
                        name: returned.name || name,
                        description: returned.description || description
                    };
                }
                if (workflowBuilder.updateSaveUIState) workflowBuilder.updateSaveUIState();
                closeSaveModal();
                console.log(`Workflow ${action}:`, result);
            } else {
                workflowBuilder.showNotification(`Error ${isUpdate ? 'updating' : 'saving'} workflow: ${result.error}`, 'error');
            }
        } catch (error) {
            console.error('Error saving workflow:', error);
            workflowBuilder.showNotification(`Error saving workflow: ${error.message}`, 'error');
        }
    }

    async function loadSelectedWorkflow() {
        const selectedItem = document.querySelector('.workflow-item.selected');
        if (!selectedItem) {
            workflowBuilder.showNotification('Please select a workflow to load', 'warning');
            return;
        }

        const workflowId = selectedItem.dataset.workflowId;

        try {
            const response = await fetch(`/api/workflow/load/${workflowId}`);
            const result = await response.json();

            if (result.success) {
                // Clear current workflow (defensive if instance exists)
                if (window.workflowBuilder && typeof workflowBuilder.clearWorkflow === 'function') {
                    workflowBuilder.clearWorkflow();
                }

                // Load workflow data
                const workflow = result.workflow;
                workflowBuilder.loadWorkflowData(workflow);

                // Set current workflow id/meta for future updates
                if (workflow && (workflow.id || workflowId)) {
                    workflowBuilder.currentWorkflowId = workflow.id || workflowId;
                    // Save as last edited workflow
                    workflowBuilder.saveLastWorkflowId(workflow.id || workflowId);
                }
                if (workflow && (workflow.name || workflow.description)) {
                    workflowBuilder.currentWorkflowMeta = {
                        name: workflow.name || '',
                        description: workflow.description || ''
                    };
                }

                if (typeof closeLoadModal === 'function') closeLoadModal();
            } else {
                if (window.workflowBuilder && typeof workflowBuilder.showNotification === 'function') {
                    workflowBuilder.showNotification(`Error loading workflow: ${result.error}`, 'error');
                } else {
                    alert(`Error loading workflow: ${result.error}`);
                }
            }
        } catch (error) {
            console.error('Error loading workflow:', error);
            if (window.workflowBuilder && typeof workflowBuilder.showNotification === 'function') {
                workflowBuilder.showNotification(`Error loading workflow: ${error.message}`, 'error');
            } else {
                alert(`Error loading workflow: ${error.message}`);
            }
        }
    }

    // Toggle menu function
    function toggleMenu() {
        const palette = document.querySelector('.compact-palette');
        const toggle = document.querySelector('.menu-toggle i');

        if (palette.classList.contains('hidden')) {
            palette.classList.remove('hidden');
            toggle.className = 'fas fa-bars text-gray-600';
        } else {
            palette.classList.add('hidden');
            toggle.className = 'fas fa-bars text-gray-400';
        }
    }

    // Zoom and Pan functions
    function zoomIn() {
        if (workflowBuilder) {
            workflowBuilder.zoomIn();
        }
    }

    function zoomOut() {
        if (workflowBuilder) {
            workflowBuilder.zoomOut();
        }
    }

    function resetZoom() {
        if (workflowBuilder) {
            workflowBuilder.resetZoom();
        }
    }

    function togglePan() {
        if (workflowBuilder) {
            workflowBuilder.togglePan();
        }
    }

    // Advanced Features
    function undo() {
        if (workflowBuilder) {
            workflowBuilder.undo();
        }
    }

    function redo() {
        if (workflowBuilder) {
            workflowBuilder.redo();
        }
    }

    function copySelected() {
        if (workflowBuilder) {
            workflowBuilder.copySelected();
        }
    }

    function paste() {
        if (workflowBuilder) {
            workflowBuilder.paste();
        }
    }

    function validateWorkflow() {
        if (workflowBuilder) {
            workflowBuilder.validateWorkflow();
        }
    }

    // Node Configuration Modal Functions
    function closeNodeConfigModal() {
        const modal = document.getElementById('nodeConfigModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
    }

    function saveNodeConfiguration(nodeId) {
        console.log('Global saveNodeConfiguration called with nodeId:', nodeId);
        if (workflowBuilder) {
            console.log('workflowBuilder found, calling saveNodeConfiguration');
            workflowBuilder.saveNodeConfiguration(nodeId);
        } else {
            console.error('workflowBuilder not found!');
        }
    }

    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            // Only close save/load modals, not zone thresholds modal
            if (e.target.id === 'saveModal') {
                closeSaveModal();
            } else if (e.target.id === 'loadModal') {
                closeLoadModal();
            }
            // Don't handle zoneThresholdsModal here - it has its own handler
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeSaveModal();
            closeLoadModal();
        }
    });

    // Flexible Multi-Indicator Configuration Form
    function createFlexibleMultiIndicatorConfigurationForm(node, properties) {
        const symbols = properties.symbols || [];
        const symbolConfigs = properties.symbolConfigs || {};
        const availableIndicators = properties.availableIndicators || {};
        const aggregation = properties.aggregation || {};

        // Build symbols table HTML
        const symbolsTableHTML = symbols.map(symbol => {
            const config = symbolConfigs[symbol] || { indicators: [] };
            const indicatorCheckboxes = Object.keys(availableIndicators).map(indicatorType => {
                const indicator = availableIndicators[indicatorType];
                const isChecked = config.indicators.some(ind => ind.type === indicatorType);
                const weight = config.indicators.find(ind => ind.type === indicatorType)?.weight || indicator.weight;

                return `
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" class="indicator-checkbox" data-indicator="${indicatorType}" ${isChecked ? 'checked' : ''}>
                        <span class="text-xs">${indicator.name}</span>
                        <input type="number" value="${weight}" step="0.05" min="0" max="1" 
                               class="w-16 px-1 py-0.5 text-xs border rounded" data-field="weight_${indicatorType}">
                    </div>
                `;
            }).join('');

            return `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${symbol}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="symbol" readonly>
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <div class="space-y-1">
                            ${indicatorCheckboxes}
                        </div>
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-center">
                        <button type="button" onclick="this.closest('tr').remove()" class="px-1 py-0.5 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        return `
            <div class="space-y-6">
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
                    <h4 class="font-semibold text-purple-800 mb-2 flex items-center">
                        <i class="fas fa-cogs mr-2"></i>
                        Flexible Multi-Indicator System
                    </h4>
                    <p class="text-sm text-purple-700">
                        Dynamic configuration for multiple symbols with flexible indicator selection
                    </p>
                </div>
                
                <!-- Symbol Configuration -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h5 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-coins mr-2"></i>
                        Symbol Configuration
                    </h5>
                    
                    <div class="mb-3">
                        <button type="button" onclick="addFlexibleSymbol()" class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 mr-2">
                            <i class="fas fa-plus mr-1"></i>Add Symbol
                        </button>
                        <button type="button" onclick="loadFlexibleSymbols()" class="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700">
                            <i class="fas fa-download mr-1"></i>Load 25 Symbols
                        </button>
                    </div>
                    
                    <!-- Symbols Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs border-collapse border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 px-2 py-1 text-left">Symbol</th>
                                    <th class="border border-gray-300 px-2 py-1 text-left">Indicators</th>
                                    <th class="border border-gray-300 px-2 py-1 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="flexibleSymbolsTableBody">
                                ${symbolsTableHTML}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Aggregation Configuration -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h5 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-puzzle-piece mr-2"></i>
                        Aggregation Settings
                    </h5>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Method</label>
                            <select id="flexibleAggregationMethod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="weighted_average" ${aggregation.method === 'weighted_average' ? 'selected' : ''}>Weighted Average</option>
                                <option value="majority_vote" ${aggregation.method === 'majority_vote' ? 'selected' : ''}>Majority Vote</option>
                                <option value="consensus" ${aggregation.method === 'consensus' ? 'selected' : ''}>Consensus</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Min Indicators</label>
                            <input type="number" id="flexibleMinIndicators" value="${aggregation.minIndicators || 3}" min="3" max="10"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Consensus Threshold</label>
                            <input type="number" id="flexibleConsensusThreshold" value="${aggregation.consensusThreshold || 0.7}" step="0.1" min="0.5" max="1.0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Confidence Threshold</label>
                            <input type="number" id="flexibleConfidenceThreshold" value="${aggregation.confidenceThreshold || 0.6}" step="0.1" min="0.3" max="1.0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Available Indicators Info -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h5 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        Available Indicators
                    </h5>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        ${Object.entries(availableIndicators).map(([type, indicator]) => `
                            <div class="flex items-center space-x-2">
                                <i class="${indicator.icon} text-gray-600"></i>
                                <span class="font-medium">${indicator.name}</span>
                                <span class="text-gray-500">(Weight: ${indicator.weight})</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    // Helper functions for Flexible Multi-Indicator
    function addFlexibleSymbol() {
        const container = document.getElementById('flexibleSymbolsTableBody');
        if (!container) return;

        const symbolRow = document.createElement('tr');
        symbolRow.className = 'hover:bg-gray-50';
        symbolRow.innerHTML = `
            <td class="border border-gray-300 px-2 py-1">
                <input type="text" placeholder="Enter symbol" class="w-full px-1 py-0.5 text-xs border rounded" data-field="symbol">
            </td>
            <td class="border border-gray-300 px-2 py-1">
                <div class="space-y-1">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" class="indicator-checkbox" data-indicator="macd_multi">
                        <span class="text-xs">MACD Multi-TF</span>
                        <input type="number" value="0.3" step="0.05" min="0" max="1" class="w-16 px-1 py-0.5 text-xs border rounded" data-field="weight_macd_multi">
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" class="indicator-checkbox" data-indicator="sma">
                        <span class="text-xs">SMA</span>
                        <input type="number" value="0.25" step="0.05" min="0" max="1" class="w-16 px-1 py-0.5 text-xs border rounded" data-field="weight_sma">
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" class="indicator-checkbox" data-indicator="rsi">
                        <span class="text-xs">RSI</span>
                        <input type="number" value="0.2" step="0.05" min="0" max="1" class="w-16 px-1 py-0.5 text-xs border rounded" data-field="weight_rsi">
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" class="indicator-checkbox" data-indicator="bollinger">
                        <span class="text-xs">Bollinger Bands</span>
                        <input type="number" value="0.25" step="0.05" min="0" max="1" class="w-16 px-1 py-0.5 text-xs border rounded" data-field="weight_bollinger">
                    </div>
                </div>
            </td>
            <td class="border border-gray-300 px-2 py-1 text-center">
                <button type="button" onclick="this.closest('tr').remove()" class="px-1 py-0.5 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        container.appendChild(symbolRow);
    }

    function loadFlexibleSymbols() {
        const container = document.getElementById('flexibleSymbolsTableBody');
        if (!container) return;

        // Clear existing data
        container.innerHTML = '';

        // Default symbols
        const defaultSymbols = [
            'NVDA', 'MSFT', 'AAPL', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NFLX', 'AMD', 'INTC',
            'CRM', 'ADBE', 'ORCL', 'CSCO', 'IBM', 'QCOM', 'TXN', 'AVGO', 'AMAT', 'MU',
            'LRCX', 'KLAC', 'MCHP', 'SNPS', 'CDNS'
        ];

        defaultSymbols.forEach(symbol => {
            const symbolRow = document.createElement('tr');
            symbolRow.className = 'hover:bg-gray-50';
            symbolRow.innerHTML = `
                <td class="border border-gray-300 px-2 py-1">
                    <input type="text" value="${symbol}" class="w-full px-1 py-0.5 text-xs border rounded" data-field="symbol" readonly>
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <div class="space-y-1">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="indicator-checkbox" data-indicator="macd_multi" checked>
                            <span class="text-xs">MACD Multi-TF</span>
                            <input type="number" value="0.3" step="0.05" min="0" max="1" class="w-16 px-1 py-0.5 text-xs border rounded" data-field="weight_macd_multi">
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="indicator-checkbox" data-indicator="sma" checked>
                            <span class="text-xs">SMA</span>
                            <input type="number" value="0.25" step="0.05" min="0" max="1" class="w-16 px-1 py-0.5 text-xs border rounded" data-field="weight_sma">
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="indicator-checkbox" data-indicator="rsi" checked>
                            <span class="text-xs">RSI</span>
                            <input type="number" value="0.2" step="0.05" min="0" max="1" class="w-16 px-1 py-0.5 text-xs border rounded" data-field="weight_rsi">
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="indicator-checkbox" data-indicator="bollinger" checked>
                            <span class="text-xs">Bollinger Bands</span>
                            <input type="number" value="0.25" step="0.05" min="0" max="1" class="w-16 px-1 py-0.5 text-xs border rounded" data-field="weight_bollinger">
                        </div>
                    </div>
                </td>
                <td class="border border-gray-300 px-2 py-1 text-center">
                    <button type="button" onclick="this.closest('tr').remove()" class="px-1 py-0.5 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            container.appendChild(symbolRow);
        });

        if (window.workflowBuilder && window.workflowBuilder.showNotification) {
            window.workflowBuilder.showNotification('25 symbols loaded with default indicator configuration!', 'success');
        }
    }
</script>

<!-- Save Workflow Modal -->
<div id="saveModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Save Workflow</h3>
            <button class="modal-close" onclick="closeSaveModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Workflow Name</label>
                    <input type="text" id="workflowName" placeholder="Enter workflow name"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                    <textarea id="workflowDescription" placeholder="Enter workflow description" rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-sm text-gray-600">
                        <div class="flex justify-between mb-1">
                            <span>Nodes:</span>
                            <span id="saveNodeCount">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Connections:</span>
                            <span id="saveConnectionCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeSaveModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
            <button onclick="saveWorkflowFromModal()"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Save Workflow
            </button>
        </div>
    </div>
</div>

<!-- Load Workflow Modal -->
<div id="loadModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Load Workflow</h3>
            <button class="modal-close" onclick="closeLoadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="workflowList" class="workflow-list">
                <!-- Workflows will be loaded here -->
            </div>
            <div id="noWorkflows" class="text-center py-8 text-gray-500 hidden">
                <i class="fas fa-folder-open text-4xl mb-4"></i>
                <p>No workflows found</p>
                <p class="text-sm">Create and save a workflow first</p>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeLoadModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
            <button id="loadWorkflowBtn" onclick="loadSelectedWorkflow()"
                class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                Load Workflow
            </button>
        </div>
    </div>
</div>
{% endblock %}