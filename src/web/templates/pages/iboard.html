{% extends "layouts/base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white">
    <!-- Compact Header -->
    <div class="bg-gray-800 border-b border-gray-600 px-4 py-2">
        <div class="flex justify-between items-center">
            <h1 class="text-xs font-medium text-green-400">üìä IBoard</h1>

            <div class="flex items-center space-x-3">
                <!-- Market Status -->
                <div class="flex items-center space-x-1">
                    <div id="statusIndicator" class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span id="statusText" class="text-xs">ƒêang ki·ªÉm tra...</span>
                </div>

                <!-- Controls -->
                <div class="flex items-center space-x-2">
                    <button id="refreshBtn" onclick="refreshData()"
                        class="bg-gray-600 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs transition-colors">
                        üîÑ
                    </button>

                    <div class="flex items-center space-x-1">
                        <input type="checkbox" id="autoRefresh" class="accent-green-500 w-3 h-3" disabled>
                        <label for="autoRefresh" class="text-xs text-gray-500">Disabled</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-xs text-gray-400 mt-1">
            C·∫≠p nh·∫≠t: <span id="lastUpdateTime">--</span>
        </div>
    </div>


    <!-- Loading Message -->
    <div id="loadingMessage" class="text-center py-12">
        <div class="inline-block w-6 h-6 border-2 border-gray-600 border-t-green-500 rounded-full animate-spin"></div>
        <p class="mt-2 text-gray-400">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden bg-red-900 border border-red-500 rounded-lg m-4 p-4 text-center">
        <p class="text-red-300">‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</p>
    </div>

    <!-- IBoard Table -->
    <div class="p-2">
        <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg">
            <table id="iboardTable" class="w-full">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">M√£ CK
                        </th>
                        <th class="px-2 py-1 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Gi√°
                            hi·ªán t·∫°i</th>
                        <th class="px-2 py-1 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Thay
                            ƒë·ªïi</th>
                        <th class="px-2 py-1 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">%
                            Thay ƒë·ªïi</th>
                        <th class="px-2 py-1 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Kh·ªëi
                            l∆∞·ª£ng</th>
                        <th class="px-2 py-1 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Gi√°
                            cao nh·∫•t</th>
                        <th class="px-2 py-1 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Gi√°
                            th·∫•p nh·∫•t</th>
                        <th class="px-2 py-1 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">C·∫≠p
                            nh·∫≠t</th>
                    </tr>
                </thead>
                <tbody id="iboardBody" class="bg-gray-800 divide-y divide-gray-700">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let autoRefreshInterval;
    let isMarketOpen = false;
    let lastData = {};

    // Kh·ªüi t·∫°o
    document.addEventListener('DOMContentLoaded', function () {
        checkMarketStatus();
        loadInitialData();
        setupAutoRefresh();
    });

    // T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu
    async function loadInitialData() {
        // Ki·ªÉm tra localStorage tr∆∞·ªõc
        const cachedData = getCachedData();
        if (cachedData) {
            updateIboard(cachedData);
            document.getElementById('loadingMessage').classList.add('hidden');
        }

        // Lu√¥n t·∫£i d·ªØ li·ªáu m·ªõi t·ª´ API
        try {
            const response = await fetch('/api/iboard/data');
            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();
            updateIboard(data);
            saveToCache(data);
            updateLastUpdateTime();
            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('errorMessage').classList.remove('hidden');
        }
    }

    // C·∫≠p nh·∫≠t b·∫£ng IBoard
    function updateIboard(data) {
        const tbody = document.getElementById('iboardBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        data.stocks.forEach(stock => {
            const row = document.createElement('tr');
            row.setAttribute('data-symbol', stock.symbol);

            const priceClass = stock.change > 0 ? 'text-green-400' :
                stock.change < 0 ? 'text-red-400' : 'text-white';
            const changeClass = stock.change > 0 ? 'text-green-400' :
                stock.change < 0 ? 'text-red-400' : 'text-white';

            row.innerHTML = `
                <td class="px-2 py-1 text-xs font-bold">
                    <a href="/chartv2?symbol=${stock.symbol}" class="text-green-400 hover:text-green-300 underline">
                        ${stock.symbol}
                    </a>
                </td>
                <td class="px-2 py-1 text-xs text-right price ${priceClass}">${formatPrice(stock.price)}</td>
                <td class="px-2 py-1 text-xs text-right change ${changeClass}">${formatChange(stock.change)}</td>
                <td class="px-2 py-1 text-xs text-right change ${changeClass}">${formatPercentChange(stock.percentChange)}</td>
                <td class="px-2 py-1 text-xs text-right volume text-white">${formatVolume(stock.volume)}</td>
                <td class="px-2 py-1 text-xs text-right high text-white">${formatPrice(stock.high)}</td>
                <td class="px-2 py-1 text-xs text-right low text-white">${formatPrice(stock.low)}</td>
                <td class="px-2 py-1 text-xs text-right last-update text-gray-400">${stock.lastUpdate || 'N/A'}</td>
            `;

            tbody.appendChild(row);
        });
    }

    // Ki·ªÉm tra tr·∫°ng th√°i th·ªã tr∆∞·ªùng
    function checkMarketStatus() {
        const now = new Date();
        const vietnamTime = new Date(now.getTime() + (7 * 60 * 60 * 1000)); // GMT+7
        const hour = vietnamTime.getHours();
        const minute = vietnamTime.getMinutes();
        const time = hour * 60 + minute;

        // Th·ªã tr∆∞·ªùng m·ªü: 9:00-11:30 v√† 13:00-15:00 (GMT+7)
        const morningStart = 9 * 60; // 9:00
        const morningEnd = 11 * 60 + 30; // 11:30
        const afternoonStart = 13 * 60; // 13:00
        const afternoonEnd = 15 * 60; // 15:00

        isMarketOpen = (time >= morningStart && time <= morningEnd) ||
            (time >= afternoonStart && time <= afternoonEnd);

        updateMarketStatus();
    }

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i th·ªã tr∆∞·ªùng
    function updateMarketStatus() {
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const iboardTable = document.getElementById('iboardTable');

        if (isMarketOpen) {
            statusIndicator.className = 'w-2 h-2 rounded-full bg-green-500';
            statusText.textContent = 'M·ªü';
            iboardTable.classList.remove('hidden');
        } else {
            statusIndicator.className = 'w-2 h-2 rounded-full bg-red-500';
            statusText.textContent = 'ƒê√≥ng';
            iboardTable.classList.remove('hidden');
        }
    }

    // Removed duplicate loadInitialData function

    // L√†m m·ªõi d·ªØ li·ªáu
    async function refreshData() {
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.disabled = true;
        refreshBtn.textContent = '‚è≥';

        try {
            const response = await fetch('/api/iboard/data');
            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();
            updateIboard(data);
            saveToCache(data);
            updateLastUpdateTime();
        } catch (error) {
            console.error('Error refreshing data:', error);
        } finally {
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'üîÑ';
        }
    }

    // localStorage functions
    function saveToCache(data) {
        try {
            localStorage.setItem('iboard_data', JSON.stringify({
                data: data,
                timestamp: Date.now()
            }));
        } catch (error) {
            console.error('Error saving to cache:', error);
        }
    }

    function getCachedData() {
        try {
            const cached = localStorage.getItem('iboard_data');
            if (cached) {
                const parsed = JSON.parse(cached);
                // Cache valid for 5 minutes (300000 ms) v√¨ d·ªØ li·ªáu t·ª´ database c√≥ th·ªÉ c·∫≠p nh·∫≠t th∆∞·ªùng xuy√™n h∆°n
                if (Date.now() - parsed.timestamp < 300000) {
                    return parsed.data;
                }
            }
        } catch (error) {
            console.error('Error reading cache:', error);
        }
        return null;
    }

    // Removed duplicate updateIboard function

    // C·∫≠p nh·∫≠t th·ªùi gian c·∫≠p nh·∫≠t
    function updateLastUpdateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('vi-VN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('lastUpdateTime').textContent = timeString;
    }

    // Thi·∫øt l·∫≠p t·ª± ƒë·ªông l√†m m·ªõi
    function setupAutoRefresh() {
        const autoRefreshCheckbox = document.getElementById('autoRefresh');

        autoRefreshCheckbox.addEventListener('change', function () {
            if (this.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });

        if (autoRefreshCheckbox.checked) {
            startAutoRefresh();
        }
    }

    // B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông l√†m m·ªõi
    function startAutoRefresh() {
        stopAutoRefresh(); // D·ª´ng interval c≈© n·∫øu c√≥
        autoRefreshInterval = setInterval(() => {
            if (isMarketOpen) {
                // Khi th·ªã tr∆∞·ªùng m·ªü, ch·ªâ refresh n·∫øu cache h·∫øt h·∫°n
                const cachedData = getCachedData();
                if (!cachedData) {
                    refreshData();
                } else {
                    updateIboard(cachedData);
                }
            } else {
                // Khi th·ªã tr∆∞·ªùng ƒë√≥ng, ch·ªâ hi·ªÉn th·ªã cache
                const cachedData = getCachedData();
                if (cachedData) {
                    updateIboard(cachedData);
                }
            }
        }, 10000); // C·∫≠p nh·∫≠t m·ªói 10 gi√¢y (ph√π h·ª£p v·ªõi d·ªØ li·ªáu database)
    }

    // D·ª´ng t·ª± ƒë·ªông l√†m m·ªõi
    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }


    // Format gi√°
    function formatPrice(price) {
        if (price === null || price === undefined) return '-';
        return new Intl.NumberFormat('vi-VN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
        }).format(price);
    }

    // Format thay ƒë·ªïi
    function formatChange(change) {
        if (change === null || change === undefined) return '-';
        const sign = change > 0 ? '+' : '';
        return sign + new Intl.NumberFormat('vi-VN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
        }).format(change);
    }

    // Format ph·∫ßn trƒÉm thay ƒë·ªïi
    function formatPercentChange(percent) {
        if (percent === null || percent === undefined) return '-';
        const sign = percent > 0 ? '+' : '';
        return sign + percent.toFixed(2) + '%';
    }

    // Format kh·ªëi l∆∞·ª£ng
    function formatVolume(volume) {
        if (volume === null || volume === undefined) return '-';
        if (volume >= 1000000) {
            return (volume / 1000000).toFixed(1) + 'M';
        } else if (volume >= 1000) {
            return (volume / 1000).toFixed(1) + 'K';
        }
        return volume.toString();
    }

    // Ki·ªÉm tra tr·∫°ng th√°i th·ªã tr∆∞·ªùng m·ªói ph√∫t
    setInterval(checkMarketStatus, 60000);

    // VPS streaming completely disabled
    console.log('üì° IBoard VPS streaming disabled');
</script>
{% endblock %}